[
["index.html", "CASA0005 Geographic Information Systems and Science Welcome The world of GIS Getting started Self guided learning Interactive lectures More help Noticed a mistake? Assignment resources Reading list", " CASA0005 Geographic Information Systems and Science Andy MacLachlan and Adam Dennett 2019-10-21 Welcome Welcome to the CASA0005 Geographic Information Systems and Science online pratical handbook. This website is hosted on GitHub and holds all the practical instructions and data. Data used within the practicals is available online, however occasionally websites can undergo maintenance or be inaccessible due to political factors such as government shutdowns. If you need the practical data you can access it from my GitHub repository Practical data is divided into the relevant sessions (e.g. prac1_data), although sometimes i’ll refer to a dataset used within a previous week. The world of GIS Spatial analysis can yield fascinating insights into geographical relationships. However, at times it can be difficult to work with. You will get lots of error messages and have software crash. The academic staff are here to help you work through these practicals but we do not know everything. It’s a good idea to become familar with online sources of help, such as: Stack Exchange https://stackexchange.com/ RStudio community https://community.rstudio.com/ QGIS documemtation https://docs.qgis.org/3.4/en/docs/index.html R documentation https://www.rdocumentation.org/ ArcGIS help pages https://support.esri.com/en Want to see what you can do with spatial analysis…check out this ‘What’s Next’ video produced for the ESRI conference… Getting started One of the issues with GIS is that many of the files we will be working with are quite large. Fortunately in recent years UCL has seriously beefed up the storage available for students. You now get 100GB of free storage, which should be plenty for the work you will be doing this year! The Bartlett faculty has several gigabytes of storage space available on their central servers, so before we get started, we will connect to our N drive to carry out all of our practical work over the coming weeks. Self guided learning The lectures and practicals of this course only form a part of the learning process. You are expected to undertake wider reading and explore new methods and approaches. We have provided guidance on useful resources throughout the course to use as a starting point but you are encouraged to go beyond our recommedations and fully engage with applied GIS research, methods and visualisation techniques. If you find a practical particularly easy or straightforward then please move on to the next one. Practicals that look at analytical relationships also have extension activities for you to try. Interactive lectures During the lectures we will be using an interative polling and Q&amp;A application called vevox. It’s very simple to use, you can either: Download the app on iOS or Android: http://get.vevox.app Use the web app: https://vevox.app/ The meeting ID we will use is: 186-395-009 More help If you need specific assistance with this course please: Check the Moodle assessment tab for queries relating to assignments / deadlines. There is also an expected assignment timeline and frequently asked questions section within the assessment outline document. Speak to a member of the teaching team in the computer lab sessions Ask a question at the end of a lecture (time permitting) Ask a question on slack under the GIS channel— you should have recevied an invite email from Steve Gray otherwise use this link. The teaching team will monitor this — use the #gis channel for this course. Due to the size of the class we will only reply to messages on slack so all students can see the discussion. If you have a personal matter in relation to completing the course then please speak to or email Andy or Adam. If you are struggling to use R don’t worry…here is some advice from an interview with Hadley Wickham, chief scientist at RStudio It’s easy when you start out programming to get really frustrated and think, “Oh it’s me, I’m really stupid,” or, “I’m not made out to program.” But, that is absolutely not the case. Everyone gets frustrated. I still get frustrated occasionally when writing R code. It’s just a natural part of programming. So, it happens to everyone and gets less and less over time. Don’t blame yourself. Just take a break, do something fun, and then come back and try again later. You can also go through other free resources including: Free RStudio Education resources Codeacademy YaRrr! The Pirate’s Guide to R At the end of every practical there is a link anonymous Google feeback form, let us know if something is unclear and we will go over it in a future session. If after pursuing all these avenues you still need help you can book into our office hours. These meetings are to discuss a geographical concept in relation to the material/assessment or for any personal matters relevant to the completion of the module. These meetings are not to be used for specific technical issues. Problems of this nature should be addressed in the practical sessions. Andy: https://amaclachlan.youcanbook.me/ Adam: https://dr-d-casa.youcanbook.me Noticed a mistake? No one is perfect, if you notice a mistake let us know through the GitHub issues tab Don’t worry if you are unsure about what GitHub is we cover it in the course. Assignment resources Want some tips for resources on your assignment?…. head over to the Assignment resources pages Reading list We link to books and resources throughout each practical and in the Assignment resources pages, but a full reading list for the course is provided here, there is also a link to it over on Moodle. We’ve tried to mostly recommend open source and free books, any others are available from the library. "],
["geographic-information.html", "Chapter 1 Geographic Information 1.1 Learning outcomes 1.2 Recommended listening 1.3 The Basics of Geographic Information 1.4 Data 1.5 Data sources and task 1.6 Summary 1.7 Feedback 1.8 Mac R issues", " Chapter 1 Geographic Information 1.1 Learning outcomes By the end of this practical you should be able to: Describe and explain GIS data formats and databases Source and pre-process spatial data Load and undertaken some basic manipulation of spatial data in: ArcMap, QGIS and R Evaluate the (dis)advantages of each GIS you have used 1.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy Adam… This week, wrap your ears around this piece of liquid gold from Japan’s finest, Makoto. 1.3 The Basics of Geographic Information Geographic data, geospatial data or geographic information is data that identifies the location of features on Earth. There are two main types of data which are used in GIS applications to represent the real world. Vectors that are composed of points, lines and polygons and rasters that are grids of cells with individual values… In the above example the features in the real world (e.g. lake, forest, marsh and grassland) have been represented by points, lines and polygons (vector) or discrete grid cells (raster) of a certain size (e.g. 1 x 1m) specifying land cover type. 1.3.1 Important GIS data formats There are a number of commonly used geographic data formats that store vector and raster data that you will come across during this course and it’s important to understand what they are, how they represent data and how you can use them. 1.3.1.1 Shapefiles Perhaps the most commonly used GIS data format is the shapefile. Shapefiles were developed by ESRI, one of the first and now certainly the largest commercial GIS company in the world. Despite being developed by a commercial company, they are mostly an open format and can be used (read and written) by a host of GIS Software applications. A shapefile is actually a collection of files –– at least three of which are needed for the shapefile to be displayed by GIS software. They are: .shp - the file which contains the feature geometry .shx - an index file which stores the position of the feature IDs in the .shp file .dbf - the file that stores all of the attribute information associated with the coordinates – this might be the name of the shape or some other information associated with the feature .prj - the file which contains all of the coordinate system information (the location of the shape on Earth’s surface). Data can be displayed without a projection, but the .prj file allows software to display the data correctly where data with different projections might be being used On Twitter and want to see the love for shapefiles….have a look at the shapefile account 1.3.1.2 GeoJSON GeoJSON Geospatial Data Interchange format for JavaScript Object Notation is becoming an increasingly popular spatial data format, particularly for web-based mapping as it is based on JavaScript Object Notation. Unlike a shapefile in a GeoJSON, the attributes, boundaries and projection information are all contained in the same file. 1.3.1.3 Shapefile and GeoJSON We’re now going to explore a shapefile (.shp ) and GeoJSON (.geojson) in action. Go to: http://geojson.io/#map=16/51.5247/-0.1339 Using the drawing tools to the right of the map window, create 3 objects: a point, line and a polygon as I have done above. Click on your polygon and colour it red and colour your point green Using the ‘Save’ option at the top of the map, save two copies of your new data – one in .geojson format and one in .shp format Open your two newly saved files in a text editor such as notepad or notepad++. For the shapefile you might have to unzip the folder then open each file individually. What do you notice about the similarities or differences between the two ways that the data are encoded? 1.3.1.4 Raster data Most raster data is now provided in GeoTIFF (.tiff) format, which stands for Geostarionary Earth Orbit Tagged Image File. The GeoTIFF data format was created by NASA and is a standard public domain format. All necesary information to establish the location of the data on Earth’s surface is embedded into the image. This includes: map projection, coordinate system, ellipsoid and datum type. 1.3.1.5 Other data formats Aforementioned data types and formats are likely to be the ones you predominately encounter. However there are several more used within spatial analysis. These include: Vector GML (Geography Markup Language –– gave birth to Keyhold Markup Language (KML)) Raster Band SeQuential (BSQ) - technically a method for encoding data but commonly referred to as BSQ. Hierarchical Data Format (HDF) Arc Grid There are normally valid reasons for storing data in one of these other formats. For example, BSQ are raster data with a separate text header file (.hdr) providing geographic spatial reference information. Earth observation data often monitors the electromagnetic spectrum in bands. Humans see in the visible range of the spectrum and our vision is composed of red, green and blue wavelengths. If we wanted to analyse just the red wavelength the BSQ format would let us read in only that data. In comparison a GeoTIFF might come with all the data ‘packaged’ in one file and when doing analysis over thousands of images would significantly slow things down. That said you can now often find GeoTIFFs separated in a similar format to BSQ and it’s fairly straightforward to convert between raster formats. 1.3.1.6 Geodatabase A geodatabase is a collection of geographic data held within a database. Geodatabases were developed by ESRI to overcome some of the limitations of shapefiles. They come in two main types: Personal (up to 1 TB) and File (limited to 250 - 500 MB), with Personal Geodatabases storing everything in a Microsoft Access database (.mdb) file and File Geodatabases offering more flexibility, storing everything as a series of folders in a file system. In the example below we can see that the FCC_Geodatabase (left hand pane) holds multiple points, lines, polygons, tables and raster layers in the contents tab. 1.3.1.7 GeoPackage A GeoPackage is an open, standards-based, platform-independent, portable, self-describing, compact format for transferring geospatial data. It stores spatial data layers (vector and raster) as a single file, and is based upon an SQLite database, a widely used relational database management system, permitting code based, reproducible and transparent workflows. As it stores data in a single file it is very easy to share, copy or move. 1.3.1.8 SpatiaLite SpatialLite is an open-source library that extends SQLite core. Support is fairly limited and most software that supports SpatiaLite also supports GeoPackage, as they both build upon SQLite. It doesn’t have any clear advantage over GeoPackage, however it is unable to support raster data. 1.3.1.9 PostGIS PostGIS is an opensource database extender for PostrgeSQL. Essentially PostgreSQL is a database and PostGIS is an add on which permits spatial functions. The advantages of using PostGIS over a GeoPackage are that it allows users to access the data at the same time, can handle large data more efficiently and reduces processing time. In this example calculating the number of bars per neighbourhood in Leon, Mexico the processing time reduced from 1.443 seconds (SQLite) to 0.08 seconds in PostGIS. However, data stored in PostGIS is much harder to share, move or copy. 1.3.1.10 What will I use The variety of data formats can see a bit overwhelming. But don’t worry, most of the time you’ll be using shapefiles, GeoPackages or raster data. 1.4 Data The volume of geographic information which is freely available for use in the UK is increasing exponentially and spatially referenced data can often be found in many different places. In this practical we’re going to use data from the London data store — a free and open data-sharing portal provided by the Greater London Authority (GLA), also known as City Hall that is the devolved regional governance body of London. We are going to get spatial data of the London boroughs and join flytipping (the illegal deposit of waste, commonly on road verges) data that is provided as a .csv file. .csv stands for comma-separated values (CSV) — it uses a comma to separate each value. At the end of this document I’ll also run through some common sources of data that will stand you in good stead (be advantageous) for the rest of the course. 1.4.1 File paths In your N drive: create a new folder called GIS and within this a sub folder called wk1. It is up to you how you organise your files. Make sure you change the file paths where appropriate to your own. 1.4.2 Data download Firstly we need to get a spatial outline of the London boroughs. The geographic boundaries that are used in the UK are a complex, often inter-related, but ever changing mass of areas. For anyone new to the UK (or indeed not a trained quantitative geographer), it can be quite a daunting task to attempt to understand all of the boundaries that are in use. Fortunately the Office for National Statistics (ONS) has an online beginners guide to UK geography. If you need more information on the vast array of different UK geographies, go and explore these resources: http://geoportal.statistics.gov.uk/datasets/a-beginners-guide-to-uk-geography-2018-v1-0 https://data.gov.uk/dataset/d7dd9437-20d0-448f-a61b-6e0939dcc642/hierarchical-representation-of-uk-statistical-geographies-december-2017 Let’s download some data.. Spatial Data To get the data go to: https://data.london.gov.uk/ Search for Statistical GIS Boundary Files for London Download the statistical-gis-boundaries-london.zip Unzip the data and save it to your wk1 folder. CSV data On the same website search for fly-tipping incidents Download the .csv file 1.4.3 Data pre-processing Question Open the .csv in Excel, what do you notice about how the data is stored? Answer The year is a column and for each area the values are repeated for different years. In our analysis it is easier to have the different years as a column and populated for each area. So, we want to go from this… To this… As we are going to use this dataset in ArcMap, QGIS and R I’ve done it in Excel using a pivot table. In future we’ll use R to automate tasks like this. Go to Insert &gt; PivotTable Select the original table and create a PivotTable in a new worksheet The PivotTable Field box will appear, experiment with the different fields in each of the areas I’ve used the following: Note how I’ve altered the total_action_taken to the sum of… as the original was displaying incorrectly, to do so: Click on drop down button for total_action_taken &gt; Value Field Settings &gt; select Sum It’s important to think about what data we actually need in the next step and it’s good practice to avoid data redundancy where possible. Spoiler The spatial data we have downloaded already contains borough name, so we don’t need it twice. However, we do need a field to link the two datasets on. You could use borough name, but when using text fields sometimes input variations can affect joins. For example, if you had the University of Manchester in one dataset and Manchester University in another the join would fail. Consequently it’s usually best to join datasets on a code field. Now save the Excel sheet that contains the pivot table as a new .csv. Make sure that the first row of data holds the column titles. Remove all empty rows. When saving the file also avoid any special characters (e.g. -) and spaces, use an underscore instead of spaces. Warning Spatial software (especially ArcGIS) does not like file names with spaces or special characters. 1.4.4 Data loading Now it’s time to load, inspect and do some basic manipulation of this data. As mentioned in the lecture there are several GIS software ‘types’, here we will repeat the same process across ArcGIS, QGIS and R. Each system has specific benefits, but in general there has been a recent shift towards the use of QGIS and R, both being opensource. ArcGIS was the first major spatial analysis software produced by the Environmental Systems Research Institute, Inc. (Esri), founded in 1969 by Jack Dangermond. Due to its high cost and lack of customisation it is now less commonly used within the research community. 1.4.5 ArcGIS 1.4.5.1 Basics ArcGIS should be installed as a standard programme in the UCL desktop and you can navigate to it from the Windows start button. 1.4.5.1.1 Installing ArcGIS on your own computer As a UCL student, you can install ArcGIS on your own computer. This is easy if you have a PC, but if you have a Mac this can be trickier as Arc will only run in a PC environment. If you have a Mac, the options open to you are either to: Run ArcGIS through the Desktop@UCL application — http://www.ucl.ac.uk/isd/services/computers/remote-access/desktop Duel boot your machine using bootcamp, install Windows (7 or 8 is fine) and then install Arc onto the Windows partition. Install some kind of virtualisation software such as Parallels or VMware, and run Arc on a virtual windows machine If you can, it is preferable to run Arc on Bootcamp as virtualisation software can be slow, but the Desktop@UCL facility should suffice for this course. ArcGIS (Version 10.6 is the latest at time of writing, but may have already been superseded) can be downloaded from the UCL Software Database for free Make sure you read the instructions provided by the UCL Software Database on how to activate ArcGIS fully if installing onto your own machine as you have to set the license correctly. 1.4.5.1.2 Getting Help ArcGIS is a huge and complex piece of software, but thankfully is has an excellent help system –– depending on the version you are using (they are all quite similar anyway) you can access the online help system here: http://resources.arcgis.com/en/help/main/10.2/ http://resources.arcgis.com/en/help/main/10.1/ 1.4.5.1.3 ArcGIS ArcGIS is actually a whole suite of software built and maintained by ESRI (http://www.esri.com/software/arcgis).Within the ArcGIS for Desktop suite you will find the following programmes: ArcCatalog — Similar to Windows Explorer, ArcCatalog allows you to manage your GIS files, folders and geodatabases ArcGIS Administrator — This programme us used to manage licences for the various elements of ArcGIS ArcGlobe — ArcGlobe allows you to view and analyse your data in 3D –– this interface looks very similar to Google Earth and is part of the 3D analyst extension ArcMap — This is the programme you will use most often –– it is the main mapping and spatial analysis element of ArcGIS ArcScene — ArcScene is a 3D viewer which allows you to navigate and interact with your 3D raster and feature data ArcCatalog and ArcMap are in bold as these are the only programmes we will be using explicitly in this course. By all means experiment with the others if you have any spare time! 1.4.5.2 ArcCatalog Find and run the ArcCatalog piece of software Once ArcCatalog Opens, go to File &gt; Connect To Folder… and navigate to the N:folder, right click in the contents area and create a new File Geodatabase - i’ve called mine prac1. You can import data layers into a Geodatabase within ArcCatalog, however we will do this in ArcMap. Close ArcCatalog and never have both ArcCatalog and another ArcGIS product open at the same time. 1.4.5.3 ArcMap 1.4.5.3.1 Introduction ArcMap is the core of the ArcGIS suite and where you would normally produce maps, carry out spatial analysis functions and automate processes. Search for and open ArcMap Upon opening select the database you just created in the default geodatabased fpor this map dialogue box Click ok When the map document opens you should see something similar to the image below, highlighting some of the key buttons (without the data): It’s important to now set the map document up properly. Go File &gt; Map Document Properties, enter the details you wish. You can see the connection to the Geodatabase we just made. Click store relative pathnames, this means as long as the data stays in the same position relative to the path then ArcMap can load all the layers. For example if you moved your work from the C: drive to an external drive, H:. 1.4.5.3.2 Load data Using the Plus icon (add data layer) navigate to the extracted folder you saved earlier. Open London_Borough_Excluding_MHW.shp, but feel free to explore the other data layers. In the left hand Table Of Contents you can unselect layers to turn them off or drag layers above or below to change the display order. In the example below the wards layer is showing above the borough layer. Note, while we have loaded the shapefile, it is not stored in our Geodatabase yet. Useful tips To the right of the document you will see the Catalog and Search tabs.The Catalog tab is a more compact version of ArcCatalog and will let you see what data is stored in the current Geodatabase — you can use this at the same time as ArcMap. The search tab will let you find any analysis tool within ArcGIS. Try searching for Clip. If you right click on the boroughs layer (in the Table of Contents, left hand pane) you will see various options. Zoom to layer is very useful if you ever get lost in your ArcMap document. Now right click on the borough layer (in the Table of Contents) and open the attribute table. You’ll see the GSS_CODE field, which is the same code we output in our .csv. If you now right click on a field you’ll also be able to see the data type (e.g. string, integer). For example: 1.4.5.3.3 Join data We’re now going to join our flytipping data to the London borough shapefile. So: Right click on the london borough layer &gt; Joins and Relates &gt; Join Select the GSS_CODE as the field in the layer to base the join on Navigate to the .csv we created earlier Select the code field that matches (in my case this is called Row Labels) Select only to join matching records Validate join and click OK You will get errors, ArcMap does not like fields starting with numbers (e.g. 2012), dashes (e.g. -) or spaces. Feel free to change them in the original .csv but for this practical it is fine to continue. The join should work, so reopen the attribute table for the layer London boroughs Note, the join we have made is not permanent. To do so we need to export the layer. 1.4.5.3.4 Export data Right click on the london boroughs layer &gt; Data &gt; Export Data The location should default to our GeoDatabase. Be sure to change the filename — again avoid all of the characters (e.g. spaces and -) previously mentioned. Add the new data layer to the map and remove the old one (Right Click (on the layer) &gt; Remove) Now lets use the data we’ve joined to create a basic thematic map. Right click on the new London borough layer &gt; Properties Under the Symbology tab select Graduated colors Select the Value as one of the years of data we joined and change the classificaiton to something of your choice You should have something that looks like this: We haven’t talked about the Coordiante Reference System (CRS) (or Spatial Reference System (SRS)) of our map document A coordinate reference system is a series of parameters that define the coordinate system. Within GIS we use geographic or projected coordinate systems. The former uses a three-dimensional spherical surface to define locations of Earth, whereas the latter is defined on a flat, two-dimensional surface giving it constant lengths, angles and areas. We cover this in more detail later on. In ArcMap we can specify what CRS we want to use by: Right clicking on the map document &gt; Data Frame Properties You’ll see that it is already set to Projected Coordinate Systems, National Grids, Europe, British National Grid. This is because ArcMap will default to the coordinate system of the first data layer loaded. Save and then close your ArcMap document. We’re now going to replicate this task in QGIS. Note As we are going to open the same files in difference GIS systems it is important to close the software before moving on. If you don’t then files can be locked and unreadable as they are still considered to be in use. 1.4.6 QGIS 1.4.6.1 Introduction QGIS is very similar to ArcMap except that as it is open-source and free there are many add on packages that (or plugins) that provide additional functionality to the software. To get QGIS on your personal machine go to: https://qgis.org/en/site/forusers/download.html I install the OSGeo4W version. The nature of open-source means that several programs will rely on each other for features. OSGeo4W tracks all the shared requirements and does not install any duplicates. 1.4.6.2 Load data Search for and open QGIS Click on the open data source manager. Just above the word browser in the top left of the screen Navigate to the London boroughs layer .shp and add it, you then have to close the data source manager Just like in ArcMap you can right click on the layer to view the attribute table. Unlike ArcMap you have to load the .csv file into QGIS in order to join it to a shapefile. Open the data source manager and select Delimited Text Navigate to our .csv file and provide a suitable layer name Under Record and Fields Options make sure the number of header lines to discard is 0 and the First record has field names box is selected (this is assuming you left a title for each column in your .csv) Under Geometry Definition select No geometry (attribute table only) Does the sample data seem right? If so, click add then close 1.4.6.3 Join data Right click on the London boroughs layer &gt; Properties &gt; Joins Click the plus button at the bottom of the box Complete the dialogue box 1.4.6.4 Export data Now instead of using a GeoDatabase, let’s export to a GeoPackage. Right click on the London boroughs layer &gt; Export &gt; Save Feature As Select the GeoPackage format and complete the File name (the saved file name for the GeoPackage) and the Layer name (the name for this layer within the GeoPackage). Recall that a GeoPackage can store many data layers as a single file The new layer will be added to the map, so you can remove the old one (Right click on the layer &gt; Remove Layer). Make sure you remove the right one! We’ve now made a GeoPackage that we can connect our map project to. Under Browser, Right click on GeoPackage &gt; New Connection &gt; Navigate to your GeoPackage Click the down arrow left to GeoPackage and you should see the one you just navigated to. Click the down arrow on the database and you can see your layer. Now we are going to import our .csv into our GeoPackage. To do so go: Database &gt; DB Manager Select your GeoPackage in the left hand pane Import layer/file then select the .csv. Click Ok. Again, remember that the .csv in the Layers tab (bottom left) is the original. Remove it, then from the GeoPackage just click, hold and drag the .csv into the layer pane. Now let’s make a quick thematic map like we did in ArcMap. Right click on your London boroughs layer &gt; Properties &gt; Symbology Select categorised and choose a data column and color ramp &gt; click Classify You could also select graduated, however our joined data fields are in the wrong data type. If you wish to change them follow this guide Save your QGIS project You should have produced something like this: Spatial reference QGIS is similar but different to ArcMap. QGIS defaults to the Coordinate Reference System (CRS) WGS 84, or known by its European Petroleum Survey Group (EPSG) code 4326. However, when you add your first layer in will default to that CRS. We’ll go into the background of EPSG next time. You can change the CRS by going File &gt; Properties and selecting CRS in the left hand pane. 1.4.7 R 1.4.7.1 Introduction R is both a programming language and software environment, originally designed for statistical computing and graphics. R’s great strength is that it is open-source, can be used on any computer operating system and free for anyone to use and contribute to. Because of this, it is rapidly becoming the statistical language of choice for many academics and has a huge user community with people constantly contributing new packages to carry out all manner of statistical, graphical and importantly for us, geographical tasks. The purpose of this practical is just to demonstrate data loading and manipulation in different software. The next practical will provide much more detail on R, so don’t worry. 1.4.7.2 Setup 1 Search for and open RStudio. You can install R Studio on your own machine from: https://www.rstudio.com/products/rstudio/download/#download R studio requires R which you can download from: https://cran.rstudio.com/ RStudio is a free and open-source integrated development environment for R — it makes R much easier to use. If you are using a Mac and run into issues, firstly follow the instructions below then check out the Mac R issues section if the problem persists. 1.4.7.3 Setup 2 If you RStudio insn’t installed on your practical room PC…fear not…the good people over at RStudio have created a cloud version…you have to sign up but can use it the same as the desktop version. It even works with Git and GitHub which we will cover later on in the course. The only real limitation is the upload file size — if you have any kind of ‘big data’ then you will reach the allowed limit. That won’t be a problem for the majority of this course except Advanced raster analysis…that said you can now link R to googledrive and access any data stored on it with the googledrive() function that is part of the tidyverse package. You could possibly do this one OneDrive too, but it’s not as intuitive, have a look here. But for now, don’t worry about this, just note it for future reference. RStudio cloud is really useful for sharing code and working collaboratively as you can add different users to the project. I’d recommend using RStudio locally (following Setup 1) to start with. If you are using RStudio cloud you’ll need to make a new workspace and upload the files we are using here with the upload button…. If you upload a shapefile you will need to incldue all the relevant files and upload them to RStudio cloud as a .zip In RStudio go: File &gt; New File &gt; R Script You should be able to see these quadrants (without the code): Below are bits of code, to start we will work using the console. So just copy the bits of code into the console window, changing the file names to where your data is stored. Then at the end of this section I’ll show you how to make a script. R works on packages that are collections of functions and data. For this practical we will need the ones listed in the code chunk below. Whilst we’ve installed them (with the code below), we haven’t yet loaded them. It’s best practice to do all this at the start of your code, however, for demonstration purposes I’ll load each one as we need it. install.packages(c(&quot;sf&quot;, &quot;tmap&quot;, &quot;tmaptools&quot;, &quot;RSQLite&quot;, &quot;tidyverse&quot;), repos = &quot;https://www.stats.bris.ac.uk/R/&quot;) Packages we’ve installed: sf: simple features, standard way to encode spatial vector data tmap: layer-based and easy approach to make thematic maps tmaptools: set of tools for reading and processing spatial data RSQLite: embeds the SQLite database engine in R Here, repos stands for repository where we will download the packages from. Once you have set it, you shouldn’t need to specify it again. Whilst we’ve installed the packages we haven’t loaded them…this is done through using library() function. If you are using a Mac you might also need rgdal… this is because a lot of packages are dependent on it and it might not properly install… install.packages(&quot;rgdal&quot;) Then load rgdal… library(rgdal) If you still have issues the check out the Mac R issues section 1.4.7.4 Load data Load the sf package so we can read our shapefile in — remember to change to filepath to your shapefile. For this first practical we’ll just leave the data where it is, next week we’ll show you how to use projects to make calling data much easier. Note by default in R, the file path should be defined with / but on a windows file system it is defined with \\. Using \\\\ instead allows R to read the path correctly – alternatively, just use / library(sf) # change this to your file path!!! shape &lt;- st_read(&quot;Prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) ## Reading layer `London_Borough_Excluding_MHW&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\Prac1_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs Note If you are working on RStudio cloud and have a shapefile (along with all the other relevant files required) you will just need to use… shape &lt;- st_read(&quot;London_Borough_Excluding_MHW.shp&quot;) As RStudio cloud knows you have setup a project and to look for files within it…we cover this very soon for RStudio desktop. To get a summary of the data held within the shapefile data (attribute table) enter the following: summary(shape) ## NAME GSS_CODE HECTARES ## Barking and Dagenham: 1 E09000001: 1 Min. : 314.9 ## Barnet : 1 E09000002: 1 1st Qu.: 2724.9 ## Bexley : 1 E09000003: 1 Median : 3857.8 ## Brent : 1 E09000004: 1 Mean : 4832.4 ## Bromley : 1 E09000005: 1 3rd Qu.: 5658.5 ## Camden : 1 E09000006: 1 Max. :15013.5 ## (Other) :27 (Other) :27 ## NONLD_AREA ONS_INNER SUB_2009 SUB_2006 geometry ## Min. : 0.00 F:19 NA&#39;s:33 NA&#39;s:33 MULTIPOLYGON :33 ## 1st Qu.: 0.00 T:14 epsg:NA : 0 ## Median : 2.30 +proj=tmer...: 0 ## Mean : 64.22 ## 3rd Qu.: 95.60 ## Max. :370.62 ## To have a quick look what the shapefile looks like enter the following: plot(shape) That plots everything in the shapefile (all the attitbues) if you just wanted the geometry (outline of the shape) you could use… plot(sf::st_geometry(shape)) From what we did in QGIS and ArcMap this should look familiar. We now need to load our .csv file: library(tidyverse) ## -- Attaching packages -------------- tidyverse 1.2.1 -- ## v ggplot2 3.2.1 v purrr 0.3.2 ## v tibble 2.1.3 v dplyr 0.8.3 ## v tidyr 1.0.0 v stringr 1.4.0 ## v readr 1.3.1 v forcats 0.4.0 ## -- Conflicts ----------------- tidyverse_conflicts() -- ## x dplyr::filter() masks stats::filter() ## x dplyr::lag() masks stats::lag() mycsv &lt;- read_csv(&quot;Prac1_data/fly_tipping_borough_edit.csv&quot;) ## Parsed with column specification: ## cols( ## `Row Labels` = col_character(), ## `2011_12` = col_double(), ## `2012_13` = col_double(), ## `2013_14` = col_double(), ## `2014_15` = col_double(), ## `2015_16` = col_double(), ## `2016_17` = col_double(), ## `2017_18` = col_double(), ## Grand_Total = col_double() ## ) When you load tidyverse you might get a list of conflicts, this basically means that several packages have functions named the same thing. For example there is a function named filter() in the packages dplyr and stats. If you wanted to use the dplyr version you would use dplyr::filter() or for the stats version it would be stats::filter()… To view the data just input: mycsv ## # A tibble: 34 x 9 ## `Row Labels` `2011_12` `2012_13` `2013_14` `2014_15` `2015_16` `2016_17` ## &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 E09000001 563 1492 433 347 587 1944 ## 2 E09000002 2687 2122 1399 3100 2672 1130 ## 3 E09000003 2356 1828 890 219 615 130 ## 4 E09000004 505 627 732 399 262 439 ## 5 E09000005 6713 2232 3189 3926 3980 4366 ## 6 E09000006 306 479 653 462 326 228 ## 7 E09000007 5541 5962 8281 4837 4719 4656 ## 8 E09000008 31 108 460 712 1707 637 ## 9 E09000009 6727 5679 6543 5521 6067 12688 ## 10 E09000010 7262 3595 3269 4937 5292 10894 ## # ... with 24 more rows, and 2 more variables: `2017_18` &lt;dbl&gt;, ## # Grand_Total &lt;dbl&gt; 1.4.7.5 Join data In R we’ve given our London boroughs shapefile the name shape and our flytipping .csv the name mycsv. If you look in the Environment quadrant you should see them both listed. Join the .csv to the shapefile. Here, replace Row Labels with whatever your GSS_CODE is called in the .csv: library(tmaptools) shape&lt;-merge(shape, mycsv, by.x=&quot;GSS_CODE&quot;, by.y=&quot;Row Labels&quot;) Let’s break this down a bit. We just created a tibble of mycsv (this is a new form of a dataframe) where each column has a variable and each row contains a set of values — so basically a normal table. The match simply found the GSS_CODE values in the .csv and joined the data to our shapefile. Check the merge was successful, this is just going to show the top 10 rows: head(shape, n=10) ## Simple feature collection with 10 features and 15 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 509702.4 ymin: 155850.8 xmax: 554089.2 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs ## GSS_CODE NAME HECTARES NONLD_AREA ONS_INNER SUB_2009 ## 1 E09000001 City of London 314.942 24.546 T &lt;NA&gt; ## 2 E09000002 Barking and Dagenham 3779.934 169.150 F &lt;NA&gt; ## 3 E09000003 Barnet 8674.837 0.000 F &lt;NA&gt; ## 4 E09000004 Bexley 6428.649 370.619 F &lt;NA&gt; ## 5 E09000005 Brent 4323.270 0.000 F &lt;NA&gt; ## 6 E09000006 Bromley 15013.487 0.000 F &lt;NA&gt; ## 7 E09000007 Camden 2178.932 0.000 T &lt;NA&gt; ## 8 E09000008 Croydon 8649.441 0.000 F &lt;NA&gt; ## 9 E09000009 Ealing 5554.428 0.000 F &lt;NA&gt; ## 10 E09000010 Enfield 8220.025 0.000 F &lt;NA&gt; ## SUB_2006 2011_12 2012_13 2013_14 2014_15 2015_16 2016_17 2017_18 ## 1 &lt;NA&gt; 563 1492 433 347 587 1944 2579 ## 2 &lt;NA&gt; 2687 2122 1399 3100 2672 1130 1066 ## 3 &lt;NA&gt; 2356 1828 890 219 615 130 503 ## 4 &lt;NA&gt; 505 627 732 399 262 439 327 ## 5 &lt;NA&gt; 6713 2232 3189 3926 3980 4366 7483 ## 6 &lt;NA&gt; 306 479 653 462 326 228 258 ## 7 &lt;NA&gt; 5541 5962 8281 4837 4719 4656 12671 ## 8 &lt;NA&gt; 31 108 460 712 1707 637 2684 ## 9 &lt;NA&gt; 6727 5679 6543 5521 6067 12688 5471 ## 10 &lt;NA&gt; 7262 3595 3269 4937 5292 10894 5855 ## Grand_Total geometry ## 1 7945 MULTIPOLYGON (((531145.1 18... ## 2 14176 MULTIPOLYGON (((543905.4 18... ## 3 6541 MULTIPOLYGON (((524579.9 19... ## 4 3291 MULTIPOLYGON (((547226.2 18... ## 5 31889 MULTIPOLYGON (((525201 1825... ## 6 2712 MULTIPOLYGON (((540373.6 15... ## 7 46667 MULTIPOLYGON (((528840.2 18... ## 8 6339 MULTIPOLYGON (((535009.2 15... ## 9 48696 MULTIPOLYGON (((510253.5 18... ## 10 41104 MULTIPOLYGON (((531023.5 20... Now, let’s make a quick thematic map (or a qtm) using the package tmap. I’ve made mine for flytipping between 2011 and 2012 (column 2011_12). But check what your coloumn name is from the adove code head(shape, n=10) it might be slightly different like 2011-2012 or x2011_2012…. library(tmap) tmap_mode(&quot;plot&quot;) ## tmap mode set to plotting # change the fill to your column name if different qtm(shape, fill = &quot;2011_12&quot;) 1.4.8 Export data Finally write shape to a new GeoPackage (.gpkg) giving it the layer name of your choice: st_write(shape, &quot;Prac1_data/Rwk1.gpkg&quot;, &quot;london_boroughs_fly_tipping&quot;, delete_layer=TRUE) ## Deleting layer `london_boroughs_fly_tipping&#39; using driver `GPKG&#39; ## Updating layer `london_boroughs_fly_tipping&#39; to data source `Prac1_data/Rwk1.gpkg&#39; using driver `GPKG&#39; ## Writing 33 features with 15 fields and geometry type Multi Polygon. So here, we are saying the shape is the object we want to save, then to the GeoPackage file path, with the layer name of london_boroughs_fly_tipping. I’ve set delete_layer to true so I could overwrite mine when I developed this practical. Changing it to false would generate an error message if you ever tried to re-run the code. Let’s also add the .csv as we did in QGIS. This is a bit more complicated as we have to use the SQLite database package. Firstly, connect to the .gpkg we just made: library(readr) library(RSQLite) con &lt;- dbConnect(RSQLite::SQLite(),dbname=&quot;Prac1_data/Rwk1.gpkg&quot;) Now examine what is in the .gpkg…you can see that i’ve already got my original_csv stored within the .gpkg as when i developed this practical i made sure it was working! dbListTables(con) ## [1] &quot;gpkg_contents&quot; ## [2] &quot;gpkg_extensions&quot; ## [3] &quot;gpkg_geometry_columns&quot; ## [4] &quot;gpkg_metadata&quot; ## [5] &quot;gpkg_metadata_reference&quot; ## [6] &quot;gpkg_ogr_contents&quot; ## [7] &quot;gpkg_spatial_ref_sys&quot; ## [8] &quot;gpkg_tile_matrix&quot; ## [9] &quot;gpkg_tile_matrix_set&quot; ## [10] &quot;london_boroughs_fly_tipping&quot; ## [11] &quot;original_csv&quot; ## [12] &quot;rtree_london_boroughs_fly_tipping_geom&quot; ## [13] &quot;rtree_london_boroughs_fly_tipping_geom_node&quot; ## [14] &quot;rtree_london_boroughs_fly_tipping_geom_parent&quot; ## [15] &quot;rtree_london_boroughs_fly_tipping_geom_rowid&quot; ## [16] &quot;sqlite_sequence&quot; Add your .csv and disconnect from the .gpkg: dbWriteTable(con,&quot;original_csv&quot;, mycsv, overwrite=TRUE) dbDisconnect(con) Here overwrite let’s you well..overwrite the exisiting file…if this wasn’t specified as true you would get an error saying the file already existed if you tried to run this code again. 1.4.8.1 Making a script To convert this bit of analysis into a script that we could save and run again in future, I would write the following in the script quadrant: library(sf) library(tmap) library(tmaptools) library(RSQLite) library(tidyverse) #read in the shapefile shape &lt;- st_read( &quot;Prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) # read in the csv mycsv &lt;- read_csv(&quot;Prac1_data/fly_tipping_borough_edit.csv&quot;) # merge csv and shapefile shape &lt;- merge(shape, mycsv, by.x=&quot;GSS_CODE&quot;, by.y=&quot;Row Labels&quot;) # set tmap to plot tmap_mode(&quot;plot&quot;) # have a look at the map qtm(shape, fill = &quot;2011_12&quot;) # write to a .gpkg st_write(shape, &quot;Prac1_data/Rwk1.gpkg&quot;, &quot;london_boroughs_fly_tipping&quot;, delete_layer=TRUE) # connect to the .gpkg con &lt;- dbConnect(SQLite(),dbname=&quot;Prac1_data/Rwk1.gpkg&quot;) # list what is in it dbListTables(con) # add the original .csv dbWriteTable(con,&quot;original_csv&quot;, mycsv, overwrite=TRUE) # disconnect from it dbDisconnect(con) You can then save your script through File &gt; Save As. If you are on a Mac you might also need to load rgdal…just add the following at the top of the script. library(rgdal) 1.4.9 What will I use Well… it depends. If you wanted to quickly open a dataset to explore its contents then I’d use QGIS or ArcMap. However, if you had 100 raster images that you wanted to clip to your study area, I’d automate it in R. There are also specific packages developed for each type of software that might dictate what you use, for example I recently made use of the Urban Multi-scale Environmental Predictor (UMEP) plugin in QGIS. That said, as I needed to match different hourly meteorological variables over a three year period I automated the first part of the analysis in R and loaded a .csv into QGIS. Recent advancments have also closed the gap somewhat between Graphic User Interface (GUI) GIS software (such as QGIS) and programming languages (such as R) with ‘bridges’ that allow you to control GUI software through code. To learn more about these bridges read Lovelace et al. (2019) chapter 9. 1.5 Data sources and task Below I’ve listed a few good data sources. For this week’s task explore these and any others you can find and get an interesting dataset (e.g. in this practical our flytipping .csv) that you could join to some spatial data (e.g. in this practical the London boroughs .shp). This could be for any location in the world. 1.5.1 UK Data Service The UK Data Service geography service (https://census.edina.ac.uk/) has a library of hundreds of current and former boundary datasets for which attribute data are produced in the UK. 1.5.2 ONS The Office for National Statistics (ONS) are the national statistical agency for England and Wales and have recently started to provide access to boundary data for the statistics they produce for various geographic areas. Many of the boundaries on the ONS Geoportal are also available from the Edina Census Geography website in a more flexible fashion, however the ONS website provides very quick access to bulk-downloads — something which can be very useful when reading data directly from the web using computer software. From the ONS website you can also extract the URL at which the data is stored to use directly within your future code… 1.5.3 nomis Nomis is provided by the ONS giving free access to UK labour market statistics. You can also bulk download census data from the site too! 1.5.4 OS The Ordnance Survey (OS) are the national mapping agency for the UK. A few years ago, they opened up a number of their data products for public use including greenspace, OS Open Map and OS Terrain. For the full range see: https://www.ordnancesurvey.co.uk/business-and-government/products/finder.html?Licensed%20for=OpenData%20(Free)&amp;withdrawn=on 1.5.5 Edina Digimap Before the Ordnance Survey opened up much of its data for public use, academics and students in the UK could access OS data using the Edina Digimap Service –– this service is still available today and provides access to a number of products in addition to those available from OS Open Data. Perhaps the most exciting of the additional OS data products available from Digimap is OS MasterMap. MasterMap is a framework for all OS data and contains layers of data that include details of real world objects such as buildings, roads, paths, rivers, physical structures and land parcels, as well as the complete UK transport network. Whilst we still are required to go through Edina OS have recently announced plans to make this dataset free in the near future under the new Geospatial Commission. 1.5.6 OSM Open Street Map (OSM) is a fantastic resource –– as the name suggests, all data contained in Open Street Map are open and free for anyone to use. Much like Wikipedia, anyone can contribute content to OSM and this brings with it its own benefits (frequent updates, very large user-base) and problems (data quality and patch coverage). OSM is a very good example of Volunteered Geographic Information (VGI). It’s possible to download OSM data straight from the website, although the interface can be a little unreliable (it works better for small areas). There are, however, a number of websites that allow OSM data to be downloaded more easily and are directly linked to from the ‘Export’ option in OSM. Geofabrik (https://www.geofabrik.de/data/download.html) allows you to download frequently updated Shapefiles for various global subdivisions. 1.5.7 DEFRA The Department for Environment and Rural Affairs (DEFRA) have recently created the Data Services Platform to openly distribute environmental data. See: https://environment.data.gov.uk/ 1.5.8 Data lists Another good place to start searching for data are data lists. They simply provide a comprehensive overview of all available data conveniently categorised by discipline and country. I normally use this one: https://freegisdata.rtwilson.com/ 1.6 Summary Within this practical we have explored the different types, formats and software used to store, analyse and manipulate spatial data. In reflecting upon this practical you should consider the (dis)advantages of each, where and when they might be appropriate and the overall practicality. Next week we will delve further into R and RStudio. 1.7 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. 1.8 Mac R issues If you have a Mac and run into issues using R, try this… It seems that a lot of the packages are dependent on rgdal, which might not properly install… Order of operations Install java JDK (to respond to error Unable to find any JVMs matching version “(null)”, which occurred when we tried to load OpenStreetMap package in RStudio) Download and install the appropriate .dmg from Java SE Development Kit 11.0.1 Run sudo R CMD javareconf in Terminal as described here(though don’t follow this tutorial exactly, just up to that terminal command). (Maybe) restart your computer (not really sure when this is necessary). Install GDAL GDAL, the Geospatial Data Abstraction Library, appears to be a massively important package / library / whatever that a lot of the spatial tools we use depends on. This is where things might be sticky — we already installed GDAL for QGIS, but obviously RStudio can’t find that install … dunno how to update the pointers, but we found that installing GDAL (again?) solved it. We HOPE that this didn’t ruin or break any other software we’ve installed, only time will tell :grimacing: To install GDAL on a mac, first (if you haven’t) install homebrew, the mac package manager This can be done by executing /usr/bin/ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\" in Terminal, inputting password etc. Now we’re ready to brew install gdal (also in Terminal), which will run through and install a massive list of dependencies etc. Set up RStudio Restart RStudio (if the following doesn’t work on first go…) Run through all the install.packages() commands one by one in RStudio and check to make sure that they install. Check if rgdal package is working. Check the other packages OpenStreetMap, tmap, etc. "],
["introduction-to-r.html", "Chapter 2 Introduction to R 2.1 Learning outcomes 2.2 Recommended listening 2.3 Introduction 2.4 Reading data into R 2.5 Making maps using ggplot2 2.6 Writing good R code 2.7 Tidying data 2.8 Feedback", " Chapter 2 Introduction to R 2.1 Learning outcomes By the end of this practical you should be able to: Execute basic processing in R Examine, clean and manipulate comma seperate value (.csv) data Examine, clean and manipulate and plot spatial (.shp) data Produce interactive maps Evaluate the benefits of different data manipulation and mapping techniques 2.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy Adam. Recommended listening this week comes courtesy of “Pound for pound the best rock band on the planet at the minute. In my, not so humble opinion.” – Jake Burns, Stiff Little Fingers. Yes, it’s the Wildhearts and I can confirm that they are the greatest rock band on the planet! Wrap your ears around this: 2.3 Introduction This practical is LONG but it will take you from not knowing much about R to making freaking cool interactive maps in one practical. As you can imagine, this will be a steep learning curve. I will give you all the code you need, it’s your job to read through the text very carefully and try to understand what bits of code are doing as you go. There will be bits of code you don’t fully understand. Don’t worry, the key is to revisit later and try to work out what is going on then. Learning R is a long and iterative process and this is just the start… If you want to learn more about R and indeed download the latest version for your own use, then visit the R project pages The Wikipedia page for those who want to know a little of the history of R can be found here There is an almost endless supply of good R tutorials on the web. If you get stuck or want to learn even more R (and why would you not want to?!), I’d recommend trying some of the following R Tutorial websites: http://www.statmethods.net/index.html http://www.r-tutor.com/ http://www.cyclismo.org/tutorial/R/index.html http://www.cookbook-r.com/ If you want to really be up to date with the state of the art in R, then bookdown is a fantastic resource. It features free books by some of the pre-eminent names in the R scene — I would urge you to go and take a look. 2.3.1 Online forums are your friend!! With almost every problem you encounter with R, someone else will have had the same problem before you and posted it on a forum –– someone will then post a solution below. My usual route is to Google the problem and I’ll then be directed to a post, usually on Stack Overflow, Stack Exchange or Cross Validated. When doing so try to think about the minimal working (or not working) example (MWE), by this i mean remove anything very specific to your problem. I’ve rarely not found a solution to a problem this way. 2.3.2 Health warning Beware of posting questions on these forums yourself – contributors to these forums (especially the R ones!), whilst almost always extremely knowledgeable about R, have a bit of a reputation for being insert familiar pejorative term for less-than-polite-human-being here! As you might expect, people who have enough time to become total experts in R, have little time to work on their social skills!! Fortunately though, some other poor chump has usually taken that hit for you and you can still find a useful answer to your problem. If you are specifically more interested in the spatial side of R, then Alex Singleton and Chris Brunsdon at the Universities of Liverpool and Maynooth also have a number of very useful R Spatial Tutorials – http://rpubs.com/alexsingleton/ &amp; http://rpubs.com/chrisbrunsdon/ Robin Lovelace in Leeds is also frequently at the bleeding edge of developments in R spatial stuff, so keep an eye on his website. Robin has also made a book on GeoComputation in R, which you should definitely read! — https://geocompr.robinlovelace.net/ These websites are also very very good: https://pakillo.github.io/R-GIS-tutorial/ and http://www.maths.lancs.ac.uk/~rowlings/Teaching/UseR2012/cheatsheet.html 2.3.3 R and RStudio When you download and install R, you get the R Graphical User Interface (GUI) as standard (below). This is fine and some purists prefer using the clean, unfussy command-line original, but it has some limitations such as no graphical way to view data tables or keep track of what is in your working directory (there are a number of others too). Fortunately there are a number of software environments that have been developed for R to make it a little more user-friendly; the best of these by a long way is RStudio. RStudio can be downloaded for free from https://www.rstudio.com/. We covered the RStudio layout last week. 2.3.4 Getting started If you are some kind of masochist, you are welcome to use the bundled R GUI for all of your work. If pain is not your thing, then for this practical (and future practicals) I will assume that you are using RStudio. From the start menu on your computer, find and run R Studio Once RStudio has opened, the first thing we will do is create a new project – projects enable you to organise your work effectively and store all of the files you create and work with for a particular task. To create a new project (and this will vary a little depending on the version of RStudio you are using) select File &gt; New Project Select Start a project in a brand new working directory and create a new project in a directory of a new ‘wk2’ directory on your N: drive: My file directory (the second box here) will be different to yours as this is my teaching resources folder. Keep yours simple N:/GIS/wk2. Setting up a project is extremely useful as it lets you easily access your data and files…for example….the flytipping .csv we used last week is stored at the file path mycsv &lt;- read_csv(&quot;C:/Teaching/CASA0005repo/Prac1_data/fly_tipping_borough_edit.csv&quot;) However as i’ve set my R project up in the CASA0005repo folder with different data folders for each week i can just use: mycsv &lt;- read_csv(&quot;Prac1_data/fly_tipping_borough_edit.csv&quot;) If i had the .csv file in the same folder as my project i could just use mycsv &lt;- read_csv(&quot;fly_tipping_borough_edit.csv&quot;) You can run this in the Console area now or within a script which we will now go over… 2.3.5 Basics R has a very steep learning curve, but hopefully it won’t take long to get your head around the basics. For example, at its most simple R can be used as a calculator. In the console window (bottom left), just type the following and press enter: 1+5 ## [1] 6 or 4*5^2 ## [1] 100 As you can see R performs these calculations instantly and prints the results in the console. This is useful for quick calculations but less useful for writing scripts requiring multiple operations or saving these for future use. To save your scripts, you should create a new R Script file. Do this now: Select File &gt; New File &gt; R Script. The R Script should open up on the top-left of your GUI. From now on type everything in this R script file and save it 2.3.6 Scripts and some basic commands Usually one of the first things to do when starting a new R Script is to check that you are in the correct working directory. This is important especially if you are working on multiple projects in different locations. To do this type the following into your new empty R Script: getwd() ## [1] &quot;C:/Users/ucfnmac/OneDrive - University College London/Teaching/CASA0005repo&quot; To run this line, hold Ctrl (Cmd on a Mac) and press the Return(↲) key (if you are in the standard R installation, you would run your script with Ctrl R). You should now see your current working directory appear in the console. Because of the new project we have already set up, this working directory should be correct, but if for any reason we wanted to change the working directory, we would use the setwd() function. For example, we wanted to change our directory to the documents folder on the C drive, we could run (don’t do this now): setwd(&quot;C:/Documents&quot;) When we are sure we are working in the correct working directory, we can save our script by clicking on the save icon on the script tab. Save your script as something like “wk2_part1” and you will see it appear in your files window on the right hand side. As you build up a document of R code, you should get into the habit of saving your script periodically in case of an unexpected software crash. We can now begin to write a script without the need to run each line every time we press enter. In the script editor type: A &lt;- 1 B &lt;- 2 C &lt;- A+B C ## [1] 3 Select (highlight) the three lines and run all three lines with Ctrl Return(↲). You will notice the lines appear in the console (the other window). If you type C and press enter in the console (C and then ctrl return in the script window) you should have the number 3 appear. From now on I recommend you type all the commands below in the script first and then run them. Copying and pasting from this document won’t necessarily work. You will also notice that in RStudio, values A, B and C will appear in your workspace window (top right). These variables are stored in memory for future use. Try giving A and B different values and see what happens. What about if you use lower case letters? You have just demonstrated one of the powerful aspects of R, which is that it is an object oriented programming language. A, B and C are all objects that have been assigned a value with the &lt;- symbol (you can also use the = sign, but it operates slightly differently to &lt;- in R, plus the arrow assignment has become standard over the years. Use alt - to type it automatically). This principle underlies the whole language and enables users to create ever more complex objects as they progress through their analysis. If you type: ls() ## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; &quot;con&quot; &quot;mycsv&quot; &quot;shape&quot; R will produce a list of objects that are currently active. rm(A) will remove the object A from the workspace (do ls() again to check this or look in your workspace window). 2.3.7 Functions Both rm() and ls() are known as functions. Functions are the other fundamental aspect to the R language. Functions can be thought of as single or multiple calculations that you apply to objects. They generally take the form of…(don’t run these) function(object, argument1, argument2, argument3) Where the object is some form of data and the arguments parameterise what the function will do. You could save the ouput to a new object using something like… X&lt;-function(object, argument1, argument2, argument3) You can write your own functions to carry out tasks (and we’ll come onto that in subsequent practical sessions), but normally you will just used one of the virtually infinite number of functions that other people have already written for us. 2.3.8 Basic plotting One common function is the plot() function for displaying data as a graphical output. Add these lines to your script and run them as before and you can see some plot() outputs: #create some datasets, first a vector of 1-100 and 101-200 Data1 &lt;- c(1:100) Data2 &lt;- c(101:200) #Plot the data plot(Data1, Data2, col=&quot;red&quot;) #just for fun, create some more, this time some normally distributed #vectors of 100 numbers Data3 &lt;- rnorm(100, mean = 53, sd=34) Data4 &lt;- rnorm(100, mean = 64, sd=14) #plot plot(Data3, Data4, col=&quot;blue&quot;) In the code above, you will have noticed the # symbol. This signifies that whatever comes after it on that line is a comment. Comments are ignored by the R console and they allow you to annotate your code so that you know what it is doing. It is good programming practice to comment your code extensively so that you can keep track of what your scripts are for. Warning Heed our advice now and comment your code it will save you time in the future! 2.3.9 Help The previous lines of code also demonstrated a number of functions: c() concatenates a string of numbers together into a vector. 1:100 means produce the integers between and including 1:100, the plot() function plots the two data objects and includes a parameter to change the colour of the points. To understand what a function does, you can consult the R Help system. Simply type a question mark and then the function name; for example: ?plot In RStudio you will see the help file appear in the Help window in the bottom right of the GUI. Here you can also search for the help files for other functions in the search bar. 2.3.10 Data types Objects in R can exist as a number of different data types. These include a matrix, a vector, a data frame and a list. For the purposes of this practical we will focus on data frames. These are the most flexible data format in R (although tibbles are now becoming popular as well). Data frames can be conceptualised in a similar way to a spreadsheet with data held in rows and columns. They are the most commonly used object type in R and the most straightforward to create from the two vector objects we just created. df &lt;- data.frame(Data1, Data2) plot(df, col=&quot;green&quot;) If you have a very large data frame (thousands or millions of rows) it is useful to see only a selection of these. There are several ways of doing this: #show the first 10 and then last 10 rows of data in df... head(df) ## Data1 Data2 ## 1 1 101 ## 2 2 102 ## 3 3 103 ## 4 4 104 ## 5 5 105 ## 6 6 106 tail(df) ## Data1 Data2 ## 95 95 195 ## 96 96 196 ## 97 97 197 ## 98 98 198 ## 99 99 199 ## 100 100 200 You can also view elements of your data frame in RStudio by simply clicking on it in the top-right Environment window: 2.3.11 Elements of a data frame When programming you will frequently want to refer to different elements in a data frame or a vector/list. To select elements of a data frame, or subset it, you can refer specifically to ranges or elements of rows and columns. These are accessed using the single square bracket operator [], with the form: data.frame[row,column] Rows are always referenced first, before the comma, columns second, after the comma. Try the subsetting your df data frame with the following commands to see what is returned: df[1:10, 1] ## [1] 1 2 3 4 5 6 7 8 9 10 df[5:15,] ## Data1 Data2 ## 5 5 105 ## 6 6 106 ## 7 7 107 ## 8 8 108 ## 9 9 109 ## 10 10 110 ## 11 11 111 ## 12 12 112 ## 13 13 113 ## 14 14 114 ## 15 15 115 df[c(2,3,6),2] ## [1] 102 103 106 df[,1] ## [1] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ## [18] 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ## [35] 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ## [52] 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 ## [69] 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 ## [86] 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 You will note that the column headings are the names of the original objects creating the data frame. We can change these using the colnames() function: colnames(df)&lt;- c(&quot;column1&quot;, &quot;column2&quot;) To select or refer to these columns directly by name, we can either use the $ operator, which takes the form data.frame$columnName, e.g. df$column1 ## [1] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ## [18] 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ## [35] 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ## [52] 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 ## [69] 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 ## [86] 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 or we can use the double square bracket operator [[]], and refer to our column by name using quotes e.g. df[[&quot;column1&quot;]] ## [1] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ## [18] 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ## [35] 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ## [52] 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 ## [69] 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 ## [86] 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 This again is useful if you have a lot of columns and you wish to efficiently extract one of them. 2.4 Reading data into R One of the most tedious things a spatial analyst / data scientist has to do is clean their data so it doesn’t cause problems for the software later. In the past, we would have needed to do this by hand — these days, we can use software to do much of this for us. I will now give you two options to arrive at a nice cleaned dataset. If you have issues with software packages etc, you might still need to via the old skool route, however, the new skool route will be much more satisfying if it works! For this example we are going to use the London Datastore Catalogue. Go to: https://data.london.gov.uk/dataset/f33fb38c-cb37-48e3-8298-84c0d3cc5a6c and download the excel document for ward profiles. 2.4.1 Old skool cleaning Open the ward-profiles-excel-version.xls file in Excel, and save as LondonData.csv into your wk2/RProject folder. Open your new .csv file in Excel. There might be some non-numeric values inside numeric columns which will cause problems in your analysis. These need to be removed before proceeding any further. To remove these, you can use the replace function in Excel. In the home tab under ‘Editing’ open up the find and replace dialogue box and enter the following into the find box: #VALUE! n/a Leave the replace box empty each time and click Replace All to remove these from your file, before saving the file again. Once you have cleaned out all of the trixy characters from the file, to read it into R, we will use the read.csv() function: LondonDataOSK&lt;- read.csv(&quot;prac2_data/ward-profiles-excel-version.csv&quot;) Note, I’ve made an R project for all these practicals, which is why my file path starts with prac2_data/. If you save the .csv in the same folder as the .Rproj then you can just use: LondonDataOSK&lt;- read.csv(&quot;ward-profiles-excel-version.csv&quot;) If you look at the read.csv() help file - ?read.csv - you will see that we can actually include many more parameters when reading in a .csv file. For example, we could read in the same file as follows: # by default in R, the file path should be defined with / but on a #windows file system it is defined with \\. Using \\\\ instead allows R #to read the path correctly – alternatively, just use / LondonDataOSK&lt;- read.csv(&quot;prac2_data/ward-profiles-excel-version.csv&quot;, header = TRUE, sep = &quot;,&quot;) This would specify that the first row of the file contains header information; and the values in the file are separated with commas (not ; or : as can be the case sometimes). 2.4.2 New skool cleaning To clean our data as we read it in, we are going to use a package (more about packages later — for now, just think about it as a lovely gift from the R gods) called readr which comes bundled as part of the tidyverse package. If you want to find out more about the tidyverse (and you really should) then you should start here — the tidyverse package contains almost everything you need to become a kick-ass data scientist. ‘Tidy’ as a concept in data science is well worth reading about and you should start here with Hadley Wickham’s paper Anyway, first install the package: install.packages(&quot;tidyverse&quot;) Now we can use the readr package which comes bundled as part of the tidyverse to read in some data (directly from the web this time — read.csv can do this too) and clean text characters out from the numeric columns before they cause problems: library(tidyverse) #wang the data in straight from the web using read_csv, #skipping over the &#39;n/a&#39; entries as you go... LondonData &lt;- read_csv(&quot;https://files.datapress.com/london/dataset/ward-profiles-and-atlas/2015-09-24T14:21:24/ward-profiles-excel-version.csv&quot;, locale = locale(encoding = &quot;latin1&quot;), na = &quot;n/a&quot;) Note the use of read_csv here as opposed to read.csv. They are very similar, but read_csv is just a bit better. Read this for more information. Also, for those python fans out there —IT’S NOT THE SAME FUNCTION AS READ_CSV IN PYTHON What is locale = locale(encoding = \"latin1\")…good question…it is basically the encoding of the data (how it is stored). There are a few different formats such as UTF-8 and latin1. In latin1 each character is 1 byte long, in UTF-8 a character can consist of more than 1 byte. To my knowledge the default in R is encoded as latin1, but readr (the package we are using to read in the .csv is UTF-8 so we have to specify it. 2.4.3 Examining your new data Your new data has been read in as a data frame / tibble (a tibble is just a data frame with a few extra bells and whistles). If you ever need to check what data type your new data set is, we can use the class() function: class(LondonData) ## [1] &quot;spec_tbl_df&quot; &quot;tbl_df&quot; &quot;tbl&quot; &quot;data.frame&quot; # or, if you have your old skool data from step 24 above class(LondonDataOSK) We can also use the class function within another two functions (cbind() and lapply()) to check that our data has been read in correctly and that, for example, numeric data haven’t been read in as text or other variables. Run the following line of code: datatypelist &lt;- data.frame(cbind(lapply(LondonData,class))) You should see that all columns that should be numbers are read in as numeric. Try reading in LondonData again, but this time without excluding the ‘n/a’ values in the file, e.g. LondonData &lt;- read_csv(&quot;https://files.datapress.com/london/dataset/ward-profiles-and-atlas/2015-09-24T14:21:24/ward-profiles-excel-version.csv&quot;, locale = locale(encoding = &quot;latin1&quot;)) Now run the datatypelist function again — you should see that some of the columns (those the n/a values in) have been read in as something other than numeric. This is why we need to exclude them. Isn’t readr great for helping us avoid reading in our numeric data as text! To show this print the values in the column % children in reception year who are obese - 2011/12 to 2013/14 the column Mean Age - 2013 # col has n/a and is not numeric LondonData$`% children in reception year who are obese - 2011/12 to 2013/14` ## [1] &quot;11.1&quot; &quot;13.3&quot; &quot;10.0&quot; &quot;12.3&quot; &quot;12.8&quot; &quot;12.6&quot; &quot;11.5&quot; &quot;16.2&quot; &quot;16.2&quot; &quot;15.0&quot; ## [11] &quot;11.4&quot; &quot;12.6&quot; &quot;14.8&quot; &quot;17.2&quot; &quot;15.6&quot; &quot;12.2&quot; &quot;12.9&quot; &quot;12.8&quot; &quot;10.8&quot; &quot;11.9&quot; ## [21] &quot;12.2&quot; &quot;12.6&quot; &quot;10.0&quot; &quot;11.3&quot; &quot;7.9&quot; &quot;10.9&quot; &quot;6.6&quot; &quot;6.3&quot; &quot;8.7&quot; &quot;11.2&quot; ## [31] &quot;7.4&quot; &quot;4.5&quot; &quot;11.3&quot; &quot;7.8&quot; &quot;9.0&quot; &quot;7.9&quot; &quot;8.5&quot; &quot;9.8&quot; &quot;9.1&quot; &quot;9.1&quot; ## [41] &quot;11.8&quot; &quot;8.5&quot; &quot;9.7&quot; &quot;6.1&quot; &quot;11.8&quot; &quot;11.1&quot; &quot;10.1&quot; &quot;14.0&quot; &quot;11.5&quot; &quot;10.9&quot; ## [51] &quot;13.4&quot; &quot;10.4&quot; &quot;13.3&quot; &quot;8.2&quot; &quot;15.2&quot; &quot;11.0&quot; &quot;8.7&quot; &quot;9.1&quot; &quot;10.4&quot; &quot;17.1&quot; ## [61] &quot;8.3&quot; &quot;10.8&quot; &quot;8.3&quot; &quot;13.2&quot; &quot;15.6&quot; &quot;10.5&quot; &quot;15.8&quot; &quot;11.6&quot; &quot;5.8&quot; &quot;11.9&quot; ## [71] &quot;13.7&quot; &quot;11.5&quot; &quot;13.0&quot; &quot;9.9&quot; &quot;10.7&quot; &quot;17.0&quot; &quot;10.6&quot; &quot;13.1&quot; &quot;11.2&quot; &quot;9.2&quot; ## [81] &quot;15.0&quot; &quot;7.3&quot; &quot;8.0&quot; &quot;10.5&quot; &quot;5.8&quot; &quot;4.2&quot; &quot;6.0&quot; &quot;7.1&quot; &quot;7.8&quot; &quot;9.1&quot; ## [91] &quot;8.4&quot; &quot;9.6&quot; &quot;11.4&quot; &quot;4.4&quot; &quot;7.4&quot; &quot;7.1&quot; &quot;11.1&quot; &quot;9.2&quot; &quot;10.4&quot; &quot;6.1&quot; ## [101] &quot;9.2&quot; &quot;3.9&quot; &quot;6.8&quot; &quot;10.9&quot; &quot;12.0&quot; &quot;11.6&quot; &quot;9.0&quot; &quot;3.5&quot; &quot;n/a&quot; &quot;10.7&quot; ## [111] &quot;n/a&quot; &quot;12.0&quot; &quot;5.3&quot; &quot;9.0&quot; &quot;6.5&quot; &quot;13.4&quot; &quot;10.9&quot; &quot;12.6&quot; &quot;12.3&quot; &quot;13.8&quot; ## [121] &quot;6.1&quot; &quot;10.3&quot; &quot;11.5&quot; &quot;13.2&quot; &quot;11.5&quot; &quot;9.4&quot; &quot;9.6&quot; &quot;8.9&quot; &quot;10.2&quot; &quot;13.9&quot; ## [131] &quot;10.6&quot; &quot;4.5&quot; &quot;11.3&quot; &quot;11.2&quot; &quot;8.1&quot; &quot;7.7&quot; &quot;14.6&quot; &quot;8.8&quot; &quot;9.1&quot; &quot;11.6&quot; ## [141] &quot;13.8&quot; &quot;10.5&quot; &quot;11.1&quot; &quot;12.6&quot; &quot;11.6&quot; &quot;11.1&quot; &quot;10.0&quot; &quot;14.0&quot; &quot;6.2&quot; &quot;9.9&quot; ## [151] &quot;11.1&quot; &quot;11.0&quot; &quot;13.7&quot; &quot;9.1&quot; &quot;7.1&quot; &quot;11.4&quot; &quot;12.9&quot; &quot;5.3&quot; &quot;8.8&quot; &quot;12.1&quot; ## [161] &quot;14.1&quot; &quot;12.3&quot; &quot;11.6&quot; &quot;11.6&quot; &quot;14.8&quot; &quot;14.3&quot; &quot;7.4&quot; &quot;7.8&quot; &quot;9.3&quot; &quot;10.8&quot; ## [171] &quot;12.0&quot; &quot;9.0&quot; &quot;17.6&quot; &quot;14.1&quot; &quot;16.3&quot; &quot;8.6&quot; &quot;14.5&quot; &quot;8.9&quot; &quot;12.8&quot; &quot;13.2&quot; ## [181] &quot;11.0&quot; &quot;16.7&quot; &quot;12.0&quot; &quot;9.5&quot; &quot;9.7&quot; &quot;10.8&quot; &quot;13.4&quot; &quot;14.7&quot; &quot;6.6&quot; &quot;16.6&quot; ## [191] &quot;6.8&quot; &quot;12.8&quot; &quot;10.5&quot; &quot;6.8&quot; &quot;12.1&quot; &quot;13.8&quot; &quot;14.1&quot; &quot;11.1&quot; &quot;11.0&quot; &quot;11.5&quot; ## [201] &quot;7.0&quot; &quot;14.1&quot; &quot;12.8&quot; &quot;16.9&quot; &quot;14.0&quot; &quot;15.4&quot; &quot;15.0&quot; &quot;12.1&quot; &quot;17.4&quot; &quot;8.9&quot; ## [211] &quot;10.6&quot; &quot;13.7&quot; &quot;14.4&quot; &quot;10.7&quot; &quot;13.5&quot; &quot;14.8&quot; &quot;14.6&quot; &quot;10.7&quot; &quot;10.1&quot; &quot;18.2&quot; ## [221] &quot;12.9&quot; &quot;13.5&quot; &quot;10.7&quot; &quot;14.8&quot; &quot;15.8&quot; &quot;6.4&quot; &quot;9.5&quot; &quot;11.1&quot; &quot;12.8&quot; &quot;8.3&quot; ## [231] &quot;12.1&quot; &quot;8.7&quot; &quot;10.3&quot; &quot;8.0&quot; &quot;9.1&quot; &quot;9.1&quot; &quot;7.7&quot; &quot;14.5&quot; &quot;10.7&quot; &quot;12.5&quot; ## [241] &quot;10.5&quot; &quot;4.5&quot; &quot;10.6&quot; &quot;14.8&quot; &quot;2.4&quot; &quot;4.6&quot; &quot;7.8&quot; &quot;3.8&quot; &quot;8.2&quot; &quot;2.7&quot; ## [251] &quot;14.2&quot; &quot;17.2&quot; &quot;11.1&quot; &quot;10.7&quot; &quot;5.8&quot; &quot;13.9&quot; &quot;16.5&quot; &quot;13.8&quot; &quot;16.2&quot; &quot;12.0&quot; ## [261] &quot;7.1&quot; &quot;13.1&quot; &quot;11.3&quot; &quot;10.9&quot; &quot;9.8&quot; &quot;12.7&quot; &quot;6.8&quot; &quot;4.8&quot; &quot;8.1&quot; &quot;11.6&quot; ## [271] &quot;10.4&quot; &quot;10.9&quot; &quot;10.4&quot; &quot;6.4&quot; &quot;10.5&quot; &quot;6.0&quot; &quot;9.5&quot; &quot;9.7&quot; &quot;9.3&quot; &quot;11.8&quot; ## [281] &quot;7.3&quot; &quot;8.0&quot; &quot;9.0&quot; &quot;11.0&quot; &quot;10.5&quot; &quot;14.3&quot; &quot;12.1&quot; &quot;7.7&quot; &quot;9.7&quot; &quot;12.8&quot; ## [291] &quot;3.9&quot; &quot;10.6&quot; &quot;9.7&quot; &quot;13.6&quot; &quot;10.2&quot; &quot;11.5&quot; &quot;11.3&quot; &quot;10.4&quot; &quot;6.8&quot; &quot;11.5&quot; ## [301] &quot;9.8&quot; &quot;10.3&quot; &quot;6.4&quot; &quot;11.3&quot; &quot;5.9&quot; &quot;10.0&quot; &quot;12.8&quot; &quot;9.0&quot; &quot;7.0&quot; &quot;9.3&quot; ## [311] &quot;4.1&quot; &quot;8.3&quot; &quot;9.8&quot; &quot;9.3&quot; &quot;10.9&quot; &quot;7.4&quot; &quot;12.3&quot; &quot;10.0&quot; &quot;5.9&quot; &quot;10.4&quot; ## [321] &quot;11.0&quot; &quot;11.7&quot; &quot;12.6&quot; &quot;6.7&quot; &quot;6.6&quot; &quot;12.7&quot; &quot;12.7&quot; &quot;14.5&quot; &quot;13.1&quot; &quot;14.0&quot; ## [331] &quot;13.5&quot; &quot;10.5&quot; &quot;9.0&quot; &quot;11.8&quot; &quot;10.8&quot; &quot;9.3&quot; &quot;10.7&quot; &quot;10.7&quot; &quot;8.4&quot; &quot;9.7&quot; ## [341] &quot;7.3&quot; &quot;9.9&quot; &quot;12.4&quot; &quot;13.0&quot; &quot;9.1&quot; &quot;12.9&quot; &quot;11.8&quot; &quot;6.3&quot; &quot;11.4&quot; &quot;7.7&quot; ## [351] &quot;13.7&quot; &quot;8.6&quot; &quot;13.9&quot; &quot;8.7&quot; &quot;11.4&quot; &quot;9.1&quot; &quot;9.1&quot; &quot;n/a&quot; &quot;n/a&quot; &quot;5.2&quot; ## [361] &quot;14.0&quot; &quot;n/a&quot; &quot;11.0&quot; &quot;6.4&quot; &quot;13.3&quot; &quot;n/a&quot; &quot;12.0&quot; &quot;n/a&quot; &quot;n/a&quot; &quot;n/a&quot; ## [371] &quot;n/a&quot; &quot;n/a&quot; &quot;n/a&quot; &quot;n/a&quot; &quot;7.7&quot; &quot;7.6&quot; &quot;4.6&quot; &quot;6.5&quot; &quot;3.8&quot; &quot;9.8&quot; ## [381] &quot;8.1&quot; &quot;4.9&quot; &quot;5.2&quot; &quot;6.0&quot; &quot;11.3&quot; &quot;6.7&quot; &quot;5.9&quot; &quot;2.9&quot; &quot;4.2&quot; &quot;4.9&quot; ## [391] &quot;3.3&quot; &quot;15.6&quot; &quot;9.9&quot; &quot;12.7&quot; &quot;12.0&quot; &quot;12.9&quot; &quot;15.2&quot; &quot;13.3&quot; &quot;9.9&quot; &quot;9.1&quot; ## [401] &quot;10.8&quot; &quot;9.9&quot; &quot;10.0&quot; &quot;8.8&quot; &quot;15.0&quot; &quot;13.2&quot; &quot;9.5&quot; &quot;9.6&quot; &quot;9.7&quot; &quot;8.9&quot; ## [411] &quot;13.6&quot; &quot;15.4&quot; &quot;11.9&quot; &quot;9.6&quot; &quot;9.8&quot; &quot;10.5&quot; &quot;6.8&quot; &quot;12.2&quot; &quot;13.4&quot; &quot;9.0&quot; ## [421] &quot;10.6&quot; &quot;7.3&quot; &quot;8.6&quot; &quot;12.0&quot; &quot;15.6&quot; &quot;9.7&quot; &quot;13.7&quot; &quot;10.6&quot; &quot;11.3&quot; &quot;12.6&quot; ## [431] &quot;4.1&quot; &quot;6.2&quot; &quot;10.5&quot; &quot;11.9&quot; &quot;n/a&quot; &quot;13.5&quot; &quot;12.4&quot; &quot;5.1&quot; &quot;12.7&quot; &quot;14.6&quot; ## [441] &quot;9.3&quot; &quot;4.7&quot; &quot;10.9&quot; &quot;12.4&quot; &quot;2.0&quot; &quot;11.9&quot; &quot;6.4&quot; &quot;n/a&quot; &quot;5.5&quot; &quot;4.2&quot; ## [451] &quot;13.0&quot; &quot;13.0&quot; &quot;15.0&quot; &quot;14.3&quot; &quot;12.2&quot; &quot;13.4&quot; &quot;10.7&quot; &quot;10.4&quot; &quot;16.2&quot; &quot;10.7&quot; ## [461] &quot;9.5&quot; &quot;12.6&quot; &quot;12.8&quot; &quot;10.9&quot; &quot;13.0&quot; &quot;14.7&quot; &quot;12.4&quot; &quot;11.3&quot; &quot;10.2&quot; &quot;14.5&quot; ## [471] &quot;11.5&quot; &quot;7.6&quot; &quot;9.6&quot; &quot;13.6&quot; &quot;7.9&quot; &quot;6.9&quot; &quot;10.9&quot; &quot;12.2&quot; &quot;11.3&quot; &quot;9.8&quot; ## [481] &quot;13.0&quot; &quot;9.7&quot; &quot;11.8&quot; &quot;12.6&quot; &quot;7.5&quot; &quot;14.9&quot; &quot;8.9&quot; &quot;8.9&quot; &quot;5.6&quot; &quot;9.7&quot; ## [491] &quot;9.5&quot; &quot;4.8&quot; &quot;5.0&quot; &quot;5.6&quot; &quot;5.0&quot; &quot;5.3&quot; &quot;7.8&quot; &quot;6.4&quot; &quot;9.6&quot; &quot;3.5&quot; ## [501] &quot;5.3&quot; &quot;4.7&quot; &quot;4.0&quot; &quot;4.7&quot; &quot;5.8&quot; &quot;7.4&quot; &quot;3.2&quot; &quot;5.3&quot; &quot;9.3&quot; &quot;11.9&quot; ## [511] &quot;16.3&quot; &quot;11.4&quot; &quot;12.8&quot; &quot;14.1&quot; &quot;5.9&quot; &quot;16.4&quot; &quot;19.0&quot; &quot;14.3&quot; &quot;15.0&quot; &quot;13.7&quot; ## [521] &quot;14.5&quot; &quot;15.9&quot; &quot;9.2&quot; &quot;9.8&quot; &quot;10.3&quot; &quot;11.2&quot; &quot;10.2&quot; &quot;8.5&quot; &quot;13.2&quot; &quot;6.6&quot; ## [531] &quot;6.3&quot; &quot;8.6&quot; &quot;7.9&quot; &quot;6.4&quot; &quot;5.9&quot; &quot;7.1&quot; &quot;4.6&quot; &quot;11.5&quot; &quot;8.5&quot; &quot;9.1&quot; ## [541] &quot;9.5&quot; &quot;8.2&quot; &quot;8.3&quot; &quot;8.0&quot; &quot;7.2&quot; &quot;8.3&quot; &quot;10.0&quot; &quot;8.0&quot; &quot;15.5&quot; &quot;14.5&quot; ## [551] &quot;10.8&quot; &quot;14.3&quot; &quot;10.6&quot; &quot;12.5&quot; &quot;12.8&quot; &quot;12.5&quot; &quot;13.4&quot; &quot;11.8&quot; &quot;9.0&quot; &quot;12.4&quot; ## [561] &quot;10.7&quot; &quot;15.2&quot; &quot;14.2&quot; &quot;14.6&quot; &quot;13.4&quot; &quot;10.8&quot; &quot;11.9&quot; &quot;10.1&quot; &quot;8.4&quot; &quot;8.9&quot; ## [571] &quot;9.4&quot; &quot;10.8&quot; &quot;6.9&quot; &quot;8.1&quot; &quot;10.0&quot; &quot;10.3&quot; &quot;10.7&quot; &quot;11.2&quot; &quot;11.4&quot; &quot;13.4&quot; ## [581] &quot;9.9&quot; &quot;10.7&quot; &quot;11.5&quot; &quot;11.5&quot; &quot;12.0&quot; &quot;5.5&quot; &quot;8.2&quot; &quot;9.8&quot; &quot;7.0&quot; &quot;7.5&quot; ## [591] &quot;10.1&quot; &quot;10.9&quot; &quot;13.7&quot; &quot;4.1&quot; &quot;3.4&quot; &quot;11.1&quot; &quot;11.8&quot; &quot;12.7&quot; &quot;7.8&quot; &quot;6.6&quot; ## [601] &quot;4.6&quot; &quot;10.6&quot; &quot;8.6&quot; &quot;9.6&quot; &quot;12.4&quot; &quot;8.5&quot; &quot;9.5&quot; &quot;12.2&quot; &quot;14.6&quot; &quot;13.8&quot; ## [611] &quot;10.9&quot; &quot;11.6&quot; &quot;n/a&quot; &quot;6.0&quot; &quot;9.1&quot; &quot;8.5&quot; &quot;10.0&quot; &quot;11.0&quot; &quot;7.5&quot; &quot;12.6&quot; ## [621] &quot;13.1&quot; &quot;10.0&quot; &quot;13.5&quot; &quot;11.7&quot; &quot;n/a&quot; &quot;11.1&quot; &quot;13.6&quot; &quot;9.5&quot; &quot;11.6&quot; &quot;12.2&quot; ## [631] &quot;7.8&quot; &quot;9.8&quot; &quot;11.1&quot; &quot;11.2&quot; &quot;12.7&quot; &quot;13.2&quot; &quot;13.3&quot; &quot;10.2&quot; &quot;11.1&quot; &quot;9.6&quot; ## [641] &quot;10.3&quot; &quot;9.6&quot; &quot;11.2&quot; &quot;10.6&quot; &quot;9.2&quot; &quot;6.0&quot; &quot;11.5&quot; &quot;11.0&quot; &quot;9.0&quot; &quot;12.5&quot; ## [651] &quot;10.6&quot; &quot;5.7&quot; &quot;12.8&quot; &quot;8.1&quot; &quot;12.7&quot; &quot;10.6&quot; &quot;9.2&quot; &quot;11.1&quot; &quot;10.8&quot; &quot;9.4&quot; # no n/a values in this column LondonData$`Mean Age - 2013` ## [1] 41.3 29.5 33.8 33.0 36.2 37.7 33.4 29.0 34.1 34.4 35.2 33.9 34.3 33.4 ## [15] 28.7 34.8 34.5 35.3 38.9 33.7 36.1 32.1 36.3 38.3 37.2 37.1 39.1 39.1 ## [29] 33.0 37.1 34.9 40.7 37.1 39.8 39.6 39.2 37.5 35.2 37.9 40.8 36.1 40.5 ## [43] 40.5 43.2 40.6 37.3 37.7 39.4 40.2 40.5 34.9 39.6 38.8 42.2 33.6 39.2 ## [57] 42.4 38.2 41.8 32.0 35.3 35.8 37.0 34.8 34.7 36.0 33.0 35.4 40.2 34.6 ## [71] 35.0 37.3 35.9 35.6 36.2 32.2 35.1 34.9 35.8 35.6 33.7 41.8 40.9 39.6 ## [85] 37.5 41.6 42.6 37.2 40.6 38.2 37.3 34.6 43.2 43.8 41.4 40.9 37.0 41.9 ## [99] 35.8 42.8 38.8 42.5 42.3 37.1 34.1 37.3 34.6 36.0 37.6 37.0 39.9 35.1 ## [113] 40.0 36.2 35.5 36.1 31.5 34.0 33.1 36.8 35.4 35.5 38.0 34.8 32.0 42.3 ## [127] 39.8 37.1 35.2 32.0 40.1 39.0 35.4 37.0 39.0 42.0 33.1 43.2 39.9 35.6 ## [141] 34.2 36.3 35.2 33.7 33.9 35.1 36.7 35.3 37.5 37.4 33.5 35.5 34.3 36.0 ## [155] 37.4 36.0 36.3 36.5 36.3 35.0 33.7 35.7 36.2 35.1 34.2 33.2 36.9 36.6 ## [169] 36.2 40.6 36.9 40.7 32.0 33.7 32.3 41.3 33.9 41.4 35.4 32.7 37.5 32.4 ## [183] 33.9 37.8 38.9 38.9 34.6 32.8 39.3 33.8 39.3 35.2 40.3 41.2 37.9 36.2 ## [197] 32.8 33.1 36.7 37.9 32.9 34.0 38.0 29.8 30.7 31.3 33.4 29.6 32.5 34.0 ## [211] 33.4 33.6 34.0 33.6 32.7 32.5 33.1 33.1 31.3 30.3 34.2 29.6 34.6 33.4 ## [225] 32.8 34.8 34.1 36.3 34.0 35.3 34.4 35.5 34.2 33.9 38.6 35.8 37.1 33.9 ## [239] 34.5 33.6 33.5 36.7 34.9 33.5 37.0 36.6 34.2 37.7 35.4 38.4 33.7 32.1 ## [253] 33.8 31.4 35.5 33.7 32.2 34.7 32.8 34.3 37.9 40.3 36.0 34.9 35.9 39.5 ## [267] 41.7 40.6 36.8 37.4 38.9 35.1 42.1 40.3 36.0 38.0 34.3 35.7 42.4 34.5 ## [281] 37.4 36.5 44.1 41.4 43.6 36.0 42.8 40.4 38.9 38.5 41.3 40.5 43.2 39.9 ## [295] 37.3 42.7 38.3 40.0 44.3 33.6 32.8 33.6 39.4 35.7 42.4 39.8 34.5 35.4 ## [309] 42.4 39.2 42.7 40.3 32.7 36.4 33.5 39.2 33.2 34.8 40.2 32.3 33.9 35.3 ## [323] 34.6 37.6 37.9 34.1 36.7 31.7 34.8 36.4 35.2 35.2 34.4 34.0 32.6 37.7 ## [337] 35.1 35.2 36.7 35.1 38.3 34.9 32.5 34.0 35.5 34.8 33.6 35.5 33.6 35.0 ## [351] 33.5 35.6 33.7 35.2 35.9 35.2 34.2 37.7 39.2 38.4 38.3 35.6 40.4 36.8 ## [365] 36.5 40.5 37.8 39.7 37.0 37.8 36.3 37.5 43.8 37.1 39.6 38.9 38.3 37.3 ## [379] 33.6 38.3 37.6 37.1 37.9 33.4 34.0 39.9 40.6 33.6 37.7 37.3 38.5 34.9 ## [393] 33.6 33.4 33.8 32.4 33.4 33.9 34.3 34.2 32.9 34.3 35.5 34.1 33.8 34.5 ## [407] 35.6 34.0 33.1 34.7 32.9 33.9 34.6 35.9 33.0 36.6 35.4 35.5 31.3 35.4 ## [421] 36.8 34.8 36.4 33.6 31.8 35.5 34.0 36.2 33.4 34.7 34.8 40.1 34.6 34.7 ## [435] 35.7 33.8 35.8 38.6 33.6 35.7 39.1 38.6 34.8 36.4 38.0 36.6 34.6 41.9 ## [449] 37.6 34.2 30.5 31.9 32.6 31.6 31.7 32.0 32.2 31.2 32.7 31.7 30.9 31.9 ## [463] 30.3 31.4 32.0 30.9 29.7 31.5 31.2 32.7 35.4 37.9 38.0 33.9 37.1 37.9 ## [477] 30.7 36.1 37.2 38.2 32.7 36.7 30.2 34.6 43.0 33.3 35.3 32.9 40.3 32.6 ## [491] 39.5 39.0 38.2 38.1 40.4 40.3 39.8 38.4 38.2 38.7 36.9 38.2 35.3 38.7 ## [505] 36.6 39.0 38.2 36.8 39.5 33.4 33.5 33.5 31.6 36.7 35.6 33.3 32.8 32.7 ## [519] 33.3 34.1 34.8 32.2 34.5 34.3 33.2 33.1 33.3 33.9 34.2 36.8 38.5 38.0 ## [533] 40.2 39.1 39.4 41.6 41.1 34.7 39.3 36.0 39.5 40.3 38.5 37.8 37.8 40.2 ## [547] 33.8 37.4 32.2 30.2 30.8 32.7 32.9 29.3 30.3 31.1 30.3 29.6 31.0 31.4 ## [561] 34.3 30.7 31.3 32.7 30.7 32.3 32.3 33.4 42.3 40.2 34.2 32.9 36.5 38.9 ## [575] 33.3 32.7 33.4 38.5 32.6 32.1 34.5 32.7 37.2 33.4 34.0 34.2 34.2 33.1 ## [589] 36.4 34.1 34.5 33.9 33.6 35.0 33.0 34.1 32.8 36.0 34.6 34.1 35.8 33.3 ## [603] 34.6 34.5 36.7 38.1 37.1 36.6 36.6 35.7 34.7 35.6 37.2 35.2 36.5 35.2 ## [617] 37.6 34.5 39.1 37.9 40.2 38.2 38.2 34.3 38.8 41.3 33.2 36.9 38.9 35.3 ## [631] 39.8 35.8 36.6 35.6 36.1 34.7 32.6 34.9 34.4 37.7 40.3 36.2 35.3 34.4 ## [645] 38.3 36.9 33.9 34.5 36.3 31.4 35.5 38.3 33.8 38.3 31.1 34.5 34.4 36.7 ## [659] 35.6 39.6 LondonData &lt;- edit(LondonData) It is also possible to quickly and easily summarise the data or look at the column headers using summary(df) ## column1 column2 ## Min. : 1.00 Min. :101.0 ## 1st Qu.: 25.75 1st Qu.:125.8 ## Median : 50.50 Median :150.5 ## Mean : 50.50 Mean :150.5 ## 3rd Qu.: 75.25 3rd Qu.:175.2 ## Max. :100.00 Max. :200.0 names(LondonData) ## [1] &quot;Ward name&quot; ## [2] &quot;Old code&quot; ## [3] &quot;New code&quot; ## [4] &quot;Population - 2015&quot; ## [5] &quot;Children aged 0-15 - 2015&quot; ## [6] &quot;Working-age (16-64) - 2015&quot; ## [7] &quot;Older people aged 65+ - 2015&quot; ## [8] &quot;% All Children aged 0-15 - 2015&quot; ## [9] &quot;% All Working-age (16-64) - 2015&quot; ## [10] &quot;% All Older people aged 65+ - 2015&quot; ## [11] &quot;Mean Age - 2013&quot; ## [12] &quot;Median Age - 2013&quot; ## [13] &quot;Area - Square Kilometres&quot; ## [14] &quot;Population density (persons per sq km) - 2013&quot; ## [15] &quot;% BAME - 2011&quot; ## [16] &quot;% Not Born in UK - 2011&quot; ## [17] &quot;% English is First Language of no one in household - 2011&quot; ## [18] &quot;General Fertility Rate - 2013&quot; ## [19] &quot;Male life expectancy -2009-13&quot; ## [20] &quot;Female life expectancy -2009-13&quot; ## [21] &quot;% children in reception year who are obese - 2011/12 to 2013/14&quot; ## [22] &quot;% children in year 6 who are obese- 2011/12 to 2013/14&quot; ## [23] &quot;Rate of All Ambulance Incidents per 1,000 population - 2014&quot; ## [24] &quot;Rates of ambulance call outs for alcohol related illness - 2014&quot; ## [25] &quot;Number Killed or Seriously Injured on the roads - 2014&quot; ## [26] &quot;In employment (16-64) - 2011&quot; ## [27] &quot;Employment rate (16-64) - 2011&quot; ## [28] &quot;Number of jobs in area - 2013&quot; ## [29] &quot;Employment per head of resident WA population - 2013&quot; ## [30] &quot;Rate of new registrations of migrant workers - 2011/12&quot; ## [31] &quot;Median House Price (£) - 2014&quot; ## [32] &quot;Number of properties sold - 2014&quot; ## [33] &quot;Median Household income estimate (2012/13)&quot; ## [34] &quot;Number of Household spaces - 2011&quot; ## [35] &quot;% detached houses - 2011&quot; ## [36] &quot;% semi-detached houses - 2011&quot; ## [37] &quot;% terraced houses - 2011&quot; ## [38] &quot;% Flat, maisonette or apartment - 2011&quot; ## [39] &quot;% Households Owned - 2011&quot; ## [40] &quot;% Households Social Rented - 2011&quot; ## [41] &quot;% Households Private Rented - 2011&quot; ## [42] &quot;% dwellings in council tax bands A or B - 2015&quot; ## [43] &quot;% dwellings in council tax bands C, D or E - 2015&quot; ## [44] &quot;% dwellings in council tax bands F, G or H - 2015&quot; ## [45] &quot;Claimant rate of key out-of-work benefits (working age client group) (2014)&quot; ## [46] &quot;Claimant Rate of Housing Benefit (2015)&quot; ## [47] &quot;Claimant Rate of Employment Support Allowance - 2014&quot; ## [48] &quot;Rate of JobSeekers Allowance (JSA) Claimants - 2015&quot; ## [49] &quot;% dependent children (0-18) in out-of-work households - 2014&quot; ## [50] &quot;% of households with no adults in employment with dependent children - 2011&quot; ## [51] &quot;% of lone parents not in employment - 2011&quot; ## [52] &quot;(ID2010) - Rank of average score (within London) - 2010&quot; ## [53] &quot;(ID2010) % of LSOAs in worst 50% nationally - 2010&quot; ## [54] &quot;Average GCSE capped point scores - 2014&quot; ## [55] &quot;Unauthorised Absence in All Schools (%) - 2013&quot; ## [56] &quot;% with no qualifications - 2011&quot; ## [57] &quot;% with Level 4 qualifications and above - 2011&quot; ## [58] &quot;A-Level Average Point Score Per Student - 2013/14&quot; ## [59] &quot;A-Level Average Point Score Per Entry; 2013/14&quot; ## [60] &quot;Crime rate - 2014/15&quot; ## [61] &quot;Violence against the person rate - 2014/15&quot; ## [62] &quot;Deliberate Fires per 1,000 population - 2014&quot; ## [63] &quot;% area that is open space - 2014&quot; ## [64] &quot;Cars per household - 2011&quot; ## [65] &quot;Average Public Transport Accessibility score - 2014&quot; ## [66] &quot;% travel by bicycle to work - 2011&quot; ## [67] &quot;Turnout at Mayoral election - 2012&quot; 2.4.4 Data manipulation in R Now we have some data read into R, we need to select a small subset to work on. The first thing we will do is select just the London Boroughs to work with. If you recall, the Borough data is at the bottom of the file. 2.4.4.1 Selecting rows Your borough data will probably be found between rows 626 and 658. Therefore we will first create a subset by selecting these rows into a new data frame and then reducing that data frame to just four columns. There are a few ways of doing this: We could select just the rows we need by explicitly specifying the range of rows we need: LondonBoroughs&lt;-LondonData[626:658,] There is also a subset() function in R. You could look that up and see whether you could create a subset with that. Or, we could try a cool ‘data sciency’ way of pulling out the rows we want with the knowledge that the codes for London Boroughs start with E09 (the wards in the rest of the file start with E05). Knowing this, we can use the grep() function which can use regular expressions to match patterns in text. Let’s try it! LondonData &lt;- data.frame(LondonData) LondonBoroughs &lt;- LondonData[grep(&quot;^E09&quot;,LondonData[,3]),] Check it worked: head(LondonBoroughs) AWWMAHGAWD!!! Pretty cool hey? What that function is saying is “grep (get) me all of the rows from the London Data data frame where the text in column 3 starts with (^) E09” You will notice that you will have two rows at the top for the City of London. This is because it features twice in the data set. That’s fine, we can just drop this row from our dataset: LondonBoroughs &lt;- LondonBoroughs[2:34,] 2.4.4.2 Selecting columns LondonBoroughs&lt;-LondonBoroughs[,c(1,19,20,21)] You will have noticed the use of square brackets above –– these are very useful in R. Refer back to points 19-21 above if you can’t remember how they work. The c() function is also used here — this is the ‘combine’ function — another very useful function in R which allows arguments (in this case, column reference numbers) into a single value. 2.4.4.3 Renaming columns You will notice that the column names are slightly misleading as we are now working with boroughs rather than wards. We can rename the columns to something more appropriate using the names() function (there are various other functions for renaming columns - for example colnames() if you want to rename multiple columns: #rename the column 1 in LondonBoroughs names(LondonBoroughs)[1] &lt;- c(&quot;Borough Name&quot;) 2.4.5 Plotting plot(LondonBoroughs$Male.life.expectancy..2009.13, LondonBoroughs$X..children.in.reception.year.who.are.obese...2011.12.to.2013.14) 2.4.6 Pimp my graph! Now, of course, because this is R, we can pimp this graph using something a bit more fancy than the base graphics functions: install.packages(&quot;plotly&quot;) library(plotly) plot_ly(LondonBoroughs, x = ~Male.life.expectancy..2009.13, y = ~X..children.in.reception.year.who.are.obese...2011.12.to.2013.14, text = ~LondonBoroughs$`Borough Name`, type = &quot;scatter&quot;, mode = &quot;markers&quot;) 2.4.7 Spatial Data in R This next part of the practical applies the same principles introduced above to the much more complex problem of handling spatial data within R. In this workshop we will produce a gallery of maps using many of the plotting tools available in R. The resulting maps will not be that meaningful — the focus here is on sound visualisation with R and not sound analysis (I know one is useless without the other!). Good quality spatial analysis will come in the rest of the module. Whilst the instructions are step by step you are encouraged to start deviating from them (trying different colours for example) to get a better understanding of what we are doing. 2.4.7.1 Packages In this section we’ll require even more specialist packages, so I should probably spend some more time explaining what packages actually are! Packages are bits of code that extend R beyond the basic statistical functionality it was originally designed for. For spatial data, they enable R to process spatial data formats, carry out analysis tasks and create some of the maps that follow. Bascially, without packages, R would be very limited. With packages, you can do virtually anything! One of the issues you will come across is that packages are being continually developed and updated and unless you keep your version of R updated and your packages updated, there may be some functions and options not available to you. This can be a problem, particularly with University installations which (at best) may only get updated once a year. Therefore, apologies in advance if things don’t work as intended! In R Studio all packages can be installed and activated in the ‘Packages’ tab in the bottom-right hand window: As with everything else in R though, we can also run everything from the command line. The first package we need to install for this part of the practical is maptools –– either find and install it using the RStudio GUI or do the following: install.packages(&quot;maptools&quot;) There are a few other packages we’ll need to get to grips with. Some, like ggplot2 (one of the most influential R packages ever) are part of the tidyverse package we came across earlier. Others we will need to install for the first time. install.packages(c(&quot;OpenStreetMap&quot;, &quot;classInt&quot;, &quot;tmap&quot;)) # might also need these ones install.packages(c(&quot;RColorBrewer&quot;, &quot;sp&quot;, &quot;rgeos&quot;, &quot;tmaptools&quot;, &quot;sf&quot;, &quot;downloader&quot;, &quot;rgdal&quot;, &quot;geojsonio&quot;)) Now that the packages have been installed you will not have to repeat the above steps again (when you use your account in these cluster rooms). Open a new script and save it to your working directory as wk2_maps.r. As before, type each of the lines of code into this window and then select and use the ctrl return keys to run them. Be sure to save your script often. The first task is to load the packages we have just installed. Note, you might have some issues with the OpenStreetMap package if your installation of java on your computer doesn’t match your installation of R –– e.g. if you have installed the 64bit version of R, you also need the 64bit version of java (same with the 32bit versions) — you may also need to install the package Rcpp separately and try again. Install Java 64-bit from: https://java.com/en/download/manual.jsp #Load Packages (ignore any error messages about being built under a #different R version): library(maptools) library(RColorBrewer) library(classInt) library(OpenStreetMap) library(sp) library(rgeos) library(tmap) library(tmaptools) library(sf) library(rgdal) library(geojsonio) 2.4.7.2 Background to spatial data in R R has a very well developed ecosystem of packages for working with Spatial Data. Early pioneers like Roger Bivand and Edzer Pebesma along with various colleagues were instrumental in writing packages to interface with some powerful open source libraries for working with spatial data, such as GDAL and GEOS. These were accessed via the rgdal and rgeos packages. The maptools package by Roger Bivand, amongst other things, allowed Shapefiles to be read into R. The sp package (along with spdep) by Edzer Pebesma was very important for defining a series of classes and methods for spatial data natively in R which then allowed others to write software to work with these formats. Other packages like raster advanced the analysis of gridded spatial data, while packages like classInt and RColorbrewer facilitated the binning of data and colouring of choropleth maps. Whilst these packages were extremely important for advancing spatial data analysis in R, they were not always the most straightforward to use — making a map in R could take quite a lot of effort and they were static and visually basic. However, more recently new packages have arrived to change this. Now leaflet enables R to interface with the leaflet javascript library for online, dynamic maps. ggplot2 which was developed by Hadley Wickam and colleagues radically changed the way that people thought about and created graphical objects in R, including maps, and introduced a graphical style which has been the envy of other software to the extent that there are now libraries in Python which copy the ggplot2 style! Building on all of these, the new tmap (Thematic Map) package has changed the game completely and now enables us to read, write and manipulate spatial data and produce visually impressive and interactive maps, very easily. In parallel, the sf (Simple Features) package is helping us re-think the way that spatial data can be stored and manipulated. It’s exciting times for geographic information / spatial data science! 2.4.7.3 Making some choropleth maps Choropleth maps are thematic maps which colour areas according to some phenomenon. In our case, we are going to fill some irregular polygons (the London Boroughs) with a colour that corresponds to a particular attribute. As with all plots in R, there are multiple ways we can do this. The basic plot() function requires no data preparation but additional effort in colour selection/ adding the map key etc. qplot() and ggplot() (installed in the ggplot2 package) require some additional steps to format the spatial data but select colours and add keys etc automatically. Here, we are going to make use of the new tmap package which makes making maps very easy indeed. So one mega cool thing about R is you can read spatial data in straight from the internetz! Try this below for downloading a GeoJson file…it might take a few minutes… EW &lt;- geojsonio::geojson_read(&quot;https://opendata.arcgis.com/datasets/8edafbe3276d4b56aec60991cbddda50_4.geojson&quot;, what = &quot;sp&quot;) Or you can do a manual download from here — see point 7. Pull out London using grep and the regex wildcard for ‘start of the string’ (^) to to look for the bit of the district code that relates to London (E09) from the ‘lad15cd’ column in the data slot of our spatial polygons dataframe LondonMap &lt;- EW[grep(&quot;^E09&quot;,EW@data$lad15cd),] #plot it using the base plot function qtm(LondonMap) Of course, we can also read in our data from a shapefile stored in a local directory: #read the shapefile into a simple features object BoroughMapSF &lt;- st_read(&quot;prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) ## Reading layer `London_Borough_Excluding_MHW&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac1_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs BoroughMapSP &lt;- LondonMap #plot it very quickly usking qtm (quick thematic map) to check #it has been read in correctly qtm(BoroughMapSF) qtm(BoroughMapSP) And naturally we can convert between simple features objects and spatialPolygonsDataFrames very easily: library(methods) #check the class of BoroughMapSF class(BoroughMapSF) ## [1] &quot;sf&quot; &quot;data.frame&quot; #And check the class of BoroughMapSP class(BoroughMapSP) ## [1] &quot;SpatialPolygonsDataFrame&quot; ## attr(,&quot;package&quot;) ## [1] &quot;sp&quot; #now convert the SP object into an SF object... newSF &lt;- st_as_sf(BoroughMapSP) #and try the other way around SF to SP... newSP &lt;- as(newSF, &quot;Spatial&quot;) #simples! BoroughMapSP &lt;- as(BoroughMapSF, &quot;Spatial&quot;) 2.4.7.4 Attribute data OK, enough messing around, show us the maps!! Hold your horses, before be can create a map, we need to join some attribute data to some boundaries. Doing this on a SP object can be a bit of a pain, but I’ll show you here: #join the data to the @data slot in the SP data frame BoroughMapSP@data &lt;- data.frame(BoroughMapSP@data,LondonData[match(BoroughMapSP@data[,&quot;GSS_CODE&quot;],LondonData[,&quot;New.code&quot;]),]) #check it&#39;s joined. head(BoroughMapSP@data) Joining data is a bit more intuitive with merge(): BoroughDataMap&lt;-merge(BoroughMapSF, LondonData, by.x=&quot;GSS_CODE&quot;, by.y=&quot;New.code&quot;, no.dups = TRUE) An alternative to merge() would be to use a left_join() (like in SQL) BoroughDataMap2 &lt;- BoroughMapSF %&gt;% left_join(LondonData, by = c(&quot;GSS_CODE&quot; = &quot;New.code&quot;)) However, you would need to remove the duplicate City of London row afterwards 2.4.7.5 Making some maps If you want to learn a bit more about the sorts of things you can do with tmap, then there are 2 vignettes that you can access here — I suggest you refer to these to see the various things you can do using tmap. Here’s a quick sample though: We can create a choropleth map very quickly now using qtm() library(tmap) library(tmaptools) tmap_mode(&quot;plot&quot;) ## tmap mode set to plotting qtm(BoroughDataMap, fill = &quot;Rate.of.JobSeekers.Allowance..JSA..Claimants...2015&quot;) You can also add a basemap and some other guff, if you wish…This part of the practical originally used the following code (do not run it): tmap_mode(&quot;plot&quot;) st_transform(BoroughDataMap, 4326) london_osm &lt;- tmaptools::read_osm(BoroughDataMap, type = &quot;esri&quot;, zoom = NULL) qtm(BoroughDataMap) + tm_shape(BoroughDataMap) + tm_polygons(&quot;Rate.of.JobSeekers.Allowance..JSA..Claimants...2015&quot;, style=&quot;jenks&quot;, palette=&quot;YlOrBr&quot;, midpoint=NA, title=&quot;Rate per 1,000 people&quot;, alpha = 0.5) + tm_compass(position = c(&quot;left&quot;, &quot;bottom&quot;),type = &quot;arrow&quot;) + tm_scale_bar(position = c(&quot;left&quot;, &quot;bottom&quot;)) + tm_layout(title = &quot;Job seekers&#39; Allowance Claimants&quot;, legend.position = c(&quot;right&quot;, &quot;bottom&quot;)) However, there seems to be an issue with read_osm() that means even the example data won’t work. I’ve logged the issue on GitHub and stackexchange and will most likely get some pretty direct comments. Have a look: https://github.com/mtennekes/tmaptools/issues/17 https://stackoverflow.com/questions/57408279/parameter-error-in-tmaptools-package-read-osm-when-using-example-data/57432541#57432541 So in the mean time i’ve made a bit of a workaround that uses the packages ggmap and ggplot… You can find this later on in this practical when we cover ggplot and extra map features in (Maps with extra features). How about more than one map, perhaps using different data breaks… tm_shape(BoroughDataMap) + tm_polygons(c(&quot;Average.Public.Transport.Accessibility.score...2014&quot;, &quot;Violence.against.the.person.rate...2014.15&quot;), style=c(&quot;jenks&quot;, &quot;pretty&quot;), palette=list(&quot;YlOrBr&quot;, &quot;Purples&quot;), auto.palette.mapping=FALSE, title=c(&quot;Average Public Transport Accessibility&quot;, &quot;Violence Against the Person Rate&quot;)) You will notice that to choose the colour of the maps, I entered some codes. These are the names of colour ramps from the RColourBrewer package which comes bundled with tmap. RColorBrewer uses colour palettes available from the colorbrewer2 website which is in turn based on the work of Cynthia Brewer and colleagues at Penn State University. Cynthia brewer has carried out large amount of academic research into determining the best colour palettes for GIS applications and so we will defer to her expertise here. If you want to look at the range of colour palettes available, as we; as going to the ColorBrewer website, you can use the a little shiny app which comes bundled with tmaptools #You might need to install the shinyjs package for this to work install.packages(&quot;shinyjs&quot;) library(shinyjs) #it&#39;s possible to explicitly tell R which #package to get the function from with the :: operator... tmaptools::palette_explorer() tmap will even let you make a FRICKING INTERACTIVE MAP!!! Oh yes, we can do interactive maps…! tmap_mode(&quot;view&quot;) tm_shape(BoroughDataMap) + tm_polygons(&quot;X..children.in.year.6.who.are.obese..2011.12.to.2013.14&quot;, style=&quot;cont&quot;, palette=&quot;PuRd&quot;, midpoint=NA, title=&quot;Truffle Shuffle Intensity&quot;)+ tmap_options(max.categories = 5) ####You can even save your map as an html file tmap_save(filename = &quot;truffle.html&quot;) 2.4.7.6 Have a play around… There are loads of options for creating maps with tmap — read the vignettes that have been provided by the developers of the package and see if you can adapt the maps you have just made — or even make some alternative maps using built in data. https://cran.r-project.org/web/packages/tmap/vignettes/tmap-nutshell.html * https://cran.r-project.org/web/packages/tmap/vignettes/tmap-modes.html You should also read the reference manual on the package homepage In fact, since I wrote this the tmap package has developed quite a bit more — have a look at some of the cool examples here Have a play and see what cool shiz you can create! This is an example from the BubbleMap folder on the tmap GitHub. Don’t worry about what GitHub is we will cover that soon. # load spatial data included in the tmap package data(&quot;World&quot;, &quot;metro&quot;) # calculate annual growth rate metro$growth &lt;- (metro$pop2020 - metro$pop2010) / (metro$pop2010 * 10) * 100 # plot tm_shape(World) + tm_polygons(&quot;income_grp&quot;, palette = &quot;-Blues&quot;, title = &quot;Income class&quot;, contrast = 0.7, border.col = &quot;gray30&quot;, id = &quot;name&quot;) + tm_text(&quot;iso_a3&quot;, size = &quot;AREA&quot;, col = &quot;gray30&quot;, root=3) + tm_shape(metro) + tm_bubbles(&quot;pop2010&quot;, col = &quot;growth&quot;, border.col = &quot;black&quot;, border.alpha = 0.5, breaks = c(-Inf, 0, 2, 4, 6, Inf) , palette = &quot;-RdYlGn&quot;, title.size = &quot;Metro population (2010)&quot;, title.col = &quot;Annual growth rate (%)&quot;, id = &quot;name&quot;, popup.vars=c(&quot;pop2010&quot;, &quot;pop2020&quot;, &quot;growth&quot;)) + tm_format(&quot;World&quot;) + tm_style(&quot;gray&quot;) 2.5 Making maps using ggplot2 So as you have seen, it is possible to make very nice thematic maps with tmap. However, there are other options. The ggplot2 package is a very powerful graphics package that allows us to a huge range of sophisticated plots, including maps. The latest development version of ggplot2 has support for simple features objects with the new geom_sf class (http://ggplot2.tidyverse.org/reference/ggsf.html), which, quite frankly, is bloody brilliant! If you have not already done so, install and library the ggplot2 and rgeos packages (they should be installed automatically as part of tidyverse and tmap packages, but occasionally they need to be installed separately). Now there are two main ways in which you can construct a plot in ggplot2: qplot() and ggplot(). qplot is short for ‘Quick plot’ and can be good for producing quick charts and maps, but is perhaps less good for constructing complex layered plots. ggplot() is better for building up a plot layer by layer, e.g. ggplot()+layer1+layer2, and so this is what we will use here. The important elements of any ggplot layer are the aesthetic mappings –– aes(x,y, …) –– which tell ggplot where to place the plot objects. We can imagine a map just like a graph with all features mapping to an x and y axis. All geometry ( geom_) types in ggplot feature some kind of aesthetic mapping and these can either be declared at the plot level, e.g. (don’t run this) ggplot(data.frame, aes(x=x, y=y)) or, more flexibly at the level of the individual geom_layer(), e.g. geom_polygon(aes(x=x, y=y), data.frame) To begin our plot, we will start with the map layer –– we will generate this using the geom_sf() function in ggplot2: library(ggplot2) ggplot()+geom_sf(mapping = aes(geometry=geometry), data = BoroughDataMap)+ theme_minimal() To colour your map, then just pass the name of the variable you want to map to the fill parameter in the aesthetics: ggplot()+geom_sf(mapping = aes(geometry=geometry, fill=Median.Household.income.estimate..2012.13.), data = BoroughDataMap)+ theme_minimal() As you can see, this map looks OK, but there are a few issues with things like the colour ramp and a lack of appropriate labels. We can correct this by adding a few more layers. Firstly we can change the palette: palette1&lt;-scale_fill_continuous(low=&quot;white&quot;, high=&quot;orange&quot;, &quot;Value (£)&quot;) And some appropriate labels: labels&lt;-labs(title=&quot;Median household income estimate 2012 to 2013&quot;, x=&quot;Longitude&quot;, y=&quot;Latitude&quot;) Before plotting the all of them together: ggplot()+ geom_sf(mapping = aes(geometry=geometry, fill = Median.Household.income.estimate..2012.13.) ,data = BoroughDataMap)+ theme_minimal()+ palette1+ labels Check out this resource for more options in ggplot 2.5.1 Changing projections Now until now, we’ve not really considered how our maps have been printed to the screen. The coordinates stored in the geometry column of your sf object contain the information to enable points, lines or polygons to be drawn on the screen. The first ggplot map above could fool you into thinking the coordinate system we are using is latitude and longitude, but actually, the map coordinates are stored in British National Grid. How can we tell? You can check that the coordinate reference systems of sf or sp objects using the print function: ## class : SpatialPolygonsDataFrame ## features : 33 ## extent : 503568.2, 561957.5, 155850.8, 200933.9 (xmin, xmax, ymin, ymax) ## crs : +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 ## variables : 74 ## names : NAME, GSS_CODE, HECTARES, NONLD_AREA, ONS_INNER, SUB_2009, SUB_2006, Ward.name, Old.code, New.code, Population...2015, Children.aged.0.15...2015, Working.age..16.64....2015, Older.people.aged.65....2015, X..All.Children.aged.0.15...2015, ... ## min values : Barking and Dagenham, E09000001, 314.942, 0, F, NA, NA, Barking and Dagenham, 00AA, E09000001, 8100, 650, 6250, 1250, 8, ... ## max values : Westminster, E09000033, 15013.487, 370.619, T, NA, NA, Westminster, 00BK, E09000033, 393200, 82900, 257850, 56550, 26.1, ... ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs ## First 10 features: ## NAME GSS_CODE HECTARES NONLD_AREA ONS_INNER SUB_2009 ## 1 Kingston upon Thames E09000021 3726.117 0.000 F &lt;NA&gt; ## 2 Croydon E09000008 8649.441 0.000 F &lt;NA&gt; ## 3 Bromley E09000006 15013.487 0.000 F &lt;NA&gt; ## 4 Hounslow E09000018 5658.541 60.755 F &lt;NA&gt; ## 5 Ealing E09000009 5554.428 0.000 F &lt;NA&gt; ## 6 Havering E09000016 11445.735 210.763 F &lt;NA&gt; ## 7 Hillingdon E09000017 11570.063 0.000 F &lt;NA&gt; ## 8 Harrow E09000015 5046.330 0.000 F &lt;NA&gt; ## 9 Brent E09000005 4323.270 0.000 F &lt;NA&gt; ## 10 Barnet E09000003 8674.837 0.000 F &lt;NA&gt; ## SUB_2006 geometry ## 1 &lt;NA&gt; MULTIPOLYGON (((516401.6 16... ## 2 &lt;NA&gt; MULTIPOLYGON (((535009.2 15... ## 3 &lt;NA&gt; MULTIPOLYGON (((540373.6 15... ## 4 &lt;NA&gt; MULTIPOLYGON (((521975.8 17... ## 5 &lt;NA&gt; MULTIPOLYGON (((510253.5 18... ## 6 &lt;NA&gt; MULTIPOLYGON (((549893.9 18... ## 7 &lt;NA&gt; MULTIPOLYGON (((510599.8 19... ## 8 &lt;NA&gt; MULTIPOLYGON (((510599.8 19... ## 9 &lt;NA&gt; MULTIPOLYGON (((525201 1825... ## 10 &lt;NA&gt; MULTIPOLYGON (((524579.9 19... 2.5.1.1 Proj4 If you’re a spatial geek and you’re used to looking at London, then a quick glance at the values of the extent / bounding box (bbox) will tell you that you are working in British National Grid as the x and y values are in 6 Figures, with x values around 52000 to 55000 and y values around 15000 to 20000. The other way of telling is by looking at the coordinate reference system (CRS) value — in the files above it’s defined by the bit that says: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy “Well that’s clear as mud!” I hear you cry! Yes, not obvious is it! This is called a proj-string or proj4-string and its the proj4-string for British National Grid. You can learn what each of the bits of this mean here The proj4-string basically tells the computer where on the earth to locate the coordinates that make up the geometries in your file and what distortions to apply (i.e. if to flatten it out completely etc.) Sometimes you can download data from the web and it doesn’t have a CRS . If any boundary data you download does not have a coordinate reference system attached to it (NA is displayed in the coord. ref section), this is not a huge problem — it can be added afterwards by adding the proj4string to the file. To find the proj4-strings for a whole range of different geographic projections, use the search facility at http://spatialreference.org/ or http://epsg.io/. 2.5.1.2 EPSG Now, if you can store a whole proj4-string in your mind, you must be some kind of savant (why are you doing this course? you could make your fortune as a card-counting poker player or something!). The rest of us need something a little bit more easy to remember and for coordinate reference systems, the saviour is the European Petroleum Survey Group (EPSG) — (naturally!). Now managed and maintained by the International Association of Oil and Gas producers — EPSG codes are short numbers represent all coordinate reference systems in the world and link directly to proj4 strings. The EPSG code for British National Grid is 27700 — http://epsg.io/27700. The EPSG code for the WGS84 World Geodetic System (usually the default CRS for most spatial data) is 4326 — http://epsg.io/4326 If your boundary data doesn’t have a spatial reference system, you can read it in you can read it in and set the projection either with the full proj4 string, or, more easily, with the EPSG code: # read borough map in and explicitly set projection to British National Grid # using the EPSG string code 27700 BoroughMapSF &lt;- st_read(&quot;prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) ## Reading layer `London_Borough_Excluding_MHW&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac1_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs BoroughMapSF &lt;- st_set_crs(BoroughMapSF, 27700) #or more concisely BoroughMapSF &lt;- st_read(&quot;prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) %&gt;% st_set_crs(27700) ## Reading layer `London_Borough_Excluding_MHW&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac1_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs Another option is to use the function readOGR() from the rgdal package: BoroughMapSP &lt;- readOGR(&quot;prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) ## OGR data source with driver: ESRI Shapefile ## Source: &quot;C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac1_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&quot;, layer: &quot;London_Borough_Excluding_MHW&quot; ## with 33 features ## It has 7 fields #create a variable for the EPSG code to reference the proj4string #(EPSG codes are shorter and easier to remember than the full strings!) #and store it in a variable... UKBNG &lt;- &quot;+init=epsg:27700&quot; #now set the proj4string for your BoroughMap object #note, this will probably throw an error if your dataset already has a #CRS, this is just for demonstration... proj4string(BoroughMapSP) &lt;- CRS(UKBNG) print(BoroughMapSP) # check for new CRS ## class : SpatialPolygonsDataFrame ## features : 33 ## extent : 503568.2, 561957.5, 155850.8, 200933.9 (xmin, xmax, ymin, ymax) ## crs : +init=epsg:27700 +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 ## variables : 7 ## names : NAME, GSS_CODE, HECTARES, NONLD_AREA, ONS_INNER, SUB_2009, SUB_2006 ## min values : Barking and Dagenham, E09000001, 314.942, 0, F, NA, NA ## max values : Westminster, E09000033, 15013.487, 370.619, T, NA, NA 2.5.1.3 Reprojecting your spatial data Reprojecting your data is something that you might have to (or want to) do, on occasion. Why? Well, one example might be if you want to measure the distance of a line object, or the distance between two polygons. This can be done far more easily in a projected coordinate system like British National Grid (where the units are measured in metres) than it can a geographic coordinate system such as WGS84 (where the units are degrees). For generating maps in packages like leaflet, your maps will also need to be in WGS84, rather than British National Grid. So once your data has a coordinates system to work with, we can re-project or transform to anything we like. The most commonly used is the global latitude and longitude system (WGS84). With SP objects, this is carried out using the spTransform() function: BoroughMapSPWGS84 &lt;-spTransform(BoroughMapSP, CRS(&quot;+proj=longlat +datum=WGS84&quot;)) print(BoroughMapSPWGS84) ## class : SpatialPolygonsDataFrame ## features : 33 ## extent : -0.5103751, 0.3340155, 51.28676, 51.69187 (xmin, xmax, ymin, ymax) ## crs : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 ## variables : 7 ## names : NAME, GSS_CODE, HECTARES, NONLD_AREA, ONS_INNER, SUB_2009, SUB_2006 ## min values : Barking and Dagenham, E09000001, 314.942, 0, F, NA, NA ## max values : Westminster, E09000033, 15013.487, 370.619, T, NA, NA #transform it back again: BoroughMapSPBNG &lt;-spTransform(BoroughMapSP, CRS(UKBNG)) print(BoroughMapSPBNG) ## class : SpatialPolygonsDataFrame ## features : 33 ## extent : 503568.2, 561957.5, 155850.8, 200933.9 (xmin, xmax, ymin, ymax) ## crs : +init=epsg:27700 +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 ## variables : 7 ## names : NAME, GSS_CODE, HECTARES, NONLD_AREA, ONS_INNER, SUB_2009, SUB_2006 ## min values : Barking and Dagenham, E09000001, 314.942, 0, F, NA, NA ## max values : Westminster, E09000033, 15013.487, 370.619, T, NA, NA #You may want to create a similar variable for WGS84 latlong &lt;- &quot;+init=epsg:4326&quot; And for SF objects it’s carried out using st_transform: BoroughMapSFWGS84 &lt;- st_transform(BoroughMapSF, 4326) print(BoroughMapSFWGS84) ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -0.5103751 ymin: 51.28676 xmax: 0.3340156 ymax: 51.69187 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs ## First 10 features: ## NAME GSS_CODE HECTARES NONLD_AREA ONS_INNER SUB_2009 ## 1 Kingston upon Thames E09000021 3726.117 0.000 F &lt;NA&gt; ## 2 Croydon E09000008 8649.441 0.000 F &lt;NA&gt; ## 3 Bromley E09000006 15013.487 0.000 F &lt;NA&gt; ## 4 Hounslow E09000018 5658.541 60.755 F &lt;NA&gt; ## 5 Ealing E09000009 5554.428 0.000 F &lt;NA&gt; ## 6 Havering E09000016 11445.735 210.763 F &lt;NA&gt; ## 7 Hillingdon E09000017 11570.063 0.000 F &lt;NA&gt; ## 8 Harrow E09000015 5046.330 0.000 F &lt;NA&gt; ## 9 Brent E09000005 4323.270 0.000 F &lt;NA&gt; ## 10 Barnet E09000003 8674.837 0.000 F &lt;NA&gt; ## SUB_2006 geometry ## 1 &lt;NA&gt; MULTIPOLYGON (((-0.330679 5... ## 2 &lt;NA&gt; MULTIPOLYGON (((-0.0640212 ... ## 3 &lt;NA&gt; MULTIPOLYGON (((0.01213098 ... ## 4 &lt;NA&gt; MULTIPOLYGON (((-0.2445624 ... ## 5 &lt;NA&gt; MULTIPOLYGON (((-0.4118326 ... ## 6 &lt;NA&gt; MULTIPOLYGON (((0.1586929 5... ## 7 &lt;NA&gt; MULTIPOLYGON (((-0.4040719 ... ## 8 &lt;NA&gt; MULTIPOLYGON (((-0.4040719 ... ## 9 &lt;NA&gt; MULTIPOLYGON (((-0.1965687 ... ## 10 &lt;NA&gt; MULTIPOLYGON (((-0.1998964 ... In the SF object, you can compare the values in the geometry column with those in the original file to look at how they have changed… 2.5.2 Maps with extra features Now we can re-project our data, it frees us up to bring in, for example, different base maps and other stuff… How about adding a basemap to our map…this follows on from the earlier section (when i said read_osm() wasn’t working) and builds on what we just learned about mapping with ggplot install.packages(c(&quot;ggmap&quot;, &quot;BAMMtools&quot;)) library(ggmap) library(BAMMtools) # put into WGS84 to get basemap data BoroughDataMapWGS84&lt;-st_transform(BoroughDataMap, 4326) # bounding box of London londonbbox2 &lt;- as.vector(st_bbox(BoroughDataMapWGS84)) # use bounding box to get our basemap b &lt;- get_map(londonbbox2, maptype=&quot;roadmap&quot;, source=&quot;osm&quot;, zoom=10) plot(b) # try changing the maptype to watercolor b &lt;- get_stamenmap(londonbbox2, zoom = 10, source=&quot;osm&quot;, maptype = &quot;toner-lite&quot;) plot(b) # work out the jenks of our data, k means numnber of divisons jenks=getJenksBreaks(BoroughDataMapWGS84$Rate.of.JobSeekers.Allowance..JSA..Claimants...2015, k=5) # set the palette using colorbrewer palette1&lt;- scale_fill_distiller(type = &quot;seq&quot;, palette = &quot;YlOrBr&quot;, breaks=jenks, guide=&quot;legend&quot;) # any labels labels&lt;-labs(title=&quot;Rate per 1,000 people&quot;, x=&quot;Longitude&quot;, y=&quot;Latitude&quot;) # use the basemap then add our other data map&lt;-ggmap::ggmap(b) + geom_sf(data = BoroughDataMapWGS84, aes(geometry=geometry, fill=Rate.of.JobSeekers.Allowance..JSA..Claimants...2015), alpha=0.5, inherit.aes = FALSE)+ theme_minimal()+ palette1+ labels+ guides(fill=guide_legend(title=&quot;JSA&quot;)) plot(map) 2.5.3 Extension 2.5.3.1 Faceted plots One of the nice features of ggplot2 is its faceting function which allows you to lay out subsets of your data in different panels of a grid. See if you can create a faceted grid of London maps like the one shown below. To do this, you will need to go through several stages: You will might need to subset your data frame so that it only contains data on the same scale (you have a number of columns that counts and area, for example) –– you can show facets on different scales, but we will leave this for the time being (this code is not shown here). You will also need to make sure your subset includes a few columns of key ID information data at the beginning –– e.g. ID and geometry. You will then need to use the reshape2 package to reformat your data using the melt() function, with an argument to specify the columns where your ID data ends (all columns afterwards containing data you want to plot). Use melt to bung all of the variables into a single column on top of each other, but leave out the geometry column or it will throw an error. Make sure you know which coloumn holds the geometry.I’m only going to select 10 coloumns of data here (measure.vars=10:20)…a call something like: #warning, this is messy, but it sort-of works... library(reshape2) ## ## Attaching package: &#39;reshape2&#39; ## The following object is masked from &#39;package:tidyr&#39;: ## ## smiths library(dplyr) borough_melt &lt;- melt(BoroughDataMap,id.vars = 1:9, measure.vars = 10:20) Have a look at borough_melt now — in this circumstance i find the best way is to click on the data in the enviroment window (top right), what do you notice? #now join the geometry column back on #you will have to join it along with all of the data again. borough_melt &lt;- left_join(borough_melt,BoroughDataMap,by = c(&quot;GSS_CODE&quot; = &quot;GSS_CODE&quot;)) #here i&#39;m removing everything except the variable coloumn, #values and the geometry inforamtion borough_melt &lt;- borough_melt[,c(10:11,84)] library(tmap) library(sf) library(maptools) tmap_mode(&quot;plot&quot;) borough_melt &lt;- st_as_sf(borough_melt) qtm(borough_melt, fill = &quot;value&quot;, by = &quot;variable&quot;) or, indeed, in ggplot2 like this: ggplot()+ geom_sf(mapping = aes(geometry=geometry, fill=value), data = borough_melt)+ facet_wrap(~variable) 2.5.3.2 Interactive web maps So we created an interactive map with tmap earlier and that was pretty cool, but if we want to do even more mind-blowing stuff later on in the course, we will need to get our heads around how to do interactive maps using leaflet. Leaflet is a Java Script library for producing interactive web maps, and some enterprising coders over at RStudio have produced a package for allowing you to create your own Leaflet maps. All of the documentation for the R Leaflet package can be found here library(sf) library(sp) library(magrittr) library(classInt) library(leaflet) 2.5.3.2.1 Generating a colour ramp and palette Before we create a leaflet map, we need to specify what the breaks in our data are going to be… colours&lt;- brewer.pal(5, &quot;Blues&quot;) breaks&lt;-classIntervals(BoroughDataMap$Claimant.Rate.of.Housing.Benefit..2015., n=5, style=&quot;jenks&quot;) graphics::plot(breaks, pal=colours) So we have now created a breaks object which uses the jenks natural breaks algorithm to divide up our variable into 5 classes. You will notice that breaks is a list of 2 objects. We want only the brks bit which contains the values for the breaks summary(breaks) ## Length Class Mode ## var 34 -none- numeric ## brks 6 -none- numeric breaks &lt;- as.numeric(breaks$brks) Now we can create out leaflet interactive map. Here you will see that I am using different syntax to that which has gone before. The %&gt;% (pipe) operator is part of the magrittr package. magrittr is an entirely new way of thinking about R syntax. Read up on it if you wish, but for now it is useful to think of the pipe operator as simply meaning “then”. Do this THEN do this THEN do that. #create a new sp object from the earlier sf object #with all of our data in THEN Transform it to WGS84 #THEN convert it to SP. BoroughDataMapSP &lt;- BoroughDataMap %&gt;% st_transform(crs = 4326) %&gt;% as(&quot;Spatial&quot;) #create a colour palette using colorBin colour mapping pal &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain = BoroughDataMapSP$Claimant.Rate.of.Housing.Benefit..2015., #create bins using the breaks object from earlier bins = breaks) # now, add some polygons colour them using your colour palette, #overlay the, on top of a nice backdrop and add a legend. #Note the use of the magrittr pipe operator (%&gt;%) #check the documentation to understand how this is working… leaflet(BoroughDataMapSP) %&gt;% addPolygons(stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, color = ~pal(Claimant.Rate.of.Housing.Benefit..2015.), popup = ~NAME ) %&gt;% addProviderTiles(&quot;CartoDB.DarkMatter&quot;) %&gt;% addLegend(&quot;bottomright&quot;, pal= pal, values = ~Claimant.Rate.of.Housing.Benefit..2015., title = &quot;Housing Benefit Claimant Rate&quot;, labFormat = labelFormat(prefix = &quot;Per 1,000 people &quot;), opacity = 1 ) 2.6 Writing good R code There are some basic principles to follow when writing code Use descriptive names for variaibles so you know what they are — this can be difficult especailly if you have multiple similar variables. Comment out parts you don’t need to run using # Provide regular comments for each part of your code. As you work through this practical book you should be able to find a small description of what each part of the code does. This is good practice as it not only helps you remember what your codes does, when you inevitably forget in the future, but also lets other understand and ‘read’ your code quicker. Use indents appropriately — this again greatly helps with readability and understanding. For example, what is easier to understand…this.. map&lt;-ggmap::ggmap(b) + geom_sf(data = BoroughDataMapWGS84, aes(geometry=geometry, fill=Rate.of.JobSeekers.Allowance..JSA..Claimants...2015), alpha=0.5, inherit.aes = FALSE)+ theme_minimal()+ palette1+ labels+ guides(fill=guide_legend(title=&quot;JSA&quot;)) plot(map) or this… map&lt;-ggmap::ggmap(b) + geom_sf(data = BoroughDataMapWGS84,aes(geometry=geometry,fill=Rate.of.JobSeekers.Allowance..JSA..Claimants...2015),alpha=0.5,inherit.aes = FALSE)+theme_minimal()+palette1+labels+guides(fill=guide_legend(title=&quot;JSA&quot;)) plot(map) 2.7 Tidying data In this practical we just showed how you to load, extract and reshape data using melt, however there is a better way to tidy data. As per the R for Data Science book, tidy data is defined using the following three rules: Each variable must have its own column. Each observation must have its own row. Each value must have its own cell. But, as per the book, these three are interrelated as you can’t only adhere to two without adhering to all three. So this gives us: Put each dataset in a tibble Put each variable in a column Earlier we read in the data using: flytipping &lt;- read_csv(&quot;https://data.london.gov.uk/download/fly-tipping-incidents/536278ff-a391-4f20-bc79-9e705c9b3ec0/fly-tipping-borough.csv&quot;) But we can also do something like this to force the columns to the appopraite data types (e.g. text, numberic) flytipping1 &lt;- read_csv(&quot;https://data.london.gov.uk/download/fly-tipping-incidents/536278ff-a391-4f20-bc79-9e705c9b3ec0/fly-tipping-borough.csv&quot;, col_types = cols( code = col_character(), area = col_character(), year = col_character(), total_incidents = col_number(), total_action_taken = col_number(), warning_letters = col_number(), fixed_penalty_notices = col_number(), statutory_notices = col_number(), formal_cautions = col_number(), injunctions = col_number(), prosecutions = col_number() )) # view the data view(flytipping1) So we have a tibble with columns of each varaible (e.g. warning letters, total actions taken) where every row is a London borough. We want make sure that each observation has its own row…it doesn’t as in the first row here we have observations for total incidents and total actions taken etc…to do this we will use pivot_longer(). Make sure you have the most recent version of tidyverse if you get an error. #convert the tibble into a tidy tibble library(tidyverse) flytipping_long &lt;- flytipping1 %&gt;% pivot_longer( cols = 4:11, names_to = &quot;tipping_type&quot;, values_to = &quot;count&quot; ) # view the data view(flytipping_long) Do you see the difference…this is classed as tidy data as every variable has a column, every observation has a row and every value has a cell. You could also use this to do the same thing… #an alternative which just pulls everything out into a single table flytipping2 &lt;- flytipping1[,1:4] But my advice would be to learn how to use the tidy tools! Now let’s make it a bit more suitable for mapping with pivot_wider() by making coloumns for each year of each variable….in the original .csv we had a year coloumn that had values of 2011-2012 to 2017-2018, so if we wanted to map a specifc year we’d have to filter out the year then map. Here we can just alter the data from pivot_longer() using the year and tipping type… Note, just because the data is considered tidy doesn’t mean it is directly appropriate for mapping. It might need to be tidy for analysis, such as where we used melt() earlier on (you could replace melt() with what we’ve shown you here) but for mapping you probably want something a bit different. #pivot the tidy tibble into one that is suitable for mapping flytipping_wide &lt;- flytipping_long %&gt;% pivot_wider( id_cols = 1:2, names_from = c(year,tipping_type), names_sep = &quot;_&quot;, values_from = count ) view(flytipping_wide) But what if you were just interested in a specific varaible and wanted the coloums to be each year of the data…again using pivot_wider() widefly &lt;- flytipping2 %&gt;% pivot_wider( names_from = year, values_from = total_incidents) You could now join this to the London borough .shp and produce a map… What’s the take home from this? Basically always try to put your data into a certain format before doing further analysis on it as it will be easier for you to determine the right tools to select. 2.8 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["rasters-descriptive-statistics-and-interpolation.html", "Chapter 3 Rasters, descriptive statistics and interpolation 3.1 Learning outcomes 3.2 Recommended listening 3.3 Introduction 3.4 Part 1 rasters 3.5 Part 2 descriptive statistics 3.6 Part 3 interpolation 3.7 Auto data download 3.8 Advanced analysis 3.9 Feedback", " Chapter 3 Rasters, descriptive statistics and interpolation 3.1 Learning outcomes By the end of this practical you should be able to: Load, manipulate and interpret raster layers Observe and critique different descriptive data manipulation methods and outputs Execute interpolation of points to a raster layer Construct a methodology for comparing raster datasets 3.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy Adam — this week, from me, it’s a history lesson. 30 Years ago, two DJs started playing tunes in the other room in Heaven, just under Charing Cross Station. The night was called Rage and the DJs were called Fabio and Grooverider. Their mix of house and sped-up breakbeats was an entirely new sound that began to be called ‘Jungle’. The 30 Years of Rage album recalls some of the early tunes that helped shape an entire genre of music. Enjoy! 3.3 Introduction This practical is composed of three parts. To start with we’re going to load some global raster data into R. In the second part we extract data points (cities and towns) from this data and generate some descriptive statistics and histograms. In the final section we explore interpolation using point data. 3.4 Part 1 rasters So far we’ve only really considered vector data. Within this practical we will explore some raster data sources and processing techniques. If you recall rasters are grids of cell with individual values. There are many, many possible sources to obtain raster data from as it is the data type used for the majority (basically all) of remote sensing data. 3.4.1 WorldClim data To start with we are going to use WorldClim data — this is a dataset of free global climate layers (rasters) with a spatial resolution of between 1\\(km^2\\) and 240\\(km^2\\). Download the data from: http://worldclim.org/version2 Select any variable you want at the 5 minute second resolution. What is a 5 minute resolution i hear you ask? Well, this geographic reference system treats the globe as if it was a sphere divided into 360 equal parts called degrees. Each degree has 60 minutes and each minute has 60 seconds. Arc-seconds of latitude (horizontal lines in the globe figure below) remain almost constant whilst arc-seconds of longitude (vertical lines in the globe figure below) decrease in a trigonometric cosine-based fashion as you move towards the Earth’s poles. This causes problems as you increase or decrease latitude the longitudial lengths alter…For example at the equator (0°, such as Quito) a degree is 111.3 km whereas at 60° (such as Saint Petersburg) a degree is 55.80 km …In contrast a projected coordinate system is defined on a flat, two-dimensional plane (through projecting a spheriod onto a 2D surface) giving it constant lengths, angles and areas… Figure 3.1: This figure is taken directly from Lovelace et al. (2019) section 2.2. Illustration of vector (point) data in which location of London (the red X) is represented with reference to an origin (the blue circle). The left plot represents a geographic CRS with an origin at 0° longitude and latitude. The right plot represents a projected CRS with an origin located in the sea west of the South West Peninsula. If you are still a bit confused by coordiate reference systems then stop and take some time to have a look at the resources listed here. It is very important to understand projection systems. This is the best resources i’ve come across explaining coordiate reference systems are: https://geocompr.github.io/post/2019/crs-projections-transformations/ https://mercator.tass.com/mercator-heritage — this is the story of Mercator! Others include: https://geocompr.robinlovelace.net/spatial-class.html#vector-data https://communityhub.esriuk.com/geoxchange/2012/3/26/coordinate-systems-and-projections-for-beginners.html This YouTube video that shows the differences between geographic and projected coordinate reference systems and some limitations of ArcMap… And this great YouTube produced by SciShow shows the comporsises of different map projections Unzip and move the data to your project folder. Now load the data. We could do this individually…. library(raster) jan&lt;-raster(&quot;prac3_data/wc2.0_5m_tavg_01.tif&quot;) # have a look at the raster layer jan jan ## class : RasterLayer ## dimensions : 2160, 4320, 9331200 (nrow, ncol, ncell) ## resolution : 0.08333333, 0.08333333 (x, y) ## extent : -180, 180, -90, 90 (xmin, xmax, ymin, ymax) ## crs : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ## source : C:/Users/ucfnmac/OneDrive - University College London/Teaching/CASA0005repo/prac3_data/wc2.0_5m_tavg_01.tif ## names : wc2.0_5m_tavg_01 ## values : -46.697, 34.291 (min, max) Then have a quick look at the data plot(jan) Now we can actually see some data…here is a quick example of using the Robinson projection saved to a new variable. Don’t worry about the code, just take in that it is different to the above plot library(sf) # set the proj 4 to a new variable newproj&lt;-&quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs&quot; # get the jan raster and give it the new proj4 pr1 &lt;- projectRaster(jan, crs=newproj) plot(pr1) A better and more efficient way is to firstly list all the files stored within our directory # look in our folder, find the files that end with .tif and # provide their full filenames listfiles &lt;- list.files(&quot;prac3_data/&quot;, &quot;.tif&quot;, full.names = TRUE) #have a look at the file names listfiles ## [1] &quot;prac3_data/wc2.0_5m_tavg_01.tif&quot; &quot;prac3_data/wc2.0_5m_tavg_02.tif&quot; ## [3] &quot;prac3_data/wc2.0_5m_tavg_03.tif&quot; &quot;prac3_data/wc2.0_5m_tavg_04.tif&quot; ## [5] &quot;prac3_data/wc2.0_5m_tavg_05.tif&quot; &quot;prac3_data/wc2.0_5m_tavg_06.tif&quot; ## [7] &quot;prac3_data/wc2.0_5m_tavg_07.tif&quot; &quot;prac3_data/wc2.0_5m_tavg_08.tif&quot; ## [9] &quot;prac3_data/wc2.0_5m_tavg_09.tif&quot; &quot;prac3_data/wc2.0_5m_tavg_10.tif&quot; ## [11] &quot;prac3_data/wc2.0_5m_tavg_11.tif&quot; &quot;prac3_data/wc2.0_5m_tavg_12.tif&quot; Then load all of the data straight into a raster stack. A raster stack is a collection of raster layers with the same spatial extent and resolution. worldclimtemp &lt;- stack(listfiles) #have a look at the raster stack worldclimtemp ## class : RasterStack ## dimensions : 2160, 4320, 9331200, 12 (nrow, ncol, ncell, nlayers) ## resolution : 0.08333333, 0.08333333 (x, y) ## extent : -180, 180, -90, 90 (xmin, xmax, ymin, ymax) ## crs : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ## names : wc2.0_5m_tavg_01, wc2.0_5m_tavg_02, wc2.0_5m_tavg_03, wc2.0_5m_tavg_04, wc2.0_5m_tavg_05, wc2.0_5m_tavg_06, wc2.0_5m_tavg_07, wc2.0_5m_tavg_08, wc2.0_5m_tavg_09, wc2.0_5m_tavg_10, wc2.0_5m_tavg_11, wc2.0_5m_tavg_12 ## min values : -46.697, -44.559, -57.107, -62.996, -63.541, -63.096, -66.785, -64.600, -62.600, -54.400, -42.000, -45.340 ## max values : 34.291, 33.174, 33.904, 34.629, 36.312, 38.400, 43.036, 41.073, 36.389, 33.869, 33.518, 33.667 In the raster stack you’ll notice that under dimensions there are 12 layers (nlayers). The stack has loaded the 12 months of average temperature data for us in order. To access single layers within the stack: # access the january layer worldclimtemp[[1]] ## class : RasterLayer ## dimensions : 2160, 4320, 9331200 (nrow, ncol, ncell) ## resolution : 0.08333333, 0.08333333 (x, y) ## extent : -180, 180, -90, 90 (xmin, xmax, ymin, ymax) ## crs : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ## source : C:/Users/ucfnmac/OneDrive - University College London/Teaching/CASA0005repo/prac3_data/wc2.0_5m_tavg_01.tif ## names : wc2.0_5m_tavg_01 ## values : -46.697, 34.291 (min, max) We can also rename our layers within the stack: month &lt;- c(&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;) names(worldclimtemp) &lt;- month Now to get data for just January use our new layer name worldclimtemp$Jan ## class : RasterLayer ## dimensions : 2160, 4320, 9331200 (nrow, ncol, ncell) ## resolution : 0.08333333, 0.08333333 (x, y) ## extent : -180, 180, -90, 90 (xmin, xmax, ymin, ymax) ## crs : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ## source : C:/Users/ucfnmac/OneDrive - University College London/Teaching/CASA0005repo/prac3_data/wc2.0_5m_tavg_01.tif ## names : Jan ## values : -46.697, 34.291 (min, max) 3.4.2 Location data from a raster Using a raster stack we can extract data with a single command!! For example let’s make a dataframe of some sample sites — Australian cities/towns. site &lt;- c(&quot;Brisbane&quot;, &quot;Melbourne&quot;, &quot;Perth&quot;, &quot;Sydney&quot;, &quot;Broome&quot;, &quot;Darwin&quot;, &quot;Orange&quot;, &quot;Bunbury&quot;, &quot;Cairns&quot;, &quot;Adelaide&quot;, &quot;Gold Coast&quot;, &quot;Canberra&quot;, &quot;Newcastle&quot;, &quot;Wollongong&quot;, &quot;Logan City&quot; ) lon &lt;- c(153.03, 144.96, 115.86, 151.21, 122.23, 130.84, 149.10, 115.64, 145.77, 138.6, 153.43, 149.13, 151.78, 150.89, 153.12) lat &lt;- c(-27.47, -37.91, -31.95, -33.87, 17.96, -12.46, -33.28, -33.33, -16.92, -34.93, -28, -35.28, -32.93, -34.42, -27.64) #Put all of this inforamtion into one list samples &lt;- data.frame(site, lon, lat, row.names=&quot;site&quot;) # Extract the data from the Rasterstack for all points AUcitytemp&lt;- raster::extract(worldclimtemp, samples) Add the city names to the rows of AUcitytemp row.names(AUcitytemp)&lt;-site 3.5 Part 2 descriptive statistics Descriptive statistics provide a summary of our data, often forming the base of quantitiatve analysis leading to inferential statistics which we use to make infereces about our data (e.g. judegements of the probability that the observed difference between two datasets is not by chance) 3.5.1 Data preparation Let’s take Perth as an example. We can subset our data either using the row name: Perthtemp &lt;- subset(AUcitytemp, rownames(AUcitytemp) == &quot;Perth&quot;) Or the row location: Perthtemp &lt;- AUcitytemp[3,] 3.5.2 Histogram A histogram lets us see the frequency of distribution of our data. Make a histogram of Perth’s temperature hist(Perthtemp) Remember what we’re looking at here. The x axis is the temperature and the y is the frequency of occurrence. That’s a pretty simple histogram, let’s improve the aesthetics a bit. #define where you want the breaks in the historgram userbreak&lt;-c(8,10,12,14,16,18,20,22,24,26) hist(Perthtemp, breaks=userbreak, col=&quot;red&quot;, main=&quot;Histogram of Perth Temperature&quot;, xlab=&quot;Temperature&quot;, ylab=&quot;Frequency&quot;) Check out the histogram information R generated histinfo&lt;-hist(Perthtemp) histinfo ## $breaks ## [1] 12 14 16 18 20 22 24 26 ## ## $counts ## [1] 1 3 2 2 1 1 2 ## ## $density ## [1] 0.04166667 0.12500000 0.08333333 0.08333333 0.04166667 0.04166667 ## [7] 0.08333333 ## ## $mids ## [1] 13 15 17 19 21 23 25 ## ## $xname ## [1] &quot;Perthtemp&quot; ## ## $equidist ## [1] TRUE ## ## attr(,&quot;class&quot;) ## [1] &quot;histogram&quot; Here we have: breaks — the cut off points for the bins (or bars), we just specified these counts — the number of cells in each bin midpoints — the middle value for each bin density — the density of data per bin 3.5.3 Using more data This was still a rather basic histogram, what if we wanted to see the distribution of temperatures for the whole of Australia in Jan (from averaged WorldClim data) as opposed to just our point for Perth. First, we need to source and load a vector of Australia. Go to: https://gadm.org/download_country_v3.html and download the GeoPackage Check what layers are within a GeoPackage using: library(sf) st_layers(&quot;prac3_data/gadm36_AUS.gpkg&quot;) ## Driver: GPKG ## Available layers: ## layer_name geometry_type features fields ## 1 gadm36_AUS_0 Multi Polygon 1 2 ## 2 gadm36_AUS_1 Multi Polygon 11 10 ## 3 gadm36_AUS_2 Multi Polygon 569 13 Then read in the GeoPackage layer for the whole of Australia Ausoutline &lt;- st_read(&quot;prac3_data/gadm36_AUS.gpkg&quot;, layer=&#39;gadm36_AUS_0&#39;) ## Reading layer `gadm36_AUS_0&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac3_data\\gadm36_AUS.gpkg&#39; using driver `GPKG&#39; ## Simple feature collection with 1 feature and 2 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 112.9211 ymin: -55.11694 xmax: 159.1092 ymax: -9.142176 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs Check the layer by plotting the geometry…we could do this through… plot(Ausoutline$geom) But as the .shp is quite complex (i.e. lots of points) we can simplify it first with the rmapshaper package — install that now..if it doesn’t load (or crashes your PC) this isn’t an issue. It’s just good practice that when you load data into R you check to see what it looks like… #load the rmapshaper package library(rmapshaper) #simplify the shapefile #keep specifies the % of points #to keep ms_simplify(Ausoutline, keep=0.05) ## Simple feature collection with 1 feature and 2 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 112.9211 ymin: -54.7775 xmax: 159.1054 ymax: -9.221099 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs ## GID_0 NAME_0 geom ## 1 AUS Australia MULTIPOLYGON (((158.8517 -5... #plot the shape plot(Ausoutline$geom) This should load quicker, but for ‘publication’ or ‘best’ analysis (i.e. not just demonstrating or testing) i’d recommend using the real file to ensure you don’t simply a potentially important variable. Check out this vignette for more information about rmapshaper Next, set our map extent to the outline of Australia then crop our WorldClim dataset to it Ausarea &lt;- extent(Ausoutline) # check the extent Ausarea ## class : Extent ## xmin : 112.9211 ## xmax : 159.1092 ## ymin : -55.11694 ## ymax : -9.142176 # now crop our temp data to the extent Austemp &lt;- crop(worldclimtemp, Ausoutline) # plot the output Austemp ## class : RasterBrick ## dimensions : 551, 554, 305254, 12 (nrow, ncol, ncell, nlayers) ## resolution : 0.08333333, 0.08333333 (x, y) ## extent : 112.9167, 159.0833, -55.08333, -9.166667 (xmin, xmax, ymin, ymax) ## crs : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ## source : memory ## names : Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec ## min values : 6.360000, 6.287500, 5.554286, 4.051429, 2.542857, -0.171000, -1.945000, -1.677000, 0.677000, 3.054286, 3.842424, 5.433333 ## max values : 34.29100, 33.17400, 32.39700, 30.07200, 28.50000, 27.40000, 26.90000, 27.20000, 29.31209, 31.72000, 33.51800, 33.66700 You’ll notice that whilst we have the whole of Australia the raster hasn’t been perfectly clipped to the exact outline….the extent just specifies an extent box that will cover the whole of the shape. If want to just get raster data within the outline of the shape: exactAus=mask(Austemp, Ausoutline, na.rm=TRUE) You could also run this using the original worldclimtemp raster, however, it may take some time. I’d recommend cropping to the extent first. Both our Austemp and exactAus are raster bricks. A brick is similar to a stack except it is now stored as one file instead of a collection. Let’s re-compute our histogram for Australia in March. We could just use hist like we have done before hist(exactAus[[3]], col=&quot;red&quot;, main =&quot;March temperature&quot;) However we have a bit more control with ggplot()… 3.5.4 Histogram with ggplot We need to make our raster into a data.frame to be compatible with ggplot2 alldf=as.data.frame(exactAus) library(ggplot2) # set up the basic histogram gghist &lt;- ggplot(alldf, aes(x=Mar)) + geom_histogram(color=&quot;black&quot;, fill=&quot;white&quot;)+ labs(title=&quot;Ggplot2 histogram of Australian March temperatures&quot;, x=&quot;Temperature&quot;, y=&quot;Frequency&quot;) # add a vertical line to the hisogram showing mean tempearture gghist + geom_vline(aes(xintercept=mean(Mar, na.rm=TRUE)), color=&quot;blue&quot;, linetype=&quot;dashed&quot;, size=1)+ theme(plot.title = element_text(hjust = 0.5)) How about plotting multiple months of temperature data on the same histogram As we did in practical 2, we need to put our variaible (months) into a one coloumn using melt. We will do this based on the names of our coloumns in alldf… library(reshape2) squishdata &lt;- melt(alldf, measure.vars=names(alldf)) We could also use the functions we learnt about in Tidying data Then subset the data, selecting two months twomonths&lt;-subset(squishdata, variable==&quot;Jan&quot; | variable==&quot;Jun&quot;) Get the mean for each month we selected library(plyr) ## ------------------------------------------------------------------------- ## You have loaded plyr after dplyr - this is likely to cause problems. ## If you need functions from both plyr and dplyr, please load plyr first, then dplyr: ## library(plyr); library(dplyr) ## ------------------------------------------------------------------------- ## ## Attaching package: &#39;plyr&#39; ## The following objects are masked from &#39;package:plotly&#39;: ## ## arrange, mutate, rename, summarise ## The following objects are masked from &#39;package:dplyr&#39;: ## ## arrange, count, desc, failwith, id, mutate, rename, summarise, ## summarize ## The following object is masked from &#39;package:purrr&#39;: ## ## compact library(dplyr) meantwomonths &lt;- ddply(twomonths, &quot;variable&quot;, summarise, grp.mean=mean(value, na.rm=TRUE)) colnames(meantwomonths)[colnames(meantwomonths)==&quot;variable&quot;] &lt;- &quot;Month&quot; head(meantwomonths) ## Month grp.mean ## 1 Jan 28.11321 ## 2 Jun 14.96415 Select the colour and fill based on the variable (which is our month). The intercept is the mean we just calculated, with the lines also based on the coloumn variable. #rename the coloumn from variable to month so it looks # nice in the legend of the histogram colnames(twomonths)[colnames(twomonths)==&quot;variable&quot;] &lt;- &quot;Month&quot; ggplot(twomonths, aes(x=value, color=Month, fill=Month)) + geom_histogram(position=&quot;identity&quot;, alpha=0.5)+ geom_vline(data=meantwomonths, aes(xintercept=grp.mean, color=Month), linetype=&quot;dashed&quot;)+ labs(title=&quot;Ggplot2 histogram of Australian Jan and Jun temperatures&quot;, x=&quot;Temperature&quot;, y=&quot;Frequency&quot;)+ theme_classic()+ theme(plot.title = element_text(hjust = 0.5)) Note how i adjusted the title after i selected the theme, if i had done this before the theme defaults would have overwritten my command. Have you been getting an annoying error message about bin size and non-finate values? Me too!…Bin size defaults to 30 in ggplot2 and the non-finate values is referring to lots of NAs (no data) that we have in our dataset. In the code below i’ve selected a bin width of 5 and removed all the NAs with complete.cases and produced a faceted plot… # Remove all NAs data_complete_cases &lt;- squishdata[complete.cases(squishdata), ] # How many rows are left dim(data_complete_cases) ## [1] 1201812 2 # How many were there to start with dim(squishdata) ## [1] 3663048 2 # Plot faceted histogram ggplot(data_complete_cases, aes(x=value, na.rm=TRUE, color=variable))+ geom_histogram(color=&quot;black&quot;, binwidth = 5)+ labs(title=&quot;Ggplot2 faceted histogram of Australian temperatures&quot;, x=&quot;Temperature&quot;, y=&quot;Frequency&quot;)+ facet_grid(variable ~ .)+ theme(plot.title = element_text(hjust = 0.5)) Does this seem right to you? Well…yes. It shows that the distribution of temperature is higher (or warmer) in the Australian summer (Dec-Feb) than the rest of the year, which makes perfect sense. How about an interactive histogram using plotly… See if you can understand what is going on in the code below. Run each line seperately. library(plotly) # split the data for plotly based on month jan&lt;-subset(squishdata, variable==&quot;Jan&quot;, na.rm=TRUE) jun&lt;-subset(squishdata, variable==&quot;Jun&quot;, na.rm=TRUE) # give axis titles x &lt;- list (title = &quot;Temperature&quot;) y &lt;- list (title = &quot;Frequency&quot;) # set the bin width xbinsno&lt;-list(start=0, end=40, size = 2.5) # plot the histogram calling all the variables we just set ihist&lt;-plot_ly(alpha = 0.6) %&gt;% add_histogram(x = jan$value, xbins=xbinsno, name=&quot;January&quot;) %&gt;% add_histogram(x = jun$value, xbins=xbinsno, name=&quot;June&quot;) %&gt;% layout(barmode = &quot;overlay&quot;, xaxis=x, yaxis=y) ihist This format of code where you set lots of varaibles then call them within a plot, package or fuction is sometihng you should become more familiar with as it’s considerd good practice. If you were to go on and produce multiple plots using the same legends / aesthetics you only ahve to set them once. Ok so enough with the histograms…the point is to think about how to best display your data both effectively and efficiently. Let’s change the pace a bit and do a quickfire of other descrptive statistics you might want to use… library(dplyr) # mean per month meanofall &lt;- ddply(squishdata, &quot;variable&quot;, summarise, grp.mean=mean(value, na.rm=TRUE)) # print the top 1 head(meanofall, n=1) ## variable grp.mean ## 1 Jan 28.11321 # standard deviation per month sdofall &lt;- ddply(squishdata, &quot;variable&quot;, summarise, grp.sd=sd(value, na.rm=TRUE)) # maximum per month maxofall &lt;- ddply(squishdata, &quot;variable&quot;, summarise, grp.mx=max(value, na.rm=TRUE)) # minimum per month minofall &lt;- ddply(squishdata, &quot;variable&quot;, summarise, grp.min=min(value, na.rm=TRUE)) # Interquartlie range per month IQRofall &lt;- ddply(squishdata, &quot;variable&quot;, summarise, grp.IQR=IQR(value, na.rm=TRUE)) # perhaps you want to store multiple outputs in one list.. lotsofthem &lt;- ddply(squishdata, &quot;variable&quot;, summarise,grp.min=min(value,na.rm=TRUE), grp.mx=max(value, na.rm=TRUE)) # or you want to know the mean (or some other stat) for the whole year as opposed to each month... meanwholeyear=mean(squishdata$value, na.rm=TRUE) 3.6 Part 3 interpolation What if you had a selection of points over a spatial area but wanted to generate a complete raster. For this example, we will take our sample points (Australian cities) and estimate data between them using interpolation. If you look at our samples and AUcitytemp data the lat and lon is only in the former. We need to have this with our temperature data so let’s combine it using cbind samplestemp&lt;-cbind(AUcitytemp, samples) Now we need to tell R that our points are spatial points library(dplyr) # convert samples temp to a data frame samplestemp&lt;-as.data.frame(samplestemp) spatialpt &lt;- SpatialPoints(samplestemp[,c(&#39;lon&#39;,&#39;lat&#39;)], proj4string = crs(worldclimtemp)) spatialpt &lt;- SpatialPointsDataFrame(spatialpt, samplestemp) You’ll notice that here i’ve just nicked the CRS from our worldclimtemp. In generally it’s good practice to avoid using static or hard coding references, by that i mean if we added another coloumn to our samplestemp data (or manipulated somehow) then using this…don’t run this…. spatialpt &lt;- SpatialPoints(samplestemp[13:14], proj4string=CRS(&quot;+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 &quot;)) This would give us a headache as coloumns 13 and 14 might no longer be longitude and latitude. Right…plot the Australian geometry outline then add our spatial data points ontop… plot(Ausoutline$geom) plot(spatialpt, col=&quot;red&quot;, add=TRUE) Let’s interpolate using Inverse Distance Weighting, or IDW as it’s more commonly known. IDW is a deterministic method for multivaraite interpolation that estaimtes values for a surface using a weighted average of the provided data. The values closer to the point being predicted have more weight than those further away. The rate at which distance from the provided point imapcts the predcted point is controlled by the power of p. If p=0 then there is no decrease with distance. For more infomation see: https://pro.arcgis.com/en/pro-app/help/analysis/geostatistical-analyst/how-inverse-distance-weighted-interpolation-works.htm To get a meaningful result we could run some more calucaltions on let’s project our data to GDA94 (EPSG:3112) spatialpt &lt;- st_as_sf(spatialpt) spatialpt &lt;- st_transform(spatialpt, 3112) spatialpt&lt;-as(spatialpt, &#39;Spatial&#39;) Ausoutline&lt;-st_transform(Ausoutline, 3112) Ausoutline2&lt;-as(Ausoutline, &#39;Spatial&#39;) I’ve been a bit lazy here, if you recall from the previous practical session there are different ways to reproject data based if you have an SP or SF object. SP objects require you to specify the entire CRS string, so i just convered it to SF, used the ESPG code and converted it back to SP. The main reason for doing this is that i made a grid to store my interpolation and having a remote sensing background i wanted to specify the pixel size. The equivalent function if SF won’t let you specify pixel size or there is no easy and straightforward way to do it (at least to my knowledge). Next, create an empty grid where cellsize is the spatial resolution, cellsize will overwrite the number of pixels we specified (n). Here as we’ve used a projected CRS i’ve put a high cellsize (in metres) so 200km by 200km cells. You can use a smaller number if you wish but it will take much longer to process. emptygrd &lt;- as.data.frame(spsample(Ausoutline2, n=1000, type=&quot;regular&quot;, cellsize=200000)) names(emptygrd) &lt;- c(&quot;X&quot;, &quot;Y&quot;) coordinates(emptygrd) &lt;- c(&quot;X&quot;, &quot;Y&quot;) gridded(emptygrd) &lt;- TRUE # Create SpatialPixel object fullgrid(emptygrd) &lt;- TRUE # Create SpatialGrid object # Add the projection to the grid proj4string(emptygrd) &lt;- proj4string(spatialpt) # Interpolate the grid cells using a power value of 2 interpolate &lt;- gstat::idw(Jan ~ 1, spatialpt, newdata=emptygrd, idp=2.0) ## [inverse distance weighted interpolation] # Convert output to raster object ras &lt;- raster(interpolate) # Clip the raster to Australia outline rasmask &lt;- mask(ras, Ausoutline) # Plot the raster plot(rasmask) IDW is just one method for interpolating data, there are many more, if you are interested check out: https://mgimond.github.io/Spatial/interpolation-in-r.html 3.7 Auto data download In this practical I’ve shown you how to source the data online, download it and load it into R. However for both WorldClim and GADM we can do this straight from R using the getData function….i’m sorry for making you do it the long way, but it’s good to do things manually to see how they work. WARNING, this may take some time. I’ve changed the resolution to 10 degrees, but I’d advise not running this in the practical session. #WorldClim data has a scale factor of 10 when using getData! tmean_auto &lt;- getData(&quot;worldclim&quot;, res=10, var=&quot;tmean&quot;) tmean_auto &lt;- tmean_auto/10 Now for GADM Aus_auto &lt;- getData(&#39;GADM&#39;, country=&quot;AUS&quot;, level=0) Much more convenient right? 3.8 Advanced analysis Are you already comptent with raster analysis and R, then have a go at completing this task in the practical session. Within the practical we’ve loaded one and created one raster layer. Undertake some comparative analysis to detemrine spatial (and temporal if appropraite) differences between the rasters here and any others you may wish to create (e.g. from other interpolation methods). Try to identify where the varaitions are and explain why they are occuring. You could assume that one raster is the ‘gold standard’ meaning it’s beleived to be fully correct and compare others to it. … Or you could go further than this and obtain weather station temperature data (or any other variable) for multiple sites, interpolate based on 50% of the sites and use the remaining sites to assess the accuracy of your selected method / the WorldClim data. Free weather station data can be found here: https://rp5.ru/Weather_in_the_world Have a go and discuss with your fellow students / members of the teaching team during the practical sessions or on slack. 3.9 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["git-github-and-rmarkdown.html", "Chapter 4 Git, GitHub and RMarkdown 4.1 Learning outcomes 4.2 Recommended listening 4.3 Introduction 4.4 Set up your GitHub 4.5 Using RStudio with Git 4.6 Using Git outside RStudio 4.7 Push to Github 4.8 Pull from GitHub 4.9 Troubleshooting 4.10 Fork a repository 4.11 Branches 4.12 The other ‘easy’ way 4.13 RMarkdown 4.14 Adding references 4.15 Binder 4.16 Further reading 4.17 Feedback", " Chapter 4 Git, GitHub and RMarkdown 4.1 Learning outcomes By the end of this practical you should be able to: Explain the use of and differences between Git and GitHub Create reproduciable and open R code Produce RMarkdown documents that explain code and analysis 4.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy Adam OK, this week I’m bringing the fire — it’s my new best mate, Logistics! 4.3 Introduction In this practical you will learn how to produce work that is open, reproducible, shareable and portable using RStudio, RMarkdown, Git and GitHub. As more and more researchers and organisations publish assocaited code with their manusripts or documents it’s very imporant to become adept at using these tools. The tools you will use are: RStudio is a graphical user interface (that you should already be familiar with) — it contains a number of features which make it excellent for authoring reproducible and open geographic data science work. RMarkdown is a version of the Markdown markup language which enables plain text to be formatted to contain links to data, code to run, text to explain what you a producing and metadata to tell your software what kinds of outputs to generate from your markdown code. For more information on RMarkdown look here. Git is a software version control system which allows you to keep track of the code you produce and the changes that you or others make to it. GitHub is an online repository that allows anyone to view the code you have produced (in whatever language you choose to program in) and use/scrutinise/contribute to/comment on it. 4.4 Set up your GitHub If you are working on your own computer, you will first need to install git — https://git-scm.com/ — if you are working on the UCL Remote Desktop, you won’t need to do this as it is already installed for you. Go to http://github.com and install GitHub (if working on your own computer). Create an account and create a new repository (call it anything you like - ‘gis_code’ or something similar), making sure it is public and you check the box that says ‘initialise new repository with a README’ — click ‘create repository’ at the bottom Your new repository (‘repo’) will be created and this is where you will be able to store your code online. You will notice that a README.md markdown file has also been created. This can be edited to tell people what they are likely to find in this repository. Now you have created your repo online, you need to ‘clone’ it so that there is an identical copy of it in a local folder on your computer. There are a couple of ways of doing this, but the easy one is to use the GUI that comes packaged with your git installation. The first thing you need to do is copy the Clone URL for your repo from the github website — click the green button in your repo for ‘Clone or Download’ and copy the link: Now in the windows start menu, go to Git &gt; GUI Select ‘Clone Existing Repository’ and paste the link from your GitHub account into the top box and the local directory that you want to create to store your repo in the bottom box (note, you will need to add a name for a new folder, once you have selected an existing directory, don’t create a new folder in windows explorer you have to specify it in the file path). After a few moments, you should now be able to view a copy of your GitHub repo on your local machine. This is where you will be able to store all of your code and some other files for your reproducible research. 4.5 Using RStudio with Git Now, as I’ve mentioned before, RStudio is totally bad-ass. Not only does it make R fun to use, but the lovely people who created it also built in support for things like git! For a full and excellent tutorial on using Git with R Studio, watch this webinar If you don’t want to watch the vid, I’ll do a quick summary below. So, to use git, first you need to enable it in RStudio: At the time of writing git integration should work within RStudio. If it doesn’t try this again on your laptop. Open RStudio. In RStudio Tools &gt; Global Options, under ‘Git/SVN’ check the box to allow version control and locate the folder on your computer where the git.exe file is located. Allow Version Control for new Projects and navigate to where the git.exe file is on your computer. Click OK. Now in RStudio, you should create a new project in an existing directory — File &gt; New Project &gt; Existing directory — choose your new git repository as your new project folder. You should not see a git tab in the environment window of RStudio (top right). Note You could also link your Git directly from RStudio following: File &gt; New Project &gt; Version control &gt; Git. But carry on using these insturctions for now. Open a new R Script file in RStudio: File &gt; New R Script. Type some stuff (anything so that’s it’s not a blank empty file) at the top of the file and save it. Make sure your file is saved in your current project — mine is as i can see it in the Files window (bottom right). If not, go File &gt; Save As …into your current project You should see the files also appear under the Git tab As well as saving, which saves a copy to our local directory, we will also ‘commit’ or create a save point for our work on git. To do this, you should click the ‘Git’ icon and up will pop a menu like the one below: You can also click the Git tab that will have appeared in the top-right window of RStudio. Up will then pop another window that looks a little like the one below: Stage the changes, add a commit message so you can monitor the changes you make, then click commit Make some more changes to your file and save it. Click comitt again then in the review changes box you will be able to see what has changed within your file. Add a comitt message and click commit: 4.6 Using Git outside RStudio Sometimes RStudio Git can be a bit temperamental. For example, when staging the files they can take some time to appear with the ticked box (I think this is because we are working from the Network). A way around this in RStudio is to click the commit button, select to stage all the files, wait a few seconds then close the review changes box and commit from the buttons in the Git tab in the environment quadrant. Alternatively if you would like to use Git but you’re working on the UCL Remote Desktop or you are experiening other problems with getting git working in RStudio, fear not, you can just use your raw Git installation. In the Start Menu, open the git GUI. Start &gt; Git &gt; Git GUI. You should open the existing repository that you have just created. Whenever you have made some changes to your files in your cloned repo, you can use git to review the changes and ‘Commit’ (save) them and then ‘Push’ them up to your master repository on GitHub. To review and commit your changes, in the commit menu, simply: scan for changes stage them ready for committing commit the changes push the changes to your GitHub repo 4.7 Push to Github Now we can push our changes to github using the up arrow either in the RStudio git tab (envrionment quadrant), or from the review changes box (opens when you click commit). To do this, first make sure you have committed any changes to your local cloned repo and then click the ‘Push’ button to whizz your code up to your master GitHub repo — you will probably be prompted to enter your github username and password to enable this… But….if the push button is greyed out go to the section Greyed out push button 4.8 Pull from GitHub Pull will take any changes to the global repo and bring them into your local repo. Go to your example GitHub repo (online) and click on your test file &gt; edit this file. Add a line of code or a comment, preview the changes then commit directly to the master branch. Now in RStudio click the down arrow (Pull) request. Your file should update in RStudio. If you were to update your file on GitHub and your local one in RStudio seperately you would receive an error message in RStudio when you attempted to commit. 4.9 Troubleshooting 4.9.1 Were you challenged for your password? As of January 2019 it is possible that Git will use a credential helper provided by the operating system. So you should be asked for your GitHub username and password only once. As I am already logged into mine and I started using GitHub a while ago i’m not exactly sure when you will be asked for you details. You can however set your usename and email manually using the git prompt. Go Tools &gt; Shell and enter: git config --global user.name &#39;yourGitHubUsername&#39; git config --global user.email &#39;name@provider.com&#39; These only need to be set once. 4.9.2 Greyed out push button Is your push button greyed out? Mine was… Fear not…. First, let’s check your local repostiority (Git) is connected to a remote one (GitHub). Open the Shell again (Tools &gt; Shell) and enter: git remote -v ## output origin https://github.com/andrewmaclachlan/example.git (fetch) origin https://github.com/andrewmaclachlan/example.git (push) The fetch and push should be your repository on GitHub. If you need to set the remote repo use: git remote add origin https://github.com/andrewmaclachlanc/myrepo.git Replace my name and myrepo with your account and repo Was it setup correctly ? Yes… Then check the current branch in RStudio (and Git) is tracking a branch on the remote repo — mine wasn’t. git branch -vv ## output master 3abe929 [origin/master] test3 Origin/master shows that the local master is tracking the origin/master on the remote repo. If you can’t see origin/master then set it using: git push --set-upstream origin master For more trouble shooting on Git and GitHub have a look at the book Happy Git and GitHub for the useR 4.10 Fork a repository A Fork in github is a copy of someone elses repository. You could use it as a base starting point for your project or to make a fix and then submit a pull request to the original owner who would then pull your changes to their repository. You can fork a github example repository from: https://github.com/octocat/Spoon-Knife Once you fork it, you should see it in your repositories 4.11 Branches Each repository you make in git has a default branch but you can create new branches to isolate development of specific areas of work without affecting other branches — like a test envrionment. Go to the test repository you just forked on github. Click the branch drop down and type in the name for a new branch: Now click on the README.md file &gt; edit this file Add some changes, preview them and complete the commit changes box at the bottom of the screen. Here, we’re going to commit directly to the new branch. We could have made these changes to the master branch and then made a new branch for them at this stage. Commit the changes. Go to the home page of our example branch (click the branch down arrow and select your example branch). You’ll see that our example branch is now 1 commit ahead of the master. Now let’s create a pull reqest to the master branch. If you had modified someone else’s code, then you would send a reqest to them to pull in the changes. Here we are doing a pull request for ourselves — from our example branch to our master. Click New pull request. At the top you will see the branches that are being compared — the base defaults to githubs example repository, change it to yours. Now scroll down and you will see the comaparison of between the two branches. Click create pull request. Select squash and merge &gt; confirm squash and merge. This means that all our commits on the exmaple branch and squashed into one, as we only have one it doesn’t matter but could be useful in future. Go back to your master branch repositry and you should see the changes from the example branch have been merged. We will show you how to publish RMarkdown documents online in a later practical. 4.12 The other ‘easy’ way There is an easier way to set up Git and GitHub with your project, but this assumes you are starting fresh (with no code in an R project)! Under Set up your GitHub we made a respository on GitHub. Copy that URL. Open RStudio &gt; File New Project &gt; Version Control &gt; Git Copy in the repository URL and provide a project directory name…but it should populate when you paste in the URL Now you will be able to use Git and GitHub as per the previous instructions 4.12.1 Back in time You can go back in time with Git and revert to previous versions of files that you committed. This is a bit more invovled, so have a look at this website for more information. 4.12.2 Health warning To avoid merge conflicts be careful with your commits, pushes and pulls. Think about what you are doing each time. GitHub help pages are quite comprehensive… https://help.github.com/en/articles/resolving-a-merge-conflict-on-github 4.13 RMarkdown OK, so now you have set everything up so that you can become a reproducable research ninja! All that remains is to do some reproducable research! For the definitive guide on R Markdown, please read R Markdown: The Definitive Guide — obviously! It will tell you everything you need to know, far beyond what I am telling you here. The RMarkdown for scientists workshop by Nicholas Tierney is a really quick guide for how to use it for reproducible science. There is also an excellent guide on the R Studio website And a quick cheatsheet here And an older one here This video is also pretty good at explaining the benefits of RMarkdown R Markdown is awesome as you can show code, explanations and results within the same document!!!! Often it could be very hard to reproduce results owing to a lack of information in the methodology / userguides or walkthrougts not matching up with the latest version of software. Think back to a time where you had to use software and consult a massive userguide in how to use it…for me it was a very painful experience. R Markdown is a big improvement as it puts all of the information in the same document, which can then be convereted into a range of different formats — html for webpages, word documents, PDFs, blogs, books — virtually everything! It’s also not limited to R code!!! To change the code language all you have to do is edit what is between the {} in a code chunk (we cover in point 36). In R by default you get {r}, put for python you just change this to {python}!!! COOL. You’ve also got to have all the python software installed and the R reticulate() package too.. have a look here for more information. Now, earlier on in this exercise, I got you to open a new R Script. You now need to open a new R Markdown document, you could also select an R Notebook…They are both RMarkdown documents, the notebook originally let you run code chunks that could be exectued independently, however you can also now do this if you select a markdown file. To my knowledge the only difference is that a R Notebook adds output: html_notebook in the output option in the header of the file that adds a Preview button in the tool bar. If you don’t have this then the preview option will be replaced with Knit. But you can mix the output options in your header for the file to get the Preview button back if you wish to. Basically, there isn’t much difference and you can manually change it with one line of code. Have a look here for more infomation. For ease i’d just stick with R Markdown files There are two ways to create an RMarkdown document File &gt; New File &gt; R Markdown You can change the type in the bottom right corner of the script window…. I always use way no.1 (so use that here) and this will be populated with some example data, click Knit to see what it does…the file should load in the viewer pane, if you click the arrow and browser button it will open in an internet browser.. 4.13.1 HTML We are now going to insert some code from the practical last week into the new R Markdown document that i’ve tweaked a bit and run it…clear all of the code except the stuff between the — In RStudio, you can either select Code &gt; Insert Chunk or you can Click the ‘Insert’ button and insert an R chunk A box will appear and in this box, you will be able to enter and run your R code. Try pasting in: library(plotly) library(reshape2) library(raster) library(weathermetrics) GB_auto &lt;- raster::getData(&#39;GADM&#39;, country=&quot;GBR&quot;, level=0, #set the path to store your data in path=&#39;prac4_data/&#39;, download=TRUE) GBclim &lt;- raster::getData(&quot;worldclim&quot;, res=5, var=&quot;tmean&quot;, #set the path to store your data in path=&#39;prac4_data/&#39;, download=TRUE) month &lt;- c(&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;) names(GBclim) &lt;- month GBtemp &lt;- crop(GBclim, GB_auto) exactGB &lt;- mask(GBtemp, GB_auto) #WorldClim data has a scale factor of 10! exactGB &lt;- exactGB/10 alldf=as.data.frame(exactGB) squishdata &lt;- melt(alldf, measure.vars=names(alldf)) # split the data for plotly based on month jan&lt;-subset(squishdata, variable==&quot;Jan&quot;, na.rm=TRUE) jun&lt;-subset(squishdata, variable==&quot;Jun&quot;, na.rm=TRUE) # give axis titles x &lt;- list (title = &quot;Temperature&quot;) y &lt;- list (title = &quot;Frequency&quot;) # set the bin width xbinsno&lt;-list(start=-5, end=20, size = 2.5) # plot the histogram calling all the variables we just set ihist&lt;-plot_ly(alpha = 0.6) %&gt;% add_histogram(x = jan$value, xbins=xbinsno, name=&quot;January&quot;) %&gt;% add_histogram(x = jun$value, xbins=xbinsno, name=&quot;June&quot;) %&gt;% layout(barmode = &quot;overlay&quot;, xaxis=x, yaxis=y) ihist When including code chunks in your work, there are various options that allow you to do things like include the code, but not run it: display the output but not the code, hide warnings etc. Most of these can be input automatically by clicking the cog icon in the top-right of the chunk, or you can specify them in the code header of the chunk…if you toggle the buttons you’ll see the code change in the chunk ‘header’. There are also two useful icons to the right of the settings cog, the first will run all code above the current chunck (play symbol facing downwards) and the second will run the current code chunk (regular play symbol) 4.13.2 Flexdashboard We can also change what we knit to…how about a dashboard — this could be something like a group of related data plots or visualisations with some code and or descriptions. First you need to install the flexdashboard package and load it install.packages(&quot;flexdashboard&quot;) library(flexdashboard) To do so you change the YAML to… --- title: &quot;Untitled&quot; output: flexdashboard::flex_dashboard: runtime: flexdashboard --- Then to add coloumns for the different visualisations add the following not in a code chunk. Here we are going to have a coloumn on the left with our histogram then a coloumn on the right with 2 data plot areas which will be empty for this demonstration… This is an example of an interactive dashboard... Column {data-width=600} ------------------------------------- ### Chart 1 Then should be your code chunk from above with the histogram stuff in… Underneath the code chunk add (again not in a code chunk) Column {data-width=400} ------------------------------------- ### Chart 2 The add any code you wish (in a chunk), then to place another area beneath (still in the right hand coloumn) just add ### Chart 3 beneath the code…with all code removed it should look like this… Note that by default flexdashboard doesn’t show code…to show it you need to add echo=TRUE into the R code chunk headers or set ‘global’ code chunk options (within the first code chunk) through: knitr::opts_chunk$set(echo=TRUE) 4.13.3 Word document How about a word document? Just change the YAML to --- title: &quot;Untitled&quot; output: word_document --- I’ve also removed all the coloumn stuff from the flexdashboard…should look something like this… 4.13.4 Knit options Various other options and tips can be found in the full R Markdown guide on RStudio here: https://rmarkdown.rstudio.com/lesson-1.html https://rmarkdown.rstudio.com/lesson-3.html (for code chunk options) 4.14 Adding references This practical will focus on Mendeley, but there are guides online if you use other reference managers. 4.14.1 Set up Mendeley You need to download Mendeley (it’s free) to produce a BibTeX file. Open Mendeley (from the desktop icon) and populate it with some research papers..you should just be able to download a few .pdfs and drag them into Mendeley. Make sure the metadata (or document details) are correct by clicking this button… And editing the fields on the right…Now… Go Tools &gt; Options &gt; BibTex Select Escape LaTex special characters, enable BibTex syncing and Create a BibTex file for your whole library or per group. Select to save the BibTeX file in the same folder as your R project, otherwise R won’t be able to find it Else you can just use my BibTex file from here it’s the .bib. Warning Whilst we’ve excluded the special characters if they happen to be in some of the fields within Mendeley (e.g. abstracts) this will throw an error This method will auto sync your references to the BibTex file, which you can then load in R. 4.14.2 Add refereces into R In your document add the following to the YAML header (this is what we call the top of any RMarkdown header, enclosed by —). I beleive it stands for Yet Another Markup Language. I’ve added a few extra bits…these are pretty self-explanatory (e.g table of contents, numbered sections) but have a play around. --- title: &quot;R Notebook&quot; output: html_document: number_sections: yes theme: yeti highlight: textmate toc: yes toc_float: collapsed: no smooth_scroll: yes editor_options: chunk_output_type: inline bibliography: library.bib --- Now to cite someone just use: [@MicheleAcuto2016; @McPherson2016] Note that the name i’ve used (e.g. McPherson2016) is what Mendeley provided as the citation key for me (see the details about every document you store to find it). The complete bibliography will be placed in the last section, to add a new section to the markdown document just use # and then a space (e.g. # Last section). 4.14.3 References using citr If you don’t want to type the code above you can also add references to R using citr package… library(citr) In the ‘Addins’ menu near the top of RStudio, you should (once RStudio has been restarted) have a citr option for ‘Insert citations’ and including them in your work. 4.14.4 YAML options Information to help format your knitted file is contained in the YAML header at the top. In here, you can add things like tables of contents, apply specific themes, etc. For a selection of nice themes, see go here For things like adding Tables of Contents, tabbed sections (in HTML), figure and table parameters look here 4.14.5 Packrat Packrat is useful as it let’s you store all of your loaded packages in a folder within your project, if you were then to move or share your project someone else could load the packages you have used (and the appopraite version) permitting them to run your code with no isses and no inflence their main R package library. You can access Packrat through the icon under the Packages tab…or Tools &gt; Project Options.. This practical book is build using RStudio, but as i update the packages and content every year i haven’t used Packrat here. So go and check out the documentation for more information. 4.15 Binder Binder is a free platform that makes it possible to share code very easily. I’ve only just come across it, so i haven’t personally tried it yet. But basically you can take your RProject (that is stored on GitHub) and add a bit of extra code to it that will provide a link button (called a bage), if clicked it will then take you to an RStudio cloud workspace with all your code and data loaded, meaning someone could run your analysis with one click anywhere on any device. Fore more information have a look at: R binder blog post YouTube walkthrough R Studio conference talk on reproducible research 4.16 Further reading Since starting this little guide, I have come across this amazing book on using R and GitHub, by Jenny Bryan and Jim Hester. It’s brilliant — get involved! …Also the GitHub guide 4.17 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["map-making.html", "Chapter 5 Map making 5.1 Learning outcomes 5.2 Recommended listening 5.3 Introduction 5.4 Data 5.5 Mapping in ArcMap 5.6 QGIS 5.7 R 5.8 Bad maps 5.9 Feedback", " Chapter 5 Map making 5.1 Learning outcomes By the end of this practical you should be able to: List and explain basic mapping concepts across QGIS, ArcMap and R Interpret and manipulate data from multiple sources Create near publishable static and interactive mapped outputs Evaluate and critique mapping approaches between QGIS, ArcMap and R 5.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy 5.3 Introduction In this practical we’re going to focus on creating mapped outputs using QGIS, ArcMap and R. For fun we’re going to use data from OpenStreetMap (OSM) and Airbnb. 5.3.1 OSM OpenStreetMap is collaborative project that has created a free editable map of the World. As users can create their own content it is classed as Volunteered geographic Information (VGI). There is a lot of academic literature on VGI, it’s advnatages and disadvantages. For an overview of VGI checkout this article by Goodchild (2007). If you are interested in exploring the power of VGI and OSM further checkout missing maps. They aim to map missing places, often in less developed countires, using OSM so that when natural disasters occur first responders can make data informed decisions. They run events all over the world and it’s worth going to meet other spatial professionals, gain some experience with OSM and contribute to a good cause. 5.3.2 Airbnb Airbnb is an online marketplace that connects people looking to rent homes to those seeking accomodation often over short time periods. 5.4 Data It’s possible to download OSM data straight from the website, although the interface can be a little unreliable (it works better for small areas). There are, however, a number of websites that allow OSM data to be downloaded more easily and are directly linked to from the ‘Export’ option in OSM. Geofabrik (one of these websites) allows you to download frequently updated shapefiles for various global subdivisions. 5.4.1 OSM Go to the Geofabrik download server website Navigate to: Europe &gt; GreatBritain &gt; England &gt; Greater London Download greater-london-latest-free.shp.zip Unzip the data and save it to your current folder 5.4.2 London boroughs We’ll use our London boroughs layer again, either load it from week 1 or download it: To get the data go to: https://data.london.gov.uk/ Search for Statistical GIS Boundary Files for London Download the statistical-gis-boundaries-london.zip Unzip the data and save it to your current folder 5.5 Mapping in ArcMap 5.5.1 Load data Open a new ArcMap document Accept the defaults and click OK ArcMap ‘pro’ tip. When you do any processing within ArcMap it will try and let you contiune using the software. In practice this is pretty rubbish and nearly always crashes. You can turn this off and force the software to only work on the processing by click Geoprocessing (in the top tool bar) &gt; Geoprocessing Options then unselecting Background processing On the right hand side of the ArcMap document there should be two tabs: Catalog and Search. If they aren’t visible click Windows &gt; Catalog, next to the little x for Catalog there will be a pin symbol that will pin it to the right hand side of the screen. Do the same for Search. Search will let you find any tool in ArcMap without knowing exactly what Toolbox it is stored in. As we did in practical 1, let’s make a GeoDatabase to store out outputs. Under the Catalog tab, click on the connect to folder icon (small folder with plus sign), navigate to your current folder and select it Now in the Catalog tab you should see you folder that you connect it listed Make a new File GeoDatebase by right clicking on the folder connection… Name it what you like, but make sure it retains the .gdb extension Right click on it and make it the default GeoDatabase for the current map As we did in practical 1, store relative pathnames…File &gt; Map Document Properties &gt; Store relative pathnames to data sources Load the London boroughs shapefile using the add data button…if you are using the data from practical 1 and it’s stored in a different place you might need to make a new folder connection Load the OSM shapefiles using the add data button (pick anyone you want)… When you load the data to ArcMap you will probably be greeted with a warning… This means that the data layer we are loading (OSM) has a different CRS to the dataframe (our current map document). If you recall from practical 1, ArcMap sets the map document CRS to that of the first layer loaded. Our London boroughs layer is in British National Grid where as are OSM layers are in WGS 1984. Close the warning The OSM data will load and ArcMap is pretty clever here as it will project ‘on the fly’ which means it can display the data stored in one projection as if it were in another, but the actual data is not altered. This is both good and bad. Good as it let’s us visualise our data quickly, but bad because if we have data with different projections you will run into problems during processing. My advice is to load the data and pick a projection to do all processing in. Now load the gis_osm_pois_a_free_1 polygon.shp layer. In the search tool find the tool reproject Select the osm layer as the input, give your output a name (it should be within your GeoDatabase) and select the coordiate system. When you click on the coordiate system selection box you will see a drop down called layers, expand the drop down and you’ll see what cooridate reference systems are in use for each layer open within the map. If you expand British_National_Grid you’ll see the London boroughs layer… Click on British_National_Grid and select OK, under the Geographic Transformation a method will be automatically selected, click OK. The new layer will be added to the Map document so remove the old one. Right click on the old layer &gt; Remove 5.5.2 Manipulate data You’ll notice that some of the polygons from our OSM data fall outside the London boroughs layer, let’s sort this out. We could go right ahead and clip (like a cookie cutter) our OSM based on the outline of the London boroughs but this might cut in half some of the OSM polygons…for example: However, it’s good to think about what we are actually interested in…in this example we will explore the distribution of hotels within the London boroughs, so let’s reduce our OSM data by picking out all of the hotels. Right click on your OSM layer &gt; Open Atrtibute Table Within the attribute table click on Select by Attributes. This lets you filter based on specifc values stored within the table… Double click on fclass and it will populate the bottom box Click unqiue values to see all of the values stored within fclass Click the = sign, then click ‘hotel’ from the unique values box… Click apply… In the attribute table you will see 715 records are selected (as the OSM download updates your value might be slighly different to mine). You can toggle between all records and selected records. No we need to export our select data… Close the attrbiute tabe &gt; right click on your OSM layer &gt; Data &gt; Export Data. Make sure you are exporting only the selected features into your GeoDatabase (output feature class). Click on the folder icon to give your layer an appropriate name then save and OK Add the layer the map and either turn off or remove the OSM layer we dervied the hotels from.. Some of the hotels are still outside of the London boroughs, so let’s get rid of these through select by location Go: Selection (top tool bar) &gt; Select By Location Select featues from your OSM hotel only layer, with the source layer as London boroughs. Use the spatial selection method of: are completely within the source layer. So here we are saying only select the hotels that are within the London borough vector layer. Click apply &gt; OK Now repeat the export process and remove or turn off the original layer. As part of this analysis it might also be useful to know how much area the hotels occupy. So lets calcualte this. Open the attribute table of your OSM hotels within London boroughs vector file. You will see a shape area field, but as we are using a local CRS now the values might be slightly different so let’s recompute it. Under Table Options select Add Field, call the new field Area2 and select the type as Float. Right click the new field &gt; Calcualte Geometry select OK and yes to any warnings. Now let’s calcualte how many hotels are within each London borough and their total area… Before we can use the Spatial Join tool we need to enable some extensions in ArcMap. Click Ccustomize &gt; Extensions… and select Spatial Analyst. Save your document then close and reload it if they weren’t already selected. Using the search tool bar find the tool Spatial Join. Select the target features as the London borough vector layer and the Join Features as the OSM hotels within the London boroughs. Specify an output name (within your GeoDatabase) and leave the Join Operation as one to one. Now, in the Field Map of Join Features delete everthing except: NAME, GSS_CODE, osm_id and Area2 Right click on the osm_id and select count — this will count the number of hotel shape ids within each borough, we could have used hotel name, but i noticed that some were missing. Every feature should have an ID number, so we can capture all hotels. Now do the same for Area2 but select Sum — to total the area of hotels within each borough Select the match option as contains, click show help for more information, click OK The output has counted the number of osm_ids within each borough and summed their areas…let’s now work out the percent of each London borough covered by hotels Add a new field as we did before called percent ensuring you select Float as the type Right click the new field &gt; Field Calculator and accept the warning message Percent will equal our (Area2/Shape_Area)*100…ArcMap computed a new area field for us As expected the values are pretty small, but not to worry we can scale our map accordingly, but it’s also imporant to consider what is the best method to display data (e.g. counts, percentages) ArcMap ‘pro’ tip. If you want to see almost all the analysis that has been done within a map document open the results window through: Geoprocessing (top tool bar) &gt; Results. Ok enough playing with the data and attributes, let’s make some maps 5.5.3 Map data There are two ‘views’ in ArcMap data view (which is what we are on) and Layout view, to switch to layout view click View (top tool bar) &gt; Layout view Layout view is where we make maps to export. You should see any layers you have open (ticked) within the Layout view. Layers are stored in a dataframe, to see this in action click Insert &gt; Data Frame You should see a new dataframe appear, if you click it you can drag in around the layout view Switch back to data view…everthing has gone? That’s because you have the new data frame activated which has no data. Right click on your original data frame (mine is called layers) and select activate Head back to layout view and let’s make a thematic map of our data Right click on your current layer (hotels within London boroughs) select the Symbology tab then Quantities (in the left hand coloumn) use Join_Count (where we summed the hotels per borough) as the value and pick a colour ramp. Also experiment with the classify button under classificaiton. Once you are happy click OK. You should have something like this: How about we spice things up a bit with some more data… Let’s have a look at Air b n b data and make a map with the same scale to compare to hotels… Download the listings.csv from here for London. Have a look at the data in excel if you wish…listings.csv.gz also has much more data. Unzip the data and add it to your current working folder In ArcMap switch back to the data view and add in your original London boroughs .shp from practical 1. Now go File &gt; Add Data &gt; Add XY Data Navigate your listings.csv, select longitude as the X Field and latitude as the Y Field. You now need to change the Coordiate System of the Input…click edit, scroll up and select Geographic Coordiante Systems &gt; World &gt; WGS 1984 then click OK and click OK abou the ID warning. When you load data through add XY you need to export it to a new layer as at the moment we are still reading off the .csv. Right click on it &gt; Export Data, select an appropraite name, add it too the Map, then remove the .csv from ArcMap. Make sure you also reproject it to British National Grid — i forgot to do this and had to come back to this point when writing the practical! As before you need to select only those points within the London boroughs then compute the number of air b n bs per borough….have a go at this yourself, if you get stuck go back and revisit the previous instructions…To try and make the comparsion a bit more even (scientific!) we shall filter the air b n b data (using select by attrbiutes) for only rentals that are classed as Entire home/apt and are available 365 days of the year…the select by attriubte code would be: room_type = 'Entire home/apt' AND availability_365 = 365 Under layout view you should now have two maps Let’s now set the symbology range of each map to match. Here i’m going to take the hotel symbology range and apply it to the air b n b data. Open the Symbology of Air b n b layer and click Import then select the Import symbology from another layer…pick the hotel layer &gt; OK &gt; OK Now rearrange the data franes in the layout view. Hint: you can click and drag, resize using the corners or right click (on the data frame itself) &gt; Properties &gt; Size and Position. If you check out the Frame tab you can alter that too. You can also add ruler guides by clicking in the measurement window at the top and left of the page… To add a legend/title/North Arrow/sacle bar go Insert then select one… If you select the defaults for the legend you can then right click it and alter all the Properties. Go to Items (tab) &gt; Style select only Layer Name and Label You can change the layer names by single left clicking them in the Table of Contents… Similarly if you select the defaults for a scale bar then right click &gt; Properties and change the division units to KM and reduce the number of dvisions and subdivisions to 2 Finally we can add an inset map… Grab a UK outline (or any other that you think is appropraite). Go to GADM and download the .shp: https://gadm.org/download_country_v3.html. Extract, unzip and put it in your current working folder. Make a new data frame in your ArcMap document in data view and add in the .shp of the UK outline — there are a few in the zipped folder so work out which one you need. You’ll need to reproject it to British National Grid like we did with our other layers and save it in your GeoDatabase As you made a new data frame and the first layer you added had the CRS of WGS84 the new data frame defaulted to this, let’s change is to British National Grid for consistency. Right click anyway on the map (white space around the polygon of the UK) &gt; Data Frame Properties &gt; scroll down to layers &gt; select British National Grid. The shape of the UK should change a bit… Cool, switch back to layer view you should see your three data frames, position them how you would like on the page…the black outline you can see is an A4 page Hint If you right click on a layer you can zoom to it or use the + and - icons to position the layers how you like within each frame… You can also add city points and names if you want to. I get these proem the ArcGIS Hub. Dowlonad, unzip and put the shapefile in your current working folder. They are in the wrong CRS, so reproject and then extract only the points within the UK (select by location we used earlier). You should have a point file with 15 records… you could also filter them (select by attribute) on other coloumns (e.g. if you only wanted to show cities with a population greater than or equal to 250,000). Let’s show the names of the cities to give our inset map some context. Right click on the cities point layer &gt; Properties &gt; Labels (tab) &gt; check Label features in this layer and select the Label Field as CITY_NAME. Change the font if you wish, click OK Let’s add some text to acknowledge where we got our data from…so websites will have a statement you can copy others you can just write a statement yourself. This dones’t always have to be on the Map but should appear on the same page. Click Insert &gt; Text. The box will be very small, so move it and rezie. Double click to add some text…. To export the map go: File &gt; Export Map…but wait… there is an otpion to export only the ‘active’ part of the map (or the graphics extent), but to do so you’ll need to add a box or neatline around only what you want exported. Click Insert &gt; Neatline. Once you have it in position remove the frame. Right click on the Neatline &gt; Properties &gt; Frame (tab) change to none. 5.5.4 Export map Go File &gt; Export Map, save it as a .png and check the Clip Output to Graphics Extent button (at the very bottom of the box). Here is what my Layout view looked like And here is what my map looked like… Note there are some issues with mine…look at the inset map and how in Scotland there are more points than place names — this is beacuse my font is too large and they overlap. 5.5.5 Model builder The model builder is a visual interface which allows you to build up the elements of your model by dragging data, tools and iterators into the window…i’ll give a brief example with some of the data we have used Click on the ModelBuilder icon Model builder let’s you line all the tools we have used up and then to run them automatically….here I have got my original World_Cities .shp that needs projecting and then the points within the UK extracting… To join up the layers to the tools you can either double click on the tool and complete the fields or use the connect icon. Here i had to double click the tool to specify the new CRS. Once the model has all the required fields in changes colour, you can then validate it and run it using the tick and play button respectively. You can also save the model (Model &gt; Save As) to use later (basically you can make a tool like you have been using — such as reproject), but it must be saved within a toolbox. In the next stage i’d select all my points within the UK, however select by location isn’t available in Model Builder, instead we could use Intersect or Clip. If you wanted to use selected by attribute you could use the tool Feature Class to Feature Class and specify your SQL code. 5.6 QGIS Ok, now we’re going to reproduce our map in QIGS. As i’ve given most of the reasoning behind all the tools in the previous ArcMap section this will be more quickfire… 5.6.1 Load data Load QGIS, Open and Save a new project (Project &gt; New) Right click on GeoPackage and create a new database to store our data in .gpkg Load our data layers: London boroughs and OSM data (OSM data should be the gis_osm_pois_a_free_1 polygon layer) 5.6.2 Manipulate data Reproject the OSM data. If you scroll right in the dialogue box you’ll be able to save it into your GeoPackage. You might need to refresh the browers to see the layer. While we are working with projections…check the CRS of your map (bottom right)…mine is EPSG 4326 and we want it to be in British National Grid (which is ESPG: 27700), click on it, change it and apply. For completness also drag and drop your London boroughs .shp from the Layers window (bottom left) into your GeoPacakge. Remove the old one from the Layers window. Double click on the new London boroughs layer in the GeoPackage and it will open To get only the hotels out of our OSM data we can use extract by attrbitue…this is my tool dialogue box Refresh the browser —you have to do this everytime. Double click the layer to load it. Now extract by location using the file you just created and the London boroughs (so hotels within the London boroughs). Note that i selected that the hotels are within the Lonon boroughs Let’s now count our hotels per London borough using Join Attributes by Location (Summary). Note i selected the osm_id field to summarise using count in summaries to calcualte Next up is the Air b n b data, i’ll show you how to load it then you need to produce a count of rentals per London borough using the same rules as before (entire place/apartment and available all year). To load the data click Data Source Manager &gt; Delimited Text: You need to: * Sort the projection out and save into your .gpkg * Select by attibute (entire place and 365 days) * Select by location (within London boroughs) * Join the output to a new (or original) London borough polygon layer Note You can filter by multiple attributes using extract by expression…here we would use the expression (\"room_type\" ILIKE '%Entire home/apt%') AND (\"availability_365\" ILIKE '%365%') to filter based on entire home/apt and available 365 days of the year. 5.6.3 Map data So now you should have two London borough layers one with a count of all the hotels and the other with a count of all the air b n b properties…To make a thematic map right click on the hotel layer &gt; Symbology (tab) select Graduated and your count coloumn as the coloumn, mode as natural breaks and then classify… Now save the style so we can use it on our other layer….Style &gt; Save Style &gt; select in Database and provide a name Go to the symbology of the other layer &gt; select Graduated, select the correct count coloumn, then Style &gt; Load Style, from database and your saved style should be listed. To create a new map document in QGIS go: Project &gt; New Print Layout. The layout works by adding a new map which is a snapshop of the main QGIS document…. In the main QGIS document only select your airbnb layer, right click and zoom to it. GO back to the Print Layout &gt; Add Item &gt; Add Map..draw a sqaure…the layer should appear…In the window at the bottom right under Item Properties select to Lock layers…so now if you were to unselect that layer it would still remain on in the Print Layout Go back to your main QGIS document, now only select the hotels layer…repeat the Add Map steps and lock the layers Make sure you give the same size to both Maps…to do so click on a Map &gt; Item Properties (bottom right) scroll down, expand Position and Size, give the same width and height values Add some guides to line everything up go: View &gt; Manage Guides. The guides panel will appear in the bottom right hand corner, click the + to add a guide at a distance you specify. You can then drag your maps to snap to the guides. Add a scale bar: Add Item &gt; Add Scale Bar. To adjust it, right click &gt; Item Properties…alter some of the properties to make it look appropraite. Add a legend: Add Item &gt; Add Legend and draw a sqaure. Same process to adjust it. Untick Auto update then you can use the + and - icons to remove items along with the edit icon to change the text…this is what mine looks like… Add an arrow: Add Item &gt; Add Arrow, left click to start (twice) and right click to finish. Add text: In the left hand tool bar click add text box and draw a square Let’s add our extent map, load the UK .shp, reproject it and save it into your .gpkg. Do the same for your city points but be sure to load them into your .gpkg before you run any tool (just drag and drop them). When reprojecting you might see a lot of errors for certain points in the processing box…don’t worry British National Grid only covers the UK — these errors will be for points outside of the UK which we will remove Now replicate our ArcMap inset map by opening the Layer Properties of the new cities layer &gt; Labels &gt; Single Labels with city name, alter any of the text styles as you wish. Also play around with the symbology.. Add the new map into your map layout and move the items to appropraite locations… This is what i came up with in my map layout 5.6.4 Export map To export your map to a file go: Layout &gt; Export as Image and select crop to content…and here is my map… Note there are a few problems with my map that could be improved: (1) If you look closely at the vector layer for London you will see that one of the boroughs is missing from map (b) — this is most likely because it has no data but could easily be fixed (2) Whilst this time i’ve displayed all the city names the colour scheme needs work…for ideas on this check out colour brewer. 5.6.5 Graphical modeler As in ArcMap we can automate the methodological process in QGIS using the graphical modeler..again i’ll provide a short example here Go: Processing &gt; Graphical Modeler Graphical modeler is a bit different to model builder in ArcMap, here you drag inputs and algorthims from the inputs box (bottom left) into the model, you don’t need to specify the inputs here. When you click the run buttom (play on the top toolbar) you’ll be asked to provide the layers for the inputs. The options will be limited to those you currently have open in your map…check out the model i made to automate reprojecting cities and the UK outline, then extracting the cities within the UK outline… Make sure you save your model from the top tool bar either as a standalone model or within your project 5.7 R Your R and geogprahical are certainly improving by now, so i’m just going to provide you with the R code i used to do this analysis… 5.7.1 Static map ##Load all our data library(sf) library(tmap) library(tmaptools) library(plyr) library(tidyverse) tmap_mode(&quot;plot&quot;) OSM &lt;- st_read(&quot;prac5_data/greater-london-latest-free.shp/gis_osm_pois_a_free_1.shp&quot;) ## Reading layer `gis_osm_pois_a_free_1&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac5_data\\greater-london-latest-free.shp\\gis_osm_pois_a_free_1.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 35197 features and 4 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -0.5108706 ymin: 51.28117 xmax: 0.322123 ymax: 51.68948 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs Londonborough &lt;- st_read(&quot;Prac1_data/statistical-gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp&quot;) ## Reading layer `London_Borough_Excluding_MHW&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\Prac1_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs Airbnb &lt;- read_csv(&quot;prac5_data/listings.csv&quot;) Worldcities &lt;- st_read(&quot;prac5_data/World_Cities/World_Cities.shp&quot;) ## Reading layer `World_Cities&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac5_data\\World_Cities\\World_Cities.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 2540 features and 13 fields ## geometry type: POINT ## dimension: XY ## bbox: xmin: -176.1516 ymin: -54.792 xmax: 179.2219 ymax: 78.2 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs UK_outline &lt;- st_read(&quot;prac5_data/gadm36_GBR_shp/gadm36_GBR_0.shp&quot;) ## Reading layer `gadm36_GBR_0&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac5_data\\gadm36_GBR_shp\\gadm36_GBR_0.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 1 feature and 2 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -13.69139 ymin: 49.86542 xmax: 1.764168 ymax: 61.52708 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs # plot xy data Airbnb &lt;- st_as_sf(Airbnb, coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326) # reproject OSM &lt;- st_transform(OSM, 27700) Worldcities &lt;- st_transform(Worldcities, 27700) UK_outline &lt;- st_transform(UK_outline, 27700) Airbnb &lt;- st_transform(Airbnb, 27700) # we don&#39;t need to reproject Londonborough, but it # doesn&#39;t have a CRS..you could also use set_crs # it needs to have one for the next step Londonborough&lt;- st_transform(Londonborough, 27700) #select hotels only OSM &lt;- OSM[OSM$fclass == &#39;hotel&#39;,] Airbnb &lt;- Airbnb[Airbnb$room_type == &#39;Entire home/apt&#39; &amp; Airbnb$availability_365==&#39;365&#39;,] # make a function for the join # functions are covered in practical 7 # but see if you can work out what is going on # hint all you have to do is replace data1 and data2 # with the data you want to use Joinfun &lt;- function(data1, data2) { # join OSM and London boroughs joined &lt;- st_join(data1, data2, join = st_within) # count the number of hotels per borough countno &lt;- as.data.frame(plyr::count(joined$GSS_CODE)) # join the count back to the borough layer counted &lt;-left_join(data2, countno, by=c(&quot;GSS_CODE&quot;=&quot;x&quot;)) return(counted) } # use the function for hotels Hotels &lt;- Joinfun(OSM, Londonborough) # then for airbnb Airbnb &lt;- Joinfun(Airbnb, Londonborough) Worldcities2 &lt;- Worldcities[Worldcities$CNTRY_NAME==&#39;United Kingdom&#39;&amp; Worldcities$CITY_NAME==&#39;Birmingham&#39;| Worldcities$CITY_NAME==&#39;London&#39;| Worldcities$CITY_NAME==&#39;Edinburgh&#39;,] newbb &lt;- c(xmin=-296000, ymin=5408, xmax=655696, ymax=1000000) UK_outlinecrop=st_crop(UK_outline$geometry, newbb) # now try to arrange the plots with tmap breaks = c(0, 5, 12, 26, 57, 286) #change the column name from freq for the legend colnames(Hotels)[colnames(Hotels)==&quot;freq&quot;] &lt;- &quot;Accom count&quot; # plot each map tm1 &lt;- tm_shape(Hotels) + tm_polygons(&quot;Accom count&quot;, breaks=breaks)+ tm_legend(show=FALSE)+ tm_layout(frame=FALSE)+ tm_credits(&quot;(a)&quot;, position=c(0,0.85), size=1.5) tm2 &lt;- tm_shape(Airbnb) + tm_polygons(&quot;freq&quot;, breaks=breaks) + tm_legend(show=FALSE)+ tm_layout(frame=FALSE)+ tm_credits(&quot;(b)&quot;, position=c(0,0.85), size=1.5) tm3 &lt;- tm_shape(UK_outlinecrop)+ tm_polygons(col=&quot;darkslategray1&quot;)+ tm_layout(frame=FALSE)+ tm_shape(Worldcities2) + tm_symbols(col = &quot;red&quot;, scale = .5)+ tm_text(&quot;CITY_NAME&quot;, xmod=-1, ymod=-0.5) legend &lt;- tm_shape(Hotels) + tm_polygons(&quot;Accom count&quot;) + tm_scale_bar(position=c(0.2,0.04), text.size=0.6)+ tm_compass(north=0, position=c(0.65,0.6))+ tm_layout(legend.only = TRUE, legend.position=c(0.2,0.25),asp=0.1)+ tm_credits(&quot;(c) OpenStreetMap contrbutors and Air b n b&quot;, position=c(0.0,0.0)) t=tmap_arrange(tm1, tm2, tm3, legend, ncol=2) t We can also arrage our maps using the grid package… library(grid) grid.newpage() pushViewport(viewport(layout=grid.layout(2,2))) print(tm1, vp=viewport(layout.pos.col=1, layout.pos.row=1, height=5)) print(tm2, vp=viewport(layout.pos.col=2, layout.pos.row=1, height=5)) print(tm3, vp=viewport(layout.pos.col=1, layout.pos.row=2, height=5)) print(legend, vp=viewport(layout.pos.col=2, layout.pos.row=2, height=5)) 5.7.2 Export So how do we output our map then… tmap_save(t, &#39;hotelsandairbnbR.png&#39;) 5.7.3 Basic interactive map But could we not also make an interactive map like we did in practical 2? tmap_mode(&quot;view&quot;) tm_shape(Airbnb) + tm_polygons(&quot;freq&quot;, breaks=breaks) 5.7.4 Advanced interactive map But let’s take it a bit further so we can select our layers on an interactive map.. # library for pop up boxes library(leafpop) library(leaflet) #join data ti&lt;-st_join(Airbnb, Hotels, join = st_equals) ti&lt;-st_transform(ti,crs = 4326) #remove the geometry for our pop up boxes to avoid #the geometry field ti2 &lt;- ti st_geometry(ti2) &lt;- NULL popairbnb &lt;- popupTable(ti2, zcol=c(&quot;NAME.x&quot;, &quot;GSS_CODE.x&quot;, &quot;freq&quot;)) pophotels &lt;- popupTable(ti2, zcol=c(&quot;NAME.x&quot;, &quot;GSS_CODE.x&quot;, &quot;Accom count&quot;)) # set the colour palettes using our previously defined breaks # the colour palettes are the same using the same breaks # but different data pal &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain=ti2$freq, bins=breaks) pal2 &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain=ti2$`Accom count`, bins=breaks) map&lt;- leaflet(ti) %&gt;% # add basemap options addTiles(group = &quot;OSM (default)&quot;) %&gt;% addProviderTiles(providers$Stamen.Toner, group = &quot;Toner&quot;) %&gt;% addProviderTiles(providers$Stamen.TonerLite, group = &quot;Toner Lite&quot;) %&gt;% addProviderTiles(providers$CartoDB.Positron, group = &quot;CartoDB&quot;)%&gt;% #add our polygons, linking to the tables we just made addPolygons(color=&quot;white&quot;, weight = 2, opacity = 1, dashArray = &quot;3&quot;, popup = popairbnb, fillOpacity = 0.7, fillColor = ~pal(freq), group = &quot;Airbnb&quot;)%&gt;% addPolygons(fillColor = ~pal(`Accom count`), weight = 2, opacity = 1, color = &quot;white&quot;, dashArray = &quot;3&quot;, popup = pophotels, fillOpacity = 0.7,group = &quot;Hotels&quot;)%&gt;% # add a legend addLegend(pal = pal2, values = ~`Accom count`, group = c(&quot;Airbnb&quot;,&quot;Hotel&quot;), position =&quot;bottomleft&quot;) %&gt;% # specify layers control addLayersControl( baseGroups = c(&quot;OSM (default)&quot;, &quot;Toner&quot;, &quot;Toner Lite&quot;, &quot;CartoDB&quot;), overlayGroups = c(&quot;Airbnb&quot;, &quot;Hotels&quot;), options = layersControlOptions(collapsed = FALSE) ) # plot the map map If you want to explore Leaflet more have a look at this website 5.8 Bad maps What makes a bad map then… and what should you avoid: Poor labeling — don’t present something as an output with the file name (e.g. layer_1_osm) in the legend — name your layers properly, it’s really easy to do and makes a big difference to the quality of the map. No legend Screenshot of the map — export it properly, we’ve been doing this a while and can tell Change the values in the legend … what is aesthetically more pleasing 31.99999 or 32?. Make it as easy as possible to interpret your map. Too much data presented on one map — be selective or plot multiple maps Presented data is too small or too big — be critical about what you produce, it should be easy to read and understand A map or figure without enough detail — A reader should be able to understand a map or figure using the graphic in the figure/map and the caption alone! A long caption is fine assuming it’s all relevant information. For more cartography ideas/advice have a look at this blog post, consult axis map catography guide and check out the data is beautiful reddit. 5.9 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["analysing-spatial-patterns.html", "Chapter 6 Analysing spatial patterns 6.1 Learning outcomes 6.2 Recommended listening 6.3 Introduction 6.4 Setting up your data 6.5 Point pattern analysis 6.6 Density-based spatial clustering of applications with noise: DBSCAN 6.7 Point pattern analysis summary 6.8 Analysing Spatial Autocorrelation with Moran’s I, LISA and friends 6.9 Extension 6.10 ArcMap part 2 6.11 Feedback", " Chapter 6 Analysing spatial patterns 6.1 Learning outcomes By the end of this practical you should be able to: Describe and evaluate methods for analysing spatial patterns Execute data cleaning and manipulation appropairte for analysis Determine the locations of spatial clusters using point pattern analysis methods Investigate the degree to which values at spatial points are similar (or different) to each other 6.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy 6.3 Introduction In this practical you will learn how to begin to analyse patterns in spatial data. Using data you are already familiar with, in the first part of the practical, you will explore some techniques for analysing patterns of point data in R. Then, in the second part of the practial, you will explore spatial autocorrelation using R or ArcGIS…or both if you wish. In this analysis we will analyse the patterns of Blue Plaques — you will see these placed on around the UK linking the buildings of the present to people of the past. The question we want to answer is: “For any given London Borough, are the Blue Plaques within that borough distributed randomly or do they exhibit some kind of dispersed or clustered pattern?” To answer this question, we will make use of some of the Point Pattern Analysis functions found in the spatstat package. #first library a few packages that we will use during the practical #note you may need to install them first... library(spatstat) library(sp) library(rgeos) library(maptools) library(GISTools) library(tmap) library(sf) library(geojson) library(geojsonio) library(tmaptools) 6.4 Setting up your data Now, assuming that you’ve got a copy of your London Boroughs shapefile (from week 1) in your new week 6 folder, along with a shapefile of your Blue Plaques. If not.. read in the data from here ##First, get the London Borough Boundaries EW &lt;- geojson_read( &quot;https://opendata.arcgis.com/datasets/8edafbe3276d4b56aec60991cbddda50_4.geojson&quot;, what = &quot;sp&quot;) Pull out london using grep and the regex wildcard for’start of the string’ (^) to to look for the bit of the district code that relates to London (E09) from the ‘lad15cd’ column in the data slot of our spatial polygons dataframe BoroughMap &lt;- EW[grep(&quot;^E09&quot;,EW@data$lad15cd),] #plot it using the base plot function qtm(BoroughMap) summary(BoroughMap) ## Object of class SpatialPolygonsDataFrame ## Coordinates: ## min max ## x -0.5097014 0.3340243 ## y 51.2867587 51.6918756 ## Is projected: FALSE ## proj4string : ## [+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0] ## Data attributes: ## lad15cd lad15nm lad15nmw objectid ## E09000001: 1 Barking and Dagenham: 1 :33 Min. :294 ## E09000002: 1 Barnet : 1 Abertawe : 0 1st Qu.:302 ## E09000003: 1 Bexley : 1 Blaenau Gwent: 0 Median :310 ## E09000004: 1 Brent : 1 Bro Morgannwg: 0 Mean :310 ## E09000005: 1 Bromley : 1 Caerdydd : 0 3rd Qu.:318 ## E09000006: 1 Camden : 1 Caerffili : 0 Max. :326 ## (Other) :27 (Other) :27 (Other) : 0 ## st_lengthshape st_areashape ## Min. : 6911 Min. : 2680711 ## 1st Qu.:25477 1st Qu.: 27179391 ## Median :31190 Median : 38007465 ## Mean :32832 Mean : 48044245 ## 3rd Qu.:37693 3rd Qu.: 57363951 ## Max. :63033 Max. :150198167 ## BNG = &quot;+init=epsg:27700&quot; BoroughMapBNG &lt;- spTransform(BoroughMap,BNG) Now get the location of all Blue Plaques in the City ##Now get the location of all Blue Plaques in the City BluePlaques &lt;- geojson_read( &quot;https://s3.eu-west-2.amazonaws.com/openplaques/open-plaques-london-2018-04-08.geojson&quot;, what = &quot;sp&quot;) summary(BluePlaques) ## Object of class SpatialPointsDataFrame ## Coordinates: ## min max ## coords.x1 -0.477 0.21903 ## coords.x2 0.000 51.67830 ## Is projected: FALSE ## proj4string : ## [+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0] ## Number of points: 2812 ## Data attributes: ## id ## Min. : 1.0 ## 1st Qu.: 711.8 ## Median : 6089.0 ## Mean :10622.0 ## 3rd Qu.:10358.2 ## Max. :49190.0 ## ## inscription ## Frank Matcham (1854-1920) theatre architect designed this theatre : 3 ## Charlie Chester MBE : 2 ## Grimâ\\200\\231s Dyke : 2 ## Lillie Langtry 1852-1929 actress lived here : 2 ## &#39;Canons&#39; gate pillars\\r\\nEntrance gate piers to &#39;Canons&#39; from Old Turnpike Road\\r\\nBuilt in 1712 for James Brydges 1673-1744, 1st Duke of Chandos. House demolished 1740 and existing buildings constructed from salvaged materials. Piers refurbished 1998.: 1 ## &#39;Father&#39; Henry Willis 1821-1901 organ builder lived here : 1 ## (Other) :2801 #now set up an EPSG string to help set the projection BNG = &quot;+init=epsg:27700&quot; WGS = &quot;+init=epsg:4326&quot; BluePlaquesBNG &lt;- spTransform(BluePlaques, BNG) summary(BluePlaquesBNG) ## Object of class SpatialPointsDataFrame ## Coordinates: ## min max ## coords.x1 505575.2 622211.7 ## coords.x2 -5527598.3 199509.2 ## Is projected: TRUE ## proj4string : ## [+init=epsg:27700 +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 ## +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs ## +ellps=airy ## +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894] ## Number of points: 2812 ## Data attributes: ## id ## Min. : 1.0 ## 1st Qu.: 711.8 ## Median : 6089.0 ## Mean :10622.0 ## 3rd Qu.:10358.2 ## Max. :49190.0 ## ## inscription ## Frank Matcham (1854-1920) theatre architect designed this theatre : 3 ## Charlie Chester MBE : 2 ## Grimâ\\200\\231s Dyke : 2 ## Lillie Langtry 1852-1929 actress lived here : 2 ## &#39;Canons&#39; gate pillars\\r\\nEntrance gate piers to &#39;Canons&#39; from Old Turnpike Road\\r\\nBuilt in 1712 for James Brydges 1673-1744, 1st Duke of Chandos. House demolished 1740 and existing buildings constructed from salvaged materials. Piers refurbished 1998.: 1 ## &#39;Father&#39; Henry Willis 1821-1901 organ builder lived here : 1 ## (Other) :2801 #plot the blue plaques in the city tmap_mode(&quot;view&quot;) tm_shape(BoroughMapBNG) + tm_polygons(col = NA, alpha = 0.5) + tm_shape(BluePlaquesBNG) + tm_dots(col = &quot;blue&quot;) 6.4.1 Data cleaning Now, you might have noticed that there is at least one Blue Plaque that falls outside of the Borough boundaries. Errant plaques will cause problems with our analysis, so we need to clip the plaques to the boundaries…First we’ll remove any Plaques with the same grid reference as this will cause problems later on in the analysis.. #remove duplicates BluePlaquesBNG &lt;- remove.duplicates(BluePlaquesBNG) Now just select the points inside London - thanks to Robin Lovelace for posting how to do this one, very useful! BluePlaquesSub &lt;- BluePlaquesBNG[BoroughMapBNG,] #check to see that they&#39;ve been removed tmap_mode(&quot;view&quot;) tm_shape(BoroughMapBNG) + tm_polygons(col = NA, alpha = 0.5) + tm_shape(BluePlaquesSub) + tm_dots(col = &quot;blue&quot;) 6.4.2 Study area From this point, we could try and carry out our analysis on the whole of London, but you might be waiting until next week for Ripley’s K to be calculated for this many points. Therefore to speed things up and to enable us to compare areas within London, we will select some individual boroughs. First we need to subset our SpatialPolygonsDataFrame to pull out a borough we are interested in. I’m going to choose Harrow as I know there are few enough points for the analysis to definitely work. If you wish, feel free to choose another borough in London and run the same analysis, but beware that if it happens that there are a lot of blue plaques in your borough, the analysis could fall over!! #extract the borough Borough &lt;- BoroughMapBNG[BoroughMapBNG@data$lad15nm==&quot;Harrow&quot;,] #or as an sf object: BoroughMapBNGSF &lt;- st_as_sf(BoroughMapBNG) BoroughSF &lt;- BoroughMapBNGSF[BoroughMapBNGSF$lad15nm==&quot;Harrow&quot;,] #Check to see that the correct borough has been pulled out tm_shape(Borough) + tm_polygons(col = NA, alpha = 0.5) Next we need to clip our Blue Plaques so that we have a subset of just those that fall within the borough or interest #clip the data to our single borough BluePlaquesSub &lt;- BluePlaquesBNG[Borough,] #check that it&#39;s worked tmap_mode(&quot;view&quot;) ## tmap mode set to interactive viewing tm_shape(Borough) + tm_polygons(col = NA, alpha = 0.5) + tm_shape(BluePlaquesSub) + tm_dots(col = &quot;blue&quot;) We now have all of our data set up so that we can start the analysis using spatstat. The first thing we need to do is create an observation window for spatstat to carry out its analysis within — we’ll set this to the extent of the Harrow boundary #now set a window as the borough boundary window &lt;- as.owin(Borough) plot(window) spatstat has its own set of spatial objects that it works with (one of the delights of R is that different packages are written by different people and many have developed their own data types) — it does not work directly with the SpatialPolygonsDataFrames, SpatialPointsDataFrames or sf objects that we are used to. For point pattern analysis, we need to create a point pattern (ppp) object. #create a ppp object BluePlaquesSub.ppp &lt;- ppp(x=BluePlaquesSub@coords[,1],y=BluePlaquesSub@coords[,2],window=window) Try to understand what the different elements in command above is doing. If you are unsure, you can run elements of the code, for example: BluePlaquesSub@coords[,1] ## [1] 514971.1 512466.7 514966.0 517339.4 512215.1 515694.1 512269.5 ## [8] 511792.6 515333.7 518598.3 515370.2 512335.7 511539.4 513371.5 ## [15] 516746.3 515210.7 515093.2 515561.8 514805.8 513053.6 515166.2 ## [22] 513750.4 512508.2 516451.0 514022.4 518187.5 516725.5 513392.3 ## [29] 513008.4 517770.4 514177.1 519585.7 515300.0 514183.4 518560.0 ## [36] 512639.2 515491.4 514789.8 519099.9 512346.3 512343.2 Have a look at the new ppp object plot(BluePlaquesSub.ppp,pch=16,cex=0.5, main=&quot;Blue Plaques Harrow&quot;) 6.5 Point pattern analysis 6.5.1 Kernel Density Estimation One way to summarise your point data is to plot the density of your points under a window called a ‘Kernel’. The size and shape of the Kernel affects the density pattern produced, but it is very easy to produce a Kernel Density Estimation (KDE) map from a ppp object using the density function. plot(density(BluePlaquesSub.ppp, sigma = 500)) The sigma value sets the diameter of the Kernel (in the units your map is in — in this case, as we are in British National Grid the units are in metres). Try experimenting with different values of sigma to see how that affects the density estimate. plot(density(BluePlaquesSub.ppp, sigma = 1000)) 6.5.2 Quadrat Analysis So as you saw in the lecture, we are interesting in knowing whether the distribution of points in our study area differs from ‘complete spatial randomness’ — CSR. That’s different from a CRS! Be careful! The most basic test of CSR is a quadrat analysis. We can carry out a simple quadrat analysis on our data using the quadrat count function in spatstat. Note, I wouldn’t recommend doing a quadrat analysis in any real piece of analysis you conduct, but it is useful for starting to understand the Poisson distribution… #First plot the points plot(BluePlaquesSub.ppp,pch=16,cex=0.5, main=&quot;Blue Plaques in Harrow&quot;) #now count the points in that fall in a 6 x 6 grid overlaid across the window plot(quadratcount(BluePlaquesSub.ppp, nx = 6, ny = 6),add=T,col=&quot;red&quot;) In our case here, want to know whether or not there is any kind of spatial patterning associated with the Blue Plaques in areas of London. If you recall from the lecture, this means comparing our observed distribution of points with a statistically likely (Complete Spatial Random) distibution, based on the Poisson distribution. Using the same quadratcount function again (for the same sized grid) we can save the results into a table: #run the quadrat count Qcount&lt;-data.frame(quadratcount(BluePlaquesSub.ppp, nx = 6, ny = 6)) #put the results into a data frame QCountTable &lt;- data.frame(table(Qcount$Freq, exclude=NULL)) #view the data frame QCountTable ## Var1 Freq ## 1 0 11 ## 2 1 9 ## 3 2 3 ## 4 3 2 ## 5 4 2 ## 6 5 1 ## 7 7 1 #we don&#39;t need the last row, so remove it QCountTable &lt;- QCountTable[-nrow(QCountTable),] Check the data type in the first column - if it is factor, we will need to convert it to numeric class(QCountTable[,1]) ## [1] &quot;factor&quot; #oops, looks like it&#39;s a factor, so we need to convert it to numeric vect&lt;- as.numeric(levels(QCountTable[,1])) vect &lt;- vect[1:6] QCountTable[,1] &lt;- vect OK, so we now have a frequency table — next we need to calculate our expected values. The formula for calculating expected probabilities based on the Poisson distribution is: \\[Pr= (X =k) = \\frac{\\lambda^{k}e^{-\\lambda}}{k!}\\] #calculate the total blue plaques (Var * Freq) QCountTable$total &lt;- QCountTable[,1]*QCountTable[,2] #calculate mean sums &lt;- colSums(QCountTable[,-1]) sums ## Freq total ## 28 34 #and now calculate our mean Poisson parameter (lambda) lambda &lt;- sums[2]/sums[1] Calculate expected using the Poisson formula from above \\(k\\) is the number of blue plaques counted in a square and is found in the first column of our table… QCountTable$Pr &lt;- ((lambda^QCountTable[,1])*exp(-lambda))/factorial(QCountTable[,1]) #now calculate the expected counts and save them to the table QCountTable$Expected &lt;- round(QCountTable$Pr * sums[1],0) QCountTable ## Var1 Freq total Pr Expected ## 1 0 11 0 0.296922026 8 ## 2 1 9 9 0.360548174 10 ## 3 2 3 6 0.218904249 6 ## 4 3 2 6 0.088604101 2 ## 5 4 2 8 0.026897673 1 ## 6 5 1 5 0.006532292 0 #Compare the frequency distributions of the observed and expected point patterns plot(c(1,5),c(0,14), type=&quot;n&quot;, xlab=&quot;Number of Blue Plaques (Red=Observed, Blue=Expected)&quot;, ylab=&quot;Frequency of Occurances&quot;) points(QCountTable$Freq, col=&quot;Red&quot;, type=&quot;o&quot;, lwd=3) points(QCountTable$Expected, col=&quot;Blue&quot;, type=&quot;o&quot;, lwd=3) Comparing the observed and expected frequencies for our quadrat counts, we can observe that they both have higher frequency counts at the lower end — something reminiscent of a Poisson distribution. This could indicate that for this particular set of quadrats, our pattern is close to Complete Spatial Randomness (i.e. no clustering or dispersal of points). But how do we confirm this? To check for sure, we can use the quadrat.test function, built into spatstat. This uses a Chi Squared test to compare the observed and expected frequencies for each quadrat (rather than for quadrat bins, as we have just computed above). If the p-value of our Chi-Squared test is &gt; 0.05, then we can reject a null hyphothesis that says “there is no complete spatial randomness in our data” (think of a null-hypothesis as the opposite of a hypothesis that says our data exhibit complete spatial randomness). What we need to look for is a value for p &gt; 0.05. If our p-value is &gt; 0.05 then this indicates that we have CSR and there is no pattern in our points. If it is &lt; 0.05, this indicates that we do have clustering in our points. teststats &lt;- quadrat.test(BluePlaquesSub.ppp, nx = 6, ny = 6) teststats ## ## Chi-squared test of CSR using quadrat counts ## Pearson X2 statistic ## ## data: BluePlaquesSub.ppp ## X2 = 37.999, df = 28, p-value = 0.1968 ## alternative hypothesis: two.sided ## ## Quadrats: 29 tiles (irregular windows) plot(BluePlaquesSub.ppp,pch=16,cex=0.5, main=&quot;Blue Plaques in Harrow&quot;) plot(teststats, add=T, col = &quot;red&quot;) So we can see that the indications are there is no spatial patterning for Blue Plaques in Harrow — at least for this particular grid. Note the warning message — some of the observed counts are very small (0) and this may affect the accuracy of the quadrat test. Recall that the Poisson distribution only describes observed occurrances that are counted in integers — where our occurances = 0 (i.e. not observed), this can be an issue. We also know that there are various other problems that might affect our quadrat analysis, such as the modifiable areal unit problem. In the new plot, we can see three figures for each quadrat. The top-left figure is the observed count of points; the top-right is the Poisson expected number of points; the bottom value is the Pearson residual value, or (Observed - Expected) / Sqrt(Expected). 6.5.3 Try experimenting… Try running a quadrat analysis for different grid arrangements (2 x 2, 3 x 3, 10 x 10 etc.) — how does this affect your results? 6.5.4 Ripley’s K One way of getting around the limitations of quadrat analysis is to compare the observed distribution of points with the Poisson random model for a whole range of different distance radii. This is what Ripley’s K function computes. We can conduct a Ripley’s K test on our data very simply with the spatstat package using the kest function. K &lt;- Kest(BluePlaquesSub.ppp, correction=&quot;border&quot;) plot(K) The plot for K has a number of elements that are worth explaining. First, the Kpois(r) line in Red is the theoretical value of K for each distance window (r) under a Poisson assumption of Complete Spatial Randomness. The Black line is the estimated values of K accounting for the effects of the edge of the study area. Where the value of K falls above the line, the data appear to be clustered at that distance. Where the value of K is below the line, the data are dispersed. From the graph, we can see that up until distances of around 1300 metres, Blue Plaques appear to be clustered in Harrow, however, at around 1500 m, the distribution appears random and then dispersed between about 1600 and 2100 metres. 6.5.5 Alternatives to Ripley’s K There are a number of alternative measures of spatial clustering which can be computed in spatstat such as the G and the L functions — I won’t go into them now, but if you are interested, you should delve into the following references: Bivand, R. S., Pebesma, E. J., &amp; Gómez-Rubio, V. (2008). “Applied spatial data analysis with R.” New York: Springer. Brundson, C., Comber, L., (2015) “An Introduction to R for Spatial Analysis &amp; Mapping”. Sage. https://research.csiro.au/software/wp-content/uploads/sites/6/2015/02/Rspatialcourse_CMIS_PDF-Standard.pdf 6.6 Density-based spatial clustering of applications with noise: DBSCAN Quadrat and Ripley’s K analysis are useful exploratory techniques for telling us if we have spatial clusters present in our point data, but they are not able to tell us WHERE in our area of interest the clusters are occurring. To discover this we need to use alternative techniques. One popular technique for discovering clusters in space (be this physical space or variable space) is DBSCAN. For the complete overview of the DBSCAN algorithm, read the original paper by Ester et al. (1996) or consult the wikipedia page library(raster) library(fpc) library(plyr) library(OpenStreetMap) We will now carry out a DBSCAN analysis of blue plaques in my borough to see if there are any clusters present. #first check the coordinate reference system of the Harrow spatial polygon: crs(Borough) ## CRS arguments: ## +init=epsg:27700 +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 ## +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs ## +ellps=airy ## +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 DBSCAN requires you to input two parameters: 1. Epsilon - this is the radius within which the algorithm with search for clusters 2. MinPts - this is the minimum number of points that should be considered a cluster Based on the results of the Ripley’s K analysis earlier, we can see that we are getting clustering up to a radius of around 1200m, with the largest bulge in the graph at around 700m. Therefore, 700m is probably a good place to start and we will begin by searching for clusters of at least 4 points… #first extract the points from the spatial points data frame BluePlaquesSubPoints &lt;- data.frame(BluePlaquesSub@coords[,1:2]) #now run the dbscan analysis db &lt;- fpc::dbscan(BluePlaquesSubPoints, eps = 700, MinPts = 4) #now plot the results plot(db, BluePlaquesSubPoints, main = &quot;DBSCAN Output&quot;, frame = F) plot(Borough, add=T) You could also use kNNdistplot() from the dbscan pacakge to find a suitable eps value based on the ‘knee’ in the plot… # used to find suitable eps value based on the knee in plot # k is no of nearest neighbours used, use min points library(dbscan) dbscan::kNNdistplot(BluePlaquesSubPoints, k = 4) So the DBSCAN analysis shows that for these values of eps and MinPts there are three clusters in the area I am analysing. Try varying eps and MinPts to see what difference it makes to the output. Now of course the plot above is a little basic and doesn’t look very aesthetically pleasing. As this is R and R is brilliant, we can always produce a much nicer plot by extracting the useful information from the DBSCAN output and use ggplot2 to produce a much cooler map… library(ggplot2) Our new db object contains lots of info including the cluster each set of point coordinates belongs to, whether the point is a seed point or a border point etc. We can get a summary by just calling the object db ## dbscan Pts=41 MinPts=4 eps=700 ## 0 1 2 3 4 ## border 17 0 1 3 4 ## seed 0 8 6 1 1 ## total 17 8 7 4 5 If you open up the object in the environment window in RStudio, you will also see the various slots in the object, including cluster db$cluster ## [1] 2 1 2 0 1 0 1 0 2 3 2 1 0 4 0 2 0 0 0 4 2 4 1 0 4 3 0 4 0 0 0 0 2 0 3 ## [36] 1 0 0 3 1 1 We can now add this cluster membership info back into our dataframe BluePlaquesSubPoints$cluster &lt;- db$cluster Next we are going to create some convex hull polygons to wrap around the points in our clusters. Use the ddply function in the plyr package to get the convex hull coordinates from the cluster groups in our dataframe chulls &lt;- ddply(BluePlaquesSubPoints, .(cluster), function(df) df[chull(df$coords.x1, df$coords.x2), ]) As 0 isn’t actually a cluster (it’s all points that aren’t in a cluster) drop it from the dataframe chulls &lt;- subset(chulls, cluster&gt;=1) Now create a ggplot2 object from our data dbplot &lt;- ggplot(data=BluePlaquesSubPoints, aes(coords.x1,coords.x2, colour=cluster, fill=cluster)) #add the points in dbplot &lt;- dbplot + geom_point() #now the convex hulls dbplot &lt;- dbplot + geom_polygon(data = chulls, aes(coords.x1,coords.x2, group=cluster), alpha = 0.5) #now plot, setting the coordinates to scale correctly and as a black and white plot #(just for the hell of it)... dbplot + theme_bw() + coord_equal() Now we are getting there, but wouldn’t it be better to add a basemap?! ###add a basemap ##First get the bbox in lat long for Harrow latlong &lt;- &quot;+init=epsg:4326&quot; BoroughWGS &lt;-spTransform(Borough, CRS(latlong)) BoroughWGS@bbox ## min max ## x -0.4040502 -0.2671315 ## y 51.5549876 51.6405356 Now convert the basemap to British National Grid basemap&lt;-openmap(c(51.5530613,-0.4040719),c(51.6405318,-0.2671556), zoom=NULL,&quot;stamen-toner&quot;) # convert the basemap to British National Grid - remember we created the # BNG object right at the beginning of the practical - it&#39;s an epsg string... basemap_bng&lt;-openproj(basemap, projection=BNG) Now we can plot our fancy map with the clusters on… autoplot(basemap_bng) + geom_point(data=BluePlaquesSubPoints, aes(coords.x1,coords.x2, colour=cluster, fill=cluster)) + geom_polygon(data = chulls, aes(coords.x1,coords.x2, group=cluster, fill=cluster), alpha = 0.5) 6.7 Point pattern analysis summary This is end of the point pattern analysis section of the practical. You have been introduced to the basics of Point Pattern Analysis examining the distribution of Blue Plaques in a London Borough. At this point, you may wish to try running similar analyses on different boroughs (or indeed the whole city) and playing with some of the outputs — although you will find that Ripley’s K will fall over very quickly if you try to run the analysis on that many points) This how you might make use of these techniques in another context or with different point data… 6.8 Analysing Spatial Autocorrelation with Moran’s I, LISA and friends Now, at this point you have a choice and at bit like in those Fighting Fantasy books that I used to read as a kid, you can select either Option 1 (which may lead to firey death by dragon) or Option 2 (which could lead to a pot of gold)… Option 1. If you’ve had enough of coding and you think you might like to do your coursework in ArcGIS and have a bit more practice with model builder, then go to ArcMap part 2. This will show you how to analyse spatial autocorrelation in ArcGIS and will give you more practice will model builder. Option 2. If you are a total bad-ass and want to continue with R, then brilliant!! Woo hoo!! You can keep following the instuctions below. …Of course there is also Option 3 and that is to give both a go… Have the Arc lot gone? OK great, here’s some more lovely R… In this section we are going to explore patterns of spatially referenced continuous observations using various measures of spatial autocorrelation. Spatial autocorrelation is a measure of similarity between nearby data. Check out the various references in the reading list for more information about the methods we will explore today. There are also useful links in the helpfile of the spdep package which we will be using here. 6.8.1 Data download Before we get any further, let’s get some ward boundaries read in to R — download LondonWardData from Github and read it in… library(rgdal) #read the ward data in LondonWards &lt;- readOGR(&quot;prac6_data/LondonWards.shp&quot;) ## OGR data source with driver: ESRI Shapefile ## Source: &quot;C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac6_data\\LondonWards.shp&quot;, layer: &quot;LondonWards&quot; ## with 625 features ## It has 77 fields It’s probably projected correctly, but in case it isn’t give it a projection using the CRS() function in the raster package proj4string(LondonWards) &lt;- CRS(&quot;+init=epsg:27700&quot;) #have a look to check that everything looks OK.. tmap_mode(&quot;view&quot;) tm_shape(LondonWards) + tm_polygons(col = NA, alpha = 0.5) + tm_shape(BluePlaques) + tm_dots(col = &quot;blue&quot;) 6.8.2 Data cleaning Ah yes, we might need to lose the blue plaques that fall outside of London summary(BluePlaquesBNG) ## Object of class SpatialPointsDataFrame ## Coordinates: ## min max ## coords.x1 505575.2 622211.7 ## coords.x2 -5527598.3 199509.2 ## Is projected: TRUE ## proj4string : ## [+init=epsg:27700 +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 ## +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs ## +ellps=airy ## +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894] ## Number of points: 2711 ## Data attributes: ## id ## Min. : 1.0 ## 1st Qu.: 698.5 ## Median : 6154.0 ## Mean :10724.9 ## 3rd Qu.:10397.0 ## Max. :49190.0 ## ## inscription ## Frank Matcham (1854-1920) theatre architect designed this theatre : 3 ## Grimâ\\200\\231s Dyke : 2 ## Lillie Langtry 1852-1929 actress lived here : 2 ## &#39;Canons&#39; gate pillars\\r\\nEntrance gate piers to &#39;Canons&#39; from Old Turnpike Road\\r\\nBuilt in 1712 for James Brydges 1673-1744, 1st Duke of Chandos. House demolished 1740 and existing buildings constructed from salvaged materials. Piers refurbished 1998.: 1 ## &#39;Father&#39; Henry Willis 1821-1901 organ builder lived here : 1 ## J. H. Greathead Chief Engineer City and South London Railway. Inventor of the Travelling Shield that made possible the cutting of the tunnels of London&#39;s deep level tube system : 1 ## (Other) :2701 BluePlaquesSub &lt;- BluePlaquesBNG[LondonWards,] tm_shape(LondonWards) + tm_polygons(col = NA, alpha = 0.5) + tm_shape(BluePlaquesSub) + tm_dots(col = &quot;blue&quot;) 6.8.3 Data manipulation The measures of spatial autocorrelation that we will be using require continuous observations (counts of blue plaques, average GCSE scores, average incomes etc.) to be spatially referenced (i.e. attached to a spatial unit like a ward or a borough). The file you have already has the various obervations associated with the London Ward data file already attached to it, but let’s continue with our blue plaques example for now. To create a continuous observation from the blue plaques data we need to count all of the blue plaques that fall within each Ward in the City. Luckily, we can do this using the poly.counts() function in Chris Brunsdon’s excellent gistools package… (we could also use the over() function in the sp package if we wanted) res &lt;- poly.counts(BluePlaquesSub, LondonWards) #and add this as a column in our spatialPolygonsDataframe LondonWards@data$BluePlaqueCount&lt;-res #as the wards are of different sizes, perhaps best that we calculate a density LondonWards@data$BlueDensity &lt;- LondonWards$BluePlaqueCount/poly.areas(LondonWards) #let&#39;s just check the data to see if the calculations have worked LondonWards@data How about a quick choropleth map to see how we are getting on… tm_shape(LondonWards) + tm_polygons(&quot;BlueDensity&quot;, style=&quot;jenks&quot;, palette=&quot;PuOr&quot;, midpoint=NA, title=&quot;Blue Plaque Density&quot;) So, from the map, it looks as though we might have some clustering of blue plaques in the centre of London so let’s check this with Moran’s I and some other statistics. Before being able to calculate Moran’s I and any similar statistics, we need to first define a \\(W_{ij}\\) spatial weights matrix library(spdep) First calculate the centroids of all Wards in London #First calculate the centroids of all Wards in London coordsW &lt;- coordinates(LondonWards) plot(coordsW) Now we need to generate a spatial weights matrix (remember from the lecture). We’ll start with a simple binary matrix of queen’s case neighbours (otherwise known as Contiguity edges corners). Thie method means that polygons with a shared edge or a corner will be included in computations for the target polygon… #create a neighbours list LWard_nb &lt;- poly2nb(LondonWards, queen=T) #plot them plot(LWard_nb, coordinates(coordsW), col=&quot;red&quot;) #add a map underneath plot(LondonWards, add=T) #create a spatial weights object from these weights Lward.lw &lt;- nb2listw(LWard_nb, style=&quot;C&quot;) head(Lward.lw$neighbours) ## [[1]] ## [1] 6 7 10 462 468 482 ## ## [[2]] ## [1] 5 8 9 11 12 13 16 ## ## [[3]] ## [1] 10 11 12 15 480 483 ## ## [[4]] ## [1] 17 281 291 470 473 481 ## ## [[5]] ## [1] 2 9 16 281 283 290 ## ## [[6]] ## [1] 1 7 8 10 11 14 6.8.4 Spatial autocorrelation Now we have defined our \\(W_{ij}\\) matrix, we can calculate the Moran’s I and other associated statistics Moran’s I test tells us whether we have clustered values (close to 1) or dispersed values (close to -1), we will calculate for the densities rather than raw values I_LWard_Global_Density &lt;- moran.test(LondonWards@data$BlueDensity, Lward.lw) I_LWard_Global_Density ## ## Moran I test under randomisation ## ## data: LondonWards@data$BlueDensity ## weights: Lward.lw ## ## Moran I statistic standard deviate = 30.211, p-value &lt; 2.2e-16 ## alternative hypothesis: greater ## sample estimates: ## Moran I statistic Expectation Variance ## 0.6726785503 -0.0016025641 0.0004981274 Geary’s C as well..? This tells us whether similar values or dissimilar values are clusering C_LWard_Global_Density &lt;- geary.test(LondonWards@data$BlueDensity, Lward.lw) C_LWard_Global_Density ## ## Geary C test under randomisation ## ## data: LondonWards@data$BlueDensity ## weights: Lward.lw ## ## Geary C statistic standard deviate = 8.3637, p-value &lt; 2.2e-16 ## alternative hypothesis: Expectation greater than statistic ## sample estimates: ## Geary C statistic Expectation Variance ## 0.403108506 1.000000000 0.005093209 Getis Ord General G…? This tells us whether high or low values are clustering. If G &gt; Expected = High values clustering; if G &lt; expected = low values clustering G_LWard_Global_Density &lt;- globalG.test(LondonWards@data$BlueDensity, Lward.lw) G_LWard_Global_Density ## ## Getis-Ord global G statistic ## ## data: LondonWards@data$BlueDensity ## weights: Lward.lw ## ## standard deviate = 29.488, p-value &lt; 2.2e-16 ## alternative hypothesis: greater ## sample estimates: ## Global G statistic Expectation Variance ## 1.123988e-02 1.602564e-03 1.068124e-07 So the global statistics are indicating that we have spatial autocorrelation of Blue Plaques in London: The Moran’s I statistic = 0.51 (remember 1 = clustered, 0 = no pattern, -1 = dispersed) which shows that we have some distinctive clustering The Geary’s C statistic = 0.41 (remember Geary’s C falls between 0 and 2; 1 means no spatial autocorrelation, &lt;1 - positive spatial autocorrelation or similar values clustering, &gt;1 - negative spatial autocorreation or dissimilar values clustering) which shows that similar values are clustering The General G statistic = G &gt; expected, so high values are tending to cluster. We can now also calculate local versions of the Moran’s I statistic (for each Ward) and a Getis Ord \\(G_{i}^{*}\\) statistic to see where we have hot-spots… #use the localmoran function to generate I for each ward in the city I_LWard_Local &lt;- localmoran(LondonWards@data$BluePlaqueCount, Lward.lw) I_LWard_Local_Density &lt;- localmoran(LondonWards@data$BlueDensity, Lward.lw) #what does the output (the localMoran object) look like? head(I_LWard_Local_Density) ## Ii E.Ii Var.Ii Z.Ii Pr(z &gt; 0) ## 0 0.08893069 -0.001632161 0.1585720 0.2274243 0.4100469 ## 1 0.13238172 -0.001904187 0.1847261 0.3124398 0.3773532 ## 2 0.10800337 -0.001632161 0.1585720 0.2753202 0.3915351 ## 3 0.11771065 -0.001632161 0.1585720 0.2996974 0.3822040 ## 4 0.11771065 -0.001632161 0.1585720 0.2996974 0.3822040 ## 5 0.11213389 -0.001632161 0.1585720 0.2856929 0.3875567 There are 5 columns of data. We want to copy some of the columns (the I score (column 1) and the z-score standard deviation (column 4)) back into the LondonWards spatialPolygonsDataframe LondonWards@data$BLocI &lt;- I_LWard_Local[,1] LondonWards@data$BLocIz &lt;- I_LWard_Local[,4] LondonWards@data$BLocIR &lt;- I_LWard_Local_Density[,1] LondonWards@data$BLocIRz &lt;- I_LWard_Local_Density[,4] 6.8.5 Mapping outputs No we can plot a map of the local Moran’s I outputs… We’ll set the breaks manually based on the rule that data points &gt;2.58 or &lt;-2.58 standard deviations away from the mean are significant at the 99% level (&lt;1% chance that autocorrelation not present); &gt;1.96 - &lt;2.58 or &lt;-1.96 to &gt;-2.58 standard deviations are significant at the 95% level (&lt;5% change that autocorrelation not present). &gt;1.65 = 90% etc. breaks1&lt;-c(-1000,-2.58,-1.96,-1.65,1.65,1.96,2.58,1000) Now create a new diverging colour brewer palette and reverse the order using rev so higher values correspond to red MoranColours&lt;- rev(brewer.pal(8, &quot;RdGy&quot;)) Plot on an interactive map tm_shape(LondonWards) + tm_polygons(&quot;BLocIRz&quot;, style=&quot;fixed&quot;, breaks=breaks1, palette=MoranColours, midpoint=NA, title=&quot;Local Moran&#39;s I, Blue Plaques in London&quot;) This map shows some areas in the centre of London that have relatively high scores, indicating areas with lots of blue plaques neighbouring other areas with lots of blue plaques. What about the Getis Ord \\(G_{i}^{*}\\) statisic for hot and cold spots? Gi_LWard_Local_Density &lt;- localG(LondonWards@data$BlueDensity, Lward.lw) Check the help file (?localG) to see what a localG object looks like - it is a bit different from a localMoran object as it only contains just a single value - the z-score (standardised value relating to whether high values or low values are clustering together) And map the outputs… head(Gi_LWard_Local_Density) ## [1] -0.8364891 -0.8720954 -0.7679474 -0.8368497 -0.8368497 -0.7972659 LondonWards@data$BLocGiRz &lt;- Gi_LWard_Local_Density And map the outputs… GIColours&lt;- rev(brewer.pal(8, &quot;RdBu&quot;)) #now plot on an interactive map tm_shape(LondonWards) + tm_polygons(&quot;BLocGiRz&quot;, style=&quot;fixed&quot;, breaks=breaks1, palette=GIColours, midpoint=NA, title=&quot;Gi*, Blue Plaques in London&quot;) 6.8.6 Other variables The local Moran’s I and \\(G_{i}^{*}\\) statistics for wards clearly show that the density of blue plaques in the centre of the city exhibits strong (and postitive) spatial autocorrelation, but neither of these maps are very interesting. The ArcGIS crew will have been calculating Local Moran’s I and \\(G_{i}^{*}\\) statistics for some of the other variables for the wards of London. Why not try some alternative variables and see what patterns emerge… here I’m going to have a look at Average GSCE scores… #use head to see what other variables are in the data file head(LondonWards@data) ## WD11CD WD11CDO WD11NM WD11NMW ## 0 E05000026 00ABFX Abbey &lt;NA&gt; ## 1 E05000027 00ABFY Alibon &lt;NA&gt; ## 2 E05000028 00ABFZ Becontree &lt;NA&gt; ## 3 E05000029 00ABGA Chadwell Heath &lt;NA&gt; ## 4 E05000030 00ABGB Eastbrook &lt;NA&gt; ## 5 E05000031 00ABGC Eastbury &lt;NA&gt; ## WardName OldCode Wardcode Pop2013 Aged0_15 ## 0 Barking and Dagenham - Abbey 00ABFX E05000026 13650 3450 ## 1 Barking and Dagenham - Alibon 00ABFY E05000027 10400 2700 ## 2 Barking and Dagenham - Becontree 00ABFZ E05000028 12050 3000 ## 3 Barking and Dagenham - Chadwell Heath 00ABGA E05000029 10150 2450 ## 4 Barking and Dagenham - Eastbrook 00ABGB E05000030 10600 2150 ## 5 Barking and Dagenham - Eastbury 00ABGC E05000031 11700 3000 ## Aged16_64 Aged65plus PctAged0_1 PctAged16_ PctAged65p MeanAge201 ## 0 9550 700 25.3 70.0 5.1 29.5 ## 1 6600 1100 26.0 63.5 10.6 33.8 ## 2 8000 1100 24.9 66.4 9.1 33.0 ## 3 6150 1550 24.1 60.6 15.3 36.2 ## 4 6900 1550 20.3 65.1 14.6 37.7 ## 5 7550 1150 25.6 64.5 9.8 33.4 ## MedianAge2 AreaSqKM PopDensity PctBame PctNotBorn PctNoEngli GenFertRat ## 0 29 1.3 10500.0 71.9 57.3 25.7 103 ## 1 33 1.4 7428.6 29.9 24.7 7.9 91 ## 2 32 1.3 9269.2 41.2 30.1 10.5 102 ## 3 34 3.4 2985.3 37.9 24.8 6.5 81 ## 4 36 3.5 3028.6 24.8 19.0 4.5 78 ## 5 32 1.4 8357.1 41.7 32.2 11.9 89 ## MaleLE0509 FemaleLE05 PctYr1Obes PctYr6Obes RateAmbula RatesAmbul ## 0 80.0 82.2 15.423728814 21.467391304 164.6886 0.9352518 ## 1 75.8 80.4 12.5 25.853658537 134.5192 0.7837838 ## 2 78.9 78.9 12.857142857 24.874371859 127.8838 0.7010309 ## 3 79.1 81.0 11.751662971 25.816993464 149.5567 0.6000000 ## 4 77.1 80.6 13.942307692 24.324324324 145.0000 0.6666667 ## 5 78.6 84.6 13.621262458 22.608695652 124.2735 0.4666667 ## RoadKilled InEmployme Employment NoJobs2011 EmpWkAgePo RateNINoFo ## 0 3 5489 58.35016 8900 0.9319372 108.69565 ## 1 4 4214 59.26864 900 0.1363636 31.14754 ## 2 1 4674 57.89669 1200 0.1500000 38.55422 ## 3 2 3916 58.67546 1800 0.2926829 26.27119 ## 4 5 4686 62.84871 4000 0.5797101 18.43972 ## 5 2 4620 58.34070 1100 0.1456954 48.92086 ## MeanHouseP NoProperti NoHousehol PctDetache PctSemiDet PctTerrace ## 0 164000 60 4753 3.9 7.2 22.6 ## 1 173500 73 4045 3.8 18.2 63.8 ## 2 178995 147 4378 4.2 24.7 52.0 ## 3 210000 87 4062 3.8 29.6 32.2 ## 4 203500 84 3977 3.2 32.6 45.5 ## 5 187875 75 4321 5.0 21.0 52.5 ## PctFlatMai PctOwned20 PctSocialR PctPrivate PctCTaxBan PctCTaxB_1 ## 0 66.3 32.7 26.7 38.6 45.77158 56.47341 ## 1 14.2 45.1 36.8 15.9 9.29495 90.75384 ## 2 19.1 46.7 29.4 20.1 11.94346 90.76561 ## 3 34.5 54.0 32.0 12.4 33.28380 66.36949 ## 4 18.4 67.6 20.0 11.2 14.81574 84.93526 ## 5 21.5 44.0 37.4 17.3 18.72262 81.41573 ## PctCTaxB_2 Incapacity IncomeSupp EmpSupport JSAClaiman PctDepChil ## 0 0.10897995 1.570681 3.612565 3.403141 8.737771 28.15789 ## 1 0.07318858 3.257576 6.590909 6.060606 9.473789 35.55556 ## 2 0.09422850 2.312500 4.750000 5.500000 10.234388 32.95775 ## 3 0.44576523 2.682927 5.121951 4.634146 8.342021 28.79310 ## 4 0.54780876 1.956522 3.188406 3.623188 8.293168 24.71698 ## 5 0.04611483 2.450331 5.033113 5.099338 9.463746 30.14286 ## PctHHNoAdu PctLonePar IDRankLond IDPctWorst AvgGCSE201 UnauthAbse ## 0 8.748906 55.31062 166 85.71429 330 1.3 ## 1 12.440191 60.99518 124 100.00000 341 1.3 ## 2 10.731821 51.51057 185 100.00000 346 1.4 ## 3 10.147133 55.23979 96 100.00000 327 1.7 ## 4 6.663236 48.69792 288 100.00000 349 1.0 ## 5 11.118914 52.45902 135 100.00000 339 1.4 ## PctWithNoQ PctLev4Qua CrimeRate1 ViolenceRa RobberyRat TheftAndHa ## 0 16.4 34.5 164.4 35.71429 6.541353 71.35338 ## 1 31.2 16.7 83.9 22.88462 3.365385 23.46154 ## 2 28.0 20.6 85.7 17.73109 2.605042 30.25210 ## 3 29.1 19.5 84.5 18.62069 2.758621 28.57143 ## 4 29.9 18.5 64.9 17.74648 2.159624 18.87324 ## 5 28.9 20.0 75.9 17.87234 3.489362 22.29787 ## CriminalDa DrugsRate1 Deliberate PctOpenSpa CarsPerHH2 AvgPubTran ## 0 11.954887 14.060150 0.6 19.60720 0.5476815 5.7 ## 1 10.000000 6.442308 0.3 22.41290 0.8151599 3.2 ## 2 5.882353 6.302521 0.7 3.03888 0.8702361 2.9 ## 3 10.738916 3.349754 1.1 56.40730 0.9180619 2.2 ## 4 5.915493 4.037559 1.0 51.11650 1.0604579 2.4 ## 5 7.744681 4.765957 1.3 18.10540 0.7827715 2.8 ## PctTTWBike TurnoutMay Shape_Leng Shape_Area ID x y ## 0 0.8016032 25.68894 6244.870 1282926 1 544204 184358 ## 1 1.0204082 20.34793 6353.916 1364441 2 549062 185153 ## 2 1.6474112 22.53821 6341.656 1288085 3 547000 186088 ## 3 1.1746680 25.31881 9603.344 3384198 4 548360 189491 ## 4 1.5578318 24.12147 8987.676 3450578 5 550790 186101 ## 5 1.5151515 21.51488 6829.478 1440028 6 546139 183989 ## BluePlaqueCount BlueDensity BLocI BLocIz BLocIR BLocIRz ## 0 1 7.794681e-07 0.05679283 0.1567154 0.08893069 0.2274243 ## 1 0 0.000000e+00 0.08333988 0.2118224 0.13238172 0.3124398 ## 2 0 0.000000e+00 0.06818055 0.1872611 0.10800337 0.2753202 ## 3 0 0.000000e+00 0.07387441 0.2025339 0.11771065 0.2996974 ## 4 0 0.000000e+00 0.07387441 0.2025339 0.11771065 0.2996974 ## 5 0 0.000000e+00 0.06818055 0.1872611 0.11213389 0.2856929 ## BLocGiRz ## 0 -0.8364891 ## 1 -0.8720954 ## 2 -0.7679474 ## 3 -0.8368497 ## 4 -0.8368497 ## 5 -0.7972659 I_LWard_Local_GCSE &lt;- localmoran(LondonWards@data$AvgGCSE201, Lward.lw) LondonWards@data$GCSE_LocIz &lt;- I_LWard_Local_GCSE[,4] tm_shape(LondonWards) + tm_polygons(&quot;GCSE_LocIz&quot;, style=&quot;fixed&quot;, breaks=breaks1, palette=MoranColours, midpoint=NA, title=&quot;Local Moran&#39;s I, GCSE Scores&quot;) Now the Gi* statistic to look at clusters of high and low scores… Gi_LWard_Local_GCSE &lt;- localG(LondonWards@data$AvgGCSE201, Lward.lw) LondonWards@data$GCSE_LocGiz &lt;- Gi_LWard_Local_GCSE tm_shape(LondonWards) + tm_polygons(&quot;GCSE_LocGiz&quot;, style=&quot;fixed&quot;, breaks=breaks1, palette=GIColours, midpoint=NA, title=&quot;Gi*, GCSE Scores&quot;) So this is the end of the practical. Hopefully you have learned a lot about the different methods we can employ to analyse patterns in spatial data. This practical was deliberately designed as a walk through, but this may have given you ideas about where you could perhaps take these techniques in your coursework if this is something you wanted to explore further with different data or in different contexts. 6.9 Extension Already a pro with point pattern and spatial autocorrelation analysis? Then try the following out: We have used sp objects in this practical (because I wrote it before sf became the defacto spatial data type in R). Can you convert some of this so it works withsf? Could you atomate any of the functions so that you could quickly produce maps of any of the variables in the LondonWards dataset? Could you get these outputs into a faceted ggplot2 map? Make an interative map with selectable layers for Gi* and Moran’s I like we did in the Maps with extra features or Advanced interactive map sections… 6.10 ArcMap part 2 6.10.1 Getting started Create a new geodatabase in your working folder on your N: drive Start ArcMap and add the Ward boundary data from practical 1 or download it again from here Right-click on your layer and select Data &gt; Export Data. Save your data as a new file geodatabase feature class and give it an appropriate name –– we are doing this as we will be messing around with boundary polygons and it’s good practice not to ruin the original file! Add your newly saved feature class your map. Open up the attribute table and sort the data by the column LG_GSS_CD (right-click the header column and sort ascending). As the LG_GSS_CD code for the City of London is E09000001, all of the Wards within the feature class will now be sorted to the top of the file Left-click the small box to the left of the first row – this should highlight the first row in blue (and the polygon on the map). Scroll down a few rows until you find the last City of London ward – this should be. Hold down shift and click the small box to the left of this row. All rows above should now be highlighted in blue (and this should show on the map). You can also click and drag We are now ready to dissolve these boundaries into a single City of London zone. If you have not already done so, activate the Editor toolbar: Customize &gt; Toolbars &gt; Editor. On the Editor toolbar, select Start Editing from the dropdown menu If you have other layers open in your map, you may have to select the correct layer to edit In the editor dropdown menu, ‘Merge’ should now be active. Click Merge. Select the first feature as your merge feature and click ‘OK’ Whilst still in Editor change the GSS_CODE for Castle Bayard to E09000001 In the Editor drop down menu, select Save Edits and then Stop Editing You should now see on your map that the ward boundaries have dissolved and in your attribute table, only the first row –– Castle Baynard, should be left We are now ready to join your London data to your new boundaries. Get the data from here. Select the excel format and save it to your current working folder Open the excel document and the data tab or worksheet (bottom left). Delete all the data we are not interested in and save it as a .csv…I’ve removed everything expect New Code and Median Household income estimate (2012/13). Add your .csv layer to your map. Join the .csv data to your newly edited boundary data. Use GSS_CODE and New code to match the records, keeping only the matching records. Export your new layer as a new geodatabase feature class in a new file geodatabase for this week’s practical. I’ve called mine Londonwards_GCSE Hint make sure you don’t have any layers open twice (e.g. if you have your .csv open and they try to open it and join it to the .shp in ArcMap it will most likely not work). An exploratory research question: Are households with high or low median incomes spatially clustered in London? We are almost ready to try some exploratory analysis, but before we do this, we will need to generate a unique ID column in your new LondonWards feature class. Open the attribute table and in Table Options, select Add a Field of type Short Integer called ID. Scroll to the last column in the table and you should see your new column. Right click the header and select the field calculator. Set ID to = ObjectID and click OK. Before we start our income values are stored as a string and we need to convert them to numeric…add a new field to the attribute table with the type of float, right click on the new field &gt; Field Calculator then set the new field to equal to the Median_Household_income_estimate__2012_13 point scores — use this new field from now on. If you can’t add a new field save and then reload the ArcMap document — I think this is due to ArcMap locking certain layers, but that will solve it First of all, generate a standard choropleth map of median income for people living in wards in London. Does it look like there might be a spatial pattern? From this map, what might your hypothesis be? In statistical analysis it is standard practice to reverse your hypothesis and turn it into a null hypothesis. Therefore, if your hypothesis is there is a spatial pattern to median household income, then the null-hypothesis is that there is not a relationship (and vice versa) In order to confirm or reject your null hypothesis we will run both a global Geary’s C test and a global Moran’s I test Go to Geoprocessing &gt; Arc Toolbox and load the Arc Toolbox if it is not already there Select Spatial Statistics Tools &gt; Analyzing Patterns &gt; High/Low Clustering Getis-Ord General G When the dialogue box opens, add your LondonWards feature class as the input feature class and choose the other options as shown below: In this instance we will use a standard inverse distance matrix for spatial weights – refer back to the lecture notes if you can’t remember what an inverse distance matrix is. Make sure the Generate Report option is ticked and then run the tool by clicking OK The dialogue box will show you when the process is complete. If the results tab doesn’t appear, select Geoprocessing &gt; Results and expand the results of HighLowClustering. Double click on the report file to open up the report What does the report suggest about the spatial clustering of GCSE scores in London? What is a Z-score (if you’re not sure, Wikipedia is always a good place to start) Generate a similar report using the Spatial Autocorrelation (Moran’s I) tool. What does this report tell you? Where are the high and low clusters in London and how does the conception of spatial weights affect the patterns which are shown? Now we have some global measures of spatial autocorrelation, it will be useful to look at where, specifically, spatial clusters are found. To do this we will also generate a series of spatial weights matrices using the Arc Model Builder and run Local Moran’s I and Geary’s C calculations to see how the conception of spatial weights affects the results of the analysis 6.10.2 Using the Model Builder First we will set our environment workspace. Select Geoprocessing &gt; Environments… and under Workspace set the current and scratch workspaces to your wk6 file geodatabase. You should also set your default geodatabase to the one you created in your week 6 folder in your map document properties Select Geoprocessing &gt; ModelBuilder and the Model Builder box should open up. The model builder is a visual interface which allows you to build up the elements of your model by dragging data, tools and iterators into the window In Arc Toolbox, go to Spatial Statistics Tools &gt; Modeling Spatial Relationships &gt; Generate Spatial Weights Matrix and drag it into your model builder box. Double click the ‘Generate Spatial Weights Matrix’ box and the dialogue box for the tool should appear. We will first create a spatial weights matrix based on contiguity (Queen’s Case – edges and corners) using the options shown below. Save the .swm file into the same folder as your shapefile or geodatabase in your working directory, remembering to check the box next to row standardization Create a further two spatial weights matrices. The first one should be for the 8 nearest neighbours, the second a standard inverse distance. Both should be generated from the same feature class as below Note, to join an existing input to a new tool, use the ‘Connect’ tool and drag a line to the tool you are using Now we have our three spatial weights matices, we can carry out local Moran’s I and local Geary’s C analyses using the different conceptions of proximity. To do this, simply drag the tools (Cluster and Outlier Analysis and Hotspot analysis) from within Spatial Statistics Tools &gt; Mapping Clusters into your Model Builder box. Double Click the tool and fill out the options as below – remember to select GET_SPATIAL_WEIGHTS_FROM_FILE and choose the appropriate spatial weights matrix. Make sure you use the feature class you saved to get the income data as the input feature class. Double click your green output file and change its name to something recognisable Right click the output file and check the box next to OK Add another two Moran’s I calculations – one for each of the other spatial weights matrices. Then add a Local Geary’s C calculation for each spatial weights matrix as well. You should end up with 6 output files as below. Make sure you change the names of each output file and add them to display as well When you have finished building your model, in the top menu, select Model &gt; Save As and save your model into a new tool box in your working directory Now you are ready to run your model. Select Model &gt; Run Entire Model. The model will run, and if you have remembered to tick the ‘Add to display’ option next to each output file, each output should be added to your map. This will display confidence intervals, which can you change to Z scores under the layer symbology. Otherwise you can add them in from your GeoDatabase You are now able to review the results of your hotspot (Local Geary’s C) and Local Moran’s I analyses. To understand what the values HH, LL, HL and LH mean, you should consult the ArcGIS help system If you wish, to aid interpretation, you can add some London Borough boundaries to your map — you can get this layer from practical 1 Referring back to the exploratory research question asked above, what can you observe about the spatial clustering of median income in London? How does the conception of spatial relationships affect the results of these spatial autocorrelation analyses? Why might the ways that spatial relationships are conceived affect these results? 6.10.3 Extension work 6.10.3.1 Model builder Build a model using model builder which: Reads in your blue plaques data from last week, Adds a new short integer field using the ‘add field’ tool Fills this new field with 1’s using the ‘calculate field’ tool Carries out a spatial join, calculating the number of blue plaques in each ward by using the sum of the new field you have just created Calculates the median centre of all of the blue plaques in London Carries out a hot spot analysis of these blue plaques to see if there is any noticeable spatial clustering 6.10.3.2 Further practice The introduction to model builder has only been very cursory –– it is able to carry out far more complex tasks. If you think you would like to use Model Builder in your coursework assessment (remember you other option is to do something similar in R or QGIS), then ESRI have a number of tutorial activities to take you from the basics to something far more advanced. The tutorials can be accessed from the online help system. If you are running ArcGIS 10.1 (I doubt the pages will change much for 10 or 10.2), then this is a good place to start These tutorials will introduce you to many more features that we didn’t cover today. 6.11 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["advanced-raster-analysis.html", "Chapter 7 Advanced raster analysis 7.1 Learning objectives 7.2 Recommended listening 7.3 Introduction 7.4 Data 7.5 Processing raster data 7.6 Data exploration 7.7 Basic raster calculations 7.8 Advanced raster calculations 7.9 Calucating urban area from Landsat data 7.10 Urban area and temperature relationship 7.11 Statistical summary 7.12 Considerations 7.13 Extension 7.14 References 7.15 Remote sensing background (optional) 7.16 Feedback", " Chapter 7 Advanced raster analysis 7.1 Learning objectives By the end of this practical you should be able to: Explain and execute appropraite pre-proessing steps of raster data Replicate published methodologies using raster data Design new R code to undertake further analysis 7.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy 7.3 Introduction Within this practical we are going to be using data from the Landsat satellite series provided for free by the United States Geological Survey (USGS) to replicate published methods. Landsat imagery is the longest free temporal image repository of consistent medium resolution data. It collects data at each point on Earth each every 16 days (temporal resolution) in a raster grid composed of 30 by 30 m cells (spatial resolution). Geographical analysis and concepts are becoming ever more entwined with remote sensing and Earth observation. Back when I was an undergraduate there was specific software for undertaking certain analysis, now you can basically use any GIS. I see remote sensing as the science behind collecting the data with spatial data analysis then taking that data and providing meaning. So whilst i’ll give a background to Landsat data and remote sensing, this practical will focus on more advanced methods for analysing and extracting meaning from raster data. 7.3.1 Remote sensing background (required) Landsat is raster data It has pixels of 30 by 30m collected every 16 days with global coverage As humans we see in the visible part of the electromagnetic spectrum (red-green-blue) Landsat takes samples in these bands and several more to make a spectral sigature for each pixel (see image below) Each band is provided as a seperate .TIFF raster layer Later on we will compute temperature from the Landsat data, whilst i refer to and explain each varaiable created don’t get overwhelmed by it, take away the process of loading and manipulating raster data in R to extract meaningful information. An optional remote sensing background containing additional information can be found at the end of this practical should you wish to explore this further. 7.4 Data 7.4.1 Shapefile The shapefile of Manchester is available from the data folder for this week on GitHub 7.4.2 Raster data (Landsat) To access the Landsat data we will use in this practical you can either: Sign up for a free account at: https://earthexplorer.usgs.gov/. Use the Landsat data provided on Moodle — this will be available only if the earth explorer website is down (e.g. in the case of US government shutdowns) To download the data: Search for Manchester in the address/place box and select it. Select the date range between the 12/5/2019 and 14/5/2019 — it’s a US website so check the dates are correct. Click dataset and select Landsat, then Landsat Collection 1 Level-1, check Landsat 8 (level 2 is surface reflectance — see Remote sensing background (optional) Click results, there should be one image, download it..it might take a while Landsat data comes zipped twice as a .tar.gz. Use 7Zip or another file extractor, extract it once to get to a .tar then extract again and files should appear. 7.5 Processing raster data 7.5.1 Loading Today, we are going to be using a Landsat 8 raster of Manchester. The vector shape file for Manchester has been taken from an ESRI repository. Let’s load the majority of packages we will need here. ## listing all possible libraries that all presenters may need following each practical library(sp) library(raster) library(rgeos) library(rgdal) library(rasterVis) library(ggplot2) Now let’s list all our Landsat bands except band 8 (i’ll explain why next) along with our study area shapefile. Each band is a seperate .TIF file. # List your raster files excluding band 8 using the patter argument listlandsat &lt;- list.files(&quot;prac7_data/Lsatdata&quot;,pattern=&quot;.*[B123456790]\\\\.tif$&quot;, ignore.case=TRUE, full.names=TRUE) # Load the manchester boundary manchester_boundary &lt;- readOGR(&#39;prac7_data/manchester_boundary.shp&#39;) ## OGR data source with driver: ESRI Shapefile ## Source: &quot;C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac7_data\\manchester_boundary.shp&quot;, layer: &quot;manchester_boundary&quot; ## with 1 features ## It has 5 fields ## Integer64 fields read as strings: OBJECTID # Load our raster layers into a stack stacklandsat &lt;- stack(listlandsat) #check they have the same Coordinate Reference System (CRS) crs(manchester_boundary) ## CRS arguments: ## +proj=utm +zone=30 +datum=WGS84 +units=m +no_defs +ellps=WGS84 ## +towgs84=0,0,0 crs(stacklandsat) ## CRS arguments: ## +proj=utm +zone=30 +datum=WGS84 +units=m +no_defs +ellps=WGS84 ## +towgs84=0,0,0 7.5.2 Resampling There is an error with this dataset as band 8 does not fully align with the extent of the other raster layers. There are several ways to fix this, but in this tutorial we will resample the band 8 layer with the extent of band 1. Resampling takes awhile, so please be patient… # get band 8 b8list &lt;- list.files(&quot;prac7_data/Lsatdata&quot;,pattern=&quot;.*B[8]\\\\.tif$&quot;, ignore.case=TRUE, full.names=TRUE) b8 &lt;- raster(b8list) ## ngb is a nearest neighbour sampling method b8&lt;-resample(b8, stacklandsat$LC08_L1TP_203023_20190513_20190521_01_T1_B1, method = &quot;ngb&quot;) # Write out the raster writeRaster(b8, names(b8), format=&#39;GTiff&#39;, overwrite=TRUE) Load band 8 and add it to our raster stack b8list2 &lt;- list.files(&quot;prac7_data/Lsatdata&quot;,pattern=&quot;.*B[8]\\\\.tif$&quot;, ignore.case=TRUE, full.names = TRUE) # Read in band 8 b8backin &lt;- raster(b8list2) stacklandsat &lt;- addLayer(stacklandsat, b8backin) We can compare it to see if both rasters have the same extent, number of rows and columns, projection, resolution and origin compareRaster(stacklandsat$LC08_L1TP_203023_20190513_20190521_01_T1_B1, stacklandsat$LC08_L1TP_203023_20190513_20190521_01_T1_B8) ## [1] TRUE 7.5.3 Clipping Our raster is currently the size of the scene which satellite data is distributed in, to clip it to our study area it’s best to first crop it to the extent of the shapefile and then mask it as we have done in previous practicals… e &lt;- extent(manchester_boundary) lsatcrop &lt;- crop(stacklandsat, e) lsatmask &lt;- mask(lsatcrop, manchester_boundary) If all we wanted to do was clip our data, we could now change our filenames in the raster stack and write the .TIFF files out again… # add mask to the filenames within the raster stack names(lsatmask)&lt;-paste(names(lsatmask), &quot;mask&quot;, sep=&quot;&quot;) # I need to write mine out in another location outputfilenames &lt;- paste(&quot;prac7_data/Lsatdata/&quot;, names(lsatmask), sep=&quot;&quot;) In the first line of code i’m taking the original names of the raster layers and adding “mask” to the end of them. This is done using paste() and the arguments names(lsatmask): original raster layer names \"mask\": what i want to add to the names sep=\"\": how the names and “mask” should be seperated — \"\" means no spaces As i can’t upload my Landsat files to GitHub i’m storing them in a folder that is not linked (remember this is all sotred on GitHub) – so you won’t find prac7_data/Lsatdata on there. If you want to store your clipped Landsat files in your project directory just use: writeRaster(lsatmask, names(lsatmask), bylayer=TRUE, format=&#39;GTiff&#39;, overwrite=TRUE) For me though it’s: writeRaster(lsatmask, outputfilenames, bylayer=TRUE, format=&#39;GTiff&#39;, overwrite=TRUE) Here i write out each raster layer individually though specifying bylayer=TRUE. 7.6 Data exploration 7.6.1 More loading and manipulating For the next stage of analysis we are only interested in bands 1-7, we can either load them back in from the files we just saved or take them directly from the original raster stack. # either read them back in from the saved file: manc_files&lt;-list.files(&quot;prac7_data/Lsatdata/&quot;,pattern=&quot;.*B[1234567]\\\\mask.tif$&quot;, ignore.case=TRUE, full.names=TRUE) manc &lt;- stack(manc_files) # or extract them from the original stack manc&lt;-stack(lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B1mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B2mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B3mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B4mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B5mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B6mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B7mask) # Name the Bands based on where they sample the electromagentic spectrum names(manc) &lt;- c(&#39;ultra-blue&#39;, &#39;blue&#39;, &#39;green&#39;, &#39;red&#39;, &#39;NIR&#39;, &#39;SWIR1&#39;, &#39;SWIR2&#39;) If you want to extract specific information from a raster stack use: crs(manc) # projection extent(manc) # extent ncell(manc) # number of cells dim(manc) # number of rows, columns, layers nlayers(manc) # number of layers res(manc) # xres, yres 7.6.2 Plotting data Let’s actually have a look at our raster data, first in true colour (how humans see the world) and then false colour composites (using any other bands but not the combination of red, green and blue). # true colour composite manc_rgb &lt;- stack(manc$red, manc$green, manc$blue) # false colour composite manc_false &lt;- stack(manc$NIR, manc$red, manc$green) plotRGB(manc_rgb, axes=TRUE, stretch=&quot;lin&quot;) plotRGB(manc_false, axes=TRUE, stretch=&quot;lin&quot;) 7.6.3 Data similarity What if you wanted to look at signle bands and also check the similarity between bands? # Looking at single bands plot(manc$SWIR2) ## How are these bands different? #set the plot window size (2 by 2) par(mfrow = c(2,2)) #plot the bands plot(manc$blue, main = &quot;Blue&quot;) plot(manc$green, main = &quot;Green&quot;) plot(manc$red, main = &quot;Red&quot;) plot(manc$NIR, main = &quot;NIR&quot;) ## Look at the stats of these bands pairs(manc[[1:7]]) Low statistical significance means that the bands are sufficiently different enough in their wavelength reflectance to show different things in the image. We can also make this look a bit nicer with ggplot2 and GGally library(ggplot2) library(GGally) mancdataframe=as.data.frame(manc[[1:7]], na.rm=TRUE) randomsample&lt;-mancdataframe[sample(nrow(mancdataframe), 100), ] ggpairs(randomsample, axisLabels=&quot;none&quot;) You can do much more using GGally have a look at the great documentation 7.7 Basic raster calculations Now we will move on to some basic advanced raster analysis to compute temperature from this raster data. To do so we need to generate additional raster layers, the first of which is NDVI 7.7.1 NDVI Live green vegetation can be represented with the NIR and Red Bands through the normalised difference vegetation index (NDVI) as chlorophyll reflects in the NIR wavelength, but absorbs in the Red wavelength. \\[NDVI= \\frac{NIR-Red}{NIR+Red}\\] 7.7.2 NDVI function In R we can write functions to logically break our code into simpler sections. We can use NDVI as an example… Let’s make a function called NDVIfun NDVIfun &lt;- function(NIR, Red) { NDVI &lt;- (NIR - Red) / (NIR + Red) return(NDVI) } Here we have said our function needs two arguments NIR and Red, the next line calcualtes NDVI based on the formula and returns it. To be able to use this function throughout our analysis either copy it into the console or make a new R script, save it in your project then call it within this code using the source() function e.g… source(&#39;insert file name&#39;) To use the function do so through… ndvi &lt;- NDVIfun(manc$NIR, manc$red) Here we call the function NDVIfun() and then provide the NIR and Red band. Check the output plot(ndvi, col = rev(terrain.colors(10)), main = &quot;Landsat-NDVI&quot;) # Let&#39;s look at the histogram for this dataset hist(ndvi, breaks = 40, main = &quot;NDVI Histogram&quot;, xlim = c(-.3,.8)) We can reclassify to the raster to show use what is most likely going to vegetation based on the histogram using the 3rd quartile — anything above the 3rd quartile we assume is vegetation. Note, this is an assumption for demonstration purposes, if you were to do something similar in your assignment be sure to provide reasoning with linkage to literature (e.g. policy or academic) veg &lt;- reclassify(ndvi, cbind(-Inf, 0.3, NA)) plot(veg, main = &#39;Possible Veg cover&#39;) Let’s look at this in relation to Manchester as a whole plotRGB(manc_rgb, axes = TRUE, stretch = &quot;lin&quot;, main = &quot;Landsat True Color Composite&quot;) plot(veg, add=TRUE, legend=FALSE) 7.8 Advanced raster calculations The goal of this final section is to set up a mini investigation to see if there is a relationship between urban area and temperature. If our hypothesis is that there is a relationship then our null is that there is not a relationship… 7.8.1 Calucating tempearture from Landsat data Here we are going to compute temperature from Landsat data — there are many methods that can be found within literature to do so but we will use the one originally developed by Artis &amp; Carnahan (1982), recently summarised by Guha et al. 2018 and and Avdan and Jovanovska (2016). Some of the terms used our outlined in the remote sensing background section at the end of the document, so check back there if you get confused. Calcualte the Top of Atmopshere (TOA) spectral radiance from the Digital Number (DN) using: \\[\\lambda= Grescale * QCAL + Brescale\\] TOA spectral radiance is light reflected off the Earth as seen from the satellite measure in radiance units. In this equation Grescale and Brescale represent the gain and bias of the image, with QCAL the Digital Number (DN) — how the raw Landsat image is captured. Grescale and Brescale are available from the .MTL file provided when you downloaded the Landsat data. Either open this file in notepad and extract the required values for band 10 gain (MULT_BAND) and bias (ADD_BAND) …Or we can automate it using the MTL() function within the RStoolbox package library(RStoolbox) MTL &lt;- list.files(&quot;prac7_data/Lsatdata/&quot;,pattern=&quot;*.txt&quot;, ignore.case=TRUE, full.names = TRUE) readMTL&lt;-readMeta(MTL) #To see all the attributes readMTL Now let’s extract the values from the readMTL variable for Band 10… offsetandgain &lt;- subset(readMTL$CALRAD, rownames(readMTL$CALRAD) == &quot;B10_dn&quot;) Run the calculation using the band 10 raster layer TOA &lt;- offsetandgain$gain * lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B10mask + offsetandgain$offset Next convert the TOA to Brightness Temperature \\(T_b\\) using the following equation: \\[T_b=\\frac{K_2}{ln((K_1/\\lambda)+1)}\\] Brightness temperature is the radiance travelling upward from the top of the atmosphere to the satellite in units of the temperature of an equivalent black body. K1 (774.8853) and K2 (1321.0789) are pre launch calibration constants provided by USGS. Check the handbook for these values Instead of hardcoding these values…yep, you guessed it… we can extract them from our MTL Calidata &lt;- as.data.frame(readMTL$CALBT) # subet the rows Calidata &lt;- subset(Calidata, rownames(Calidata) %in% &quot;B10_dn&quot;) # subset the columns K1&lt;-subset(Calidata, select=(K1)) K2&lt;-subset(Calidata, select=(K2)) # get just the values out K1&lt;-K1$K1 K2&lt;-K2$K2 # this would also work for K1 K1&lt;-readMTL$CALBT$K1[1] #for K2 K2&lt;-readMTL$CALBT$K2[1] Brighttemp&lt;-(K2 / log((K1 / TOA) + 1)) Earlier we calcualted NDVI, let’s use that to determine emissivity of each pixel. First we need to calcualte the fractional vegetation of each pixel, through the equation: \\[F_v= \\left( \\frac{NDVI - NDVI_{min}}{NDVI_{max}-NDVI_{min}} \\right)^2\\] facveg=(ndvi-0.2/0.5-0.2)^2 Fractional vegetation cover is the ratio of vertically projected area of vegetation to the total surface extent. Here, \\(NDVI_{min}\\) is the minimum NDVI value (0.2) where pixels are considered bare earth and \\(NDVI_{max}\\) is the value at which pixels are considered healthy vegetation (0.5) Now compute the emissivity using: \\[\\varepsilon = 0.004*F_v+0.986\\] emiss=0.004*facveg+0.986 Emissivity is the ratio absorbed radiation engery to total incoming radiation engery compared to a blackbody (which would absorb everything), being ameasure of absoptivity. Great, we’re nearly there… get our LST following the equation from Weng et al. 2004 (also summarised in Guja et al. (2018) and Avdan and Jovanovska (2016)): \\[LST= \\frac{T_b}{1+(\\lambda \\varrho T_b / (p))ln\\varepsilon}\\] Where: \\[p= h\\frac{c}{\\varrho}\\] Ok, don’t freak out….let’s start with calculating \\(p\\) Here we have: \\(h\\) which is Plank’s constant \\(6.626 × 10^-34 Js\\) \\(c\\) which is the velocity of light in a vaccum \\(2.998 × 10^8 m/sec\\) \\(\\varrho\\) which is the Boltzmann constant of \\(1.38 × 10^-23 J/K\\) Boltzmann=1.38*10e-23 Plank=6.626*10e-34 c=2.998*10e8 p=Plank*(c/Boltzmann) Now for the rest of the equation….we have the values for: \\(\\lambda\\) which is the effective wavelength of our data (10.9 for Landsat 8 band 10) \\(\\varepsilon\\) emissivity \\(T_b\\) Brightness Temperature Run the equation with our data #define remaining varaibles lambda=1.09e-5 #run the LST calculation LST &lt;-Brighttemp/(1 +(lambda*Brighttemp/p)*log(emiss)) # check the values LST ## class : RasterLayer ## dimensions : 533, 592, 315536 (nrow, ncol, ncell) ## resolution : 30, 30 (x, y) ## extent : 540915, 558675, 5917125, 5933115 (xmin, xmax, ymin, ymax) ## crs : +proj=utm +zone=30 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0 ## source : memory ## names : layer ## values : 281.4855, 305.9571 (min, max) Are the values very high?… That’s because we are in Kevlin not degrees Celcius…let’s fix that and plot the map LST&lt;-LST-273.15 plot(LST) Nice that’s our temperature data sorted. 7.9 Calucating urban area from Landsat data How about we extract some urban area using another index and then see how our temperature data is related? We will use the Normalized Difference Built-up Index (NDBI) algorithm for identification of built up regions using the reflective bands: Red, Near-Infrared (NIR) and Mid-Infrared (MIR) originally proposed by Zha et al. (2003). It is very similar to our earlier NDVI calculation but using different bands… \\[NDBI= \\frac{Short-wave Infrared (SWIR)-Near Infrared (NIR)}{Short-wave Infrared (SWIR)+Near Infrared (NIR)}\\] In Landsat 8 data the SWIR is band 6 and the NIR band 5 Let’s compute this index now… NDBI=((lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B6mask- lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B5mask)/ (lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B6mask+ lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B5mask)) But do you remember our function? …Well this is the same calculation we used there just with different raster layers (or bands) so we could reuse it… NDBIfunexample &lt;- NDVIfun(lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B6mask, lsatmask$LC08_L1TP_203023_20190513_20190521_01_T1_B5mask) 7.10 Urban area and temperature relationship We could plot the varaibles agaisnt each other but there are a lot of data points plot(values(NDBI), values(LST)) This is termed the overplotting problem. So, let’s just take a random subset of the same pixels from both raster layers. To do so we need to again stack our layers # stack the layers computeddata=stack(LST,NDBI) # take a random subset random=sampleRandom(computeddata, 500, cells=TRUE) # check the output plot(random[,2], random[,3]) Let’s jazz things up, load some more packages library(plotly) library(tidyverse) library(htmlwidgets) library(ggplot2) Transfrom the data to a data.frame to work with ggplot, then plot #convert to a data frame randomdf=as.data.frame(random) #rename the coloumns names(randomdf)&lt;-c(&quot;cell&quot;, &quot;Temperature&quot;, &quot;Urban&quot;) heat&lt;-ggplot(randomdf, aes(x = Urban, y = Temperature))+ geom_point(alpha=2, colour = &quot;#51A0D5&quot;)+ labs(x = &quot;Temperature&quot;, y = &quot;Urban index&quot;, title = &quot;Manchester urban and temperature relationship&quot;)+ geom_smooth(method=&#39;lm&#39;, se=FALSE)+ theme_classic()+ theme(plot.title = element_text(hjust = 0.5)) # interactive plot ggplotly(heat) How about plotting the whole dataset rather than a random subset… computeddatadf&lt;-as.data.frame(computeddata) names(computeddatadf)&lt;-c(&quot;Temperature&quot;, &quot;Urban&quot;) hexbins &lt;- ggplot(computeddatadf, aes(x=Urban, y=Temperature) ) + geom_hex(bins=100, na.rm=TRUE) + labs(fill = &quot;Count per bin&quot;)+ geom_smooth(method=&#39;lm&#39;, se=FALSE, size=0.6)+ theme_bw() ggplotly(hexbins) 7.11 Statistical summary To see if our varaibles are related let’s run some basic correlation stat.sig=cor.test(computeddatadf$Temperature, computeddatadf$Urban, use = &quot;complete.obs&quot;, method = c(&quot;pearson&quot;)) stat.sig ## ## Pearson&#39;s product-moment correlation ## ## data: computeddatadf$Temperature and computeddatadf$Urban ## t = 393.67, df = 198268, p-value &lt; 2.2e-16 ## alternative hypothesis: true correlation is not equal to 0 ## 95 percent confidence interval: ## 0.6598805 0.6648217 ## sample estimates: ## cor ## 0.6623583 Let’s walk through the results here… t: is the t-test statistic value, we can work out the critical t value using: abs(qt(0.05/2, 198268)) ## [1] 1.959976 As our t values is &gt; than the critial value we can say that there is a relationship between the datasets. However, we would normally report the p-value… df: is the number of values we have -2… length(computeddatadf$Temperature) ## [1] 315536 # but some are NA removena&lt;-na.omit(computeddatadf) length(removena$Temperature) ## [1] 198270 length(removena$Urban) ## [1] 198270 p-value: tells us wheather there is a statistically significant correlation between the datasets and if that we can reject the null hypothesis if p&lt;0.05 (there is a 95% chance that the relationship is real). cor: Pearon’s correlation coefficient 95 percent confidence interval: 95% confident that the population correlation coeffieicent is within this interval As p&lt;0.05 is shows that are variables are have a statistically significant correlation… so as urban area (assuming the index in representative) per pixel increases so does temperature…therefore we can reject our null hypothesis… but remember that this does not imply causation!! If you want more information on statistics in R go and read YaRrr! A Pirate’s Guide to R, chapter 13 on hypothesis tests. 7.12 Considerations If you wanted to explore this type of analysis further then you would need to consider the following: Other methods for extracting temperature from Landsat data Validation of your temperature layer (e.g. weather station data) The formula used to calculate emissivity — there are many The use of raw satellite data as opposed to remove the effects of the atmosphere. Within this practical we have only used relative spatial indexes (e.g. NDVI). However, if you were to use alternative methods it might be more appropraite to use surface reflectance data (also provided by USGS). 7.13 Extension Already an expert with raster data and R? Here we have just looked at one temperature image and concluded that urban area and temperature are realted, but does that hold true for other time periods? If you found this practical straightforward source some Landsat data for an area of interest and create some R code to explore the temporal relationship between urban area and temperature. …Or run the analysis with different data and methods. Data: MODIS daily LST: https://modis.gsfc.nasa.gov/data/dataprod/mod11.php MODIS imagery: https://modis.gsfc.nasa.gov/ Methods: Supervised or unsupervised landcover classificaiton: https://rspatial.org/rs/5-supclassification.html# Here you could classify an image into several landcover classes and explore their relationship with temperature 7.14 References Thanks to CASA gradaute student Matt Ng for providing the outline to the start of this practical Avdan, U. and Jovanovska, G., 2016. Algorithm for automated mapping of land surface temperature using LANDSAT 8 satellite data. Journal of Sensors, 2016. Guha, S., Govil, H., Dey, A. and Gill, N., 2018. Analytical study of land surface temperature with NDVI and NDBI using Landsat 8 OLI and TIRS data in Florence and Naples city, Italy. European Journal of Remote Sensing, 51(1), pp.667-678. Weng, Q., Lu, D. and Schubring, J., 2004. Estimation of land surface temperature–vegetation abundance relationship for urban heat island studies. Remote sensing of Environment, 89(4), pp.467-483. Young, N.E., Anderson, R.S., Chignell, S.M., Vorster, A.G., Lawrence, R. and Evangelista, P.H., 2017. A survival guide to Landsat preprocessing. Ecology, 98(4), pp.920-932. Zha, Y., Gao, J. and Ni, S., 2003. Use of normalized difference built-up index in automatically mapping urban areas from TM imagery. International journal of remote sensing, 24(3), pp.583-594. 7.15 Remote sensing background (optional) Landsat sensors capture reflected solar energy, convert these data to radiance, then rescale this data into a Digital Number (DN), the latter representing the intensity of the electromagnetic radiation per pixel. The range of possible DN values depends on the sensor radiometric resolution. For example Landsat Thematic Mapper 5 (TM) measures between 0 and 255 (termed 8 bit), whilst Landsat 8 OLI measures between 0 and 65536 (termed 12 bit). These DN values can then be converted into Top of Atmosphere (TOA) radiance and TOA reflectance through available equations and known constants (https://landsat.usgs.gov/landsat-8-l8-data-users-handbook-section-5¬) that are preloaded into certain software. The former is how much light the instrument sees in meaningful units whilst the latter removes the effects of the light source. However, TOA reflectance is still influenced by atmospheric effects. These atmospheric effects can be removed through atmospheric correction achievable in software such as ENVI and QGIS to give surface reflectance representing a ratio of the amount of light leaving a target to the amount of light striking it. We must also consider the spectral resolution of satellite imagery, Landsat 8 OLI has 11 spectral bands and as a result is a multi-spectral sensor. As humans we see in the visible part of the electromagnetic spectrum (red-green-blue) — this would be three bands of satellite imagery — however satellites can take advantage of the rest of the spectrum. Each band of Landsat measures in a certain part of the spectrum to produce a DN value. We can then combine these values to produce ‘colour composites’. So a ‘true’ colour composite is where red, green and blue Landsat bands are displayed (the visible spectrum). Based on the differing DN values obtained, we can pick out the unique signatures (values of all spectral bands) of each land cover type, termed spectral signature. For more information read Young et al. (2017) A survival guide to Landsat preprocessing: https://esajournals.onlinelibrary.wiley.com/doi/pdf/10.1002/ecy.1730 7.16 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["online-mapping.html", "Chapter 8 Online mapping 8.1 Learning objectives 8.2 Recommended listening 8.3 Introduction 8.4 RPubs 8.5 RMarkdown site generator 8.6 Shiny 8.7 How to lie with maps 8.8 Warning 8.9 Advanced online publishing 8.10 Feedback", " Chapter 8 Online mapping 8.1 Learning objectives By the end of this practical you should be able to: Descrbie and explain different methods for producing online maps Create interative maps using RPubs, RMarkdown site generator and Shiny Critically appraise the appropriateness of mapping technqiues based on the dataset and purpose of the output map 8.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy 8.3 Introduction In this practical we are going to preliminary stages of a mini-investigation. Since 2015 the law has capped short-term lets in London at 90 nights per year. However, this is very hard to enforce due to a lack of data and extensive evidence required to prove that the limit has been exceeded. Whilst Air bnb have implemented a system the removes listings once they have been rented for 90 days per year unless an appropraite permit is in place we want to interactively visualise the the number of air bnb lettings (and hotels for comparison) per borough as a starting point. This could then be used to undertake further investigation into boroughs with high short term lets, for example exploring other websites to see if the properties are listed and jointly exceed 90 days or optimising localised monitoring. As these rules only apply to entire homes we will only extract only these, and for monitoring purposes (e.g. random annual inspections) those are availbale for 365 days of the year. We will now explore several ways to do this… 8.4 RPubs One of the most straight forward publishing tools is RPubs. It takes an .Rmd and directly uploads it to rpubs.com — all files are publically available on this website. To start with you need to make a free account. Go to: https://rpubs.com/users/new and register Create a new project in RStudio and open a new R Markdown file (File &gt; New File &gt; R Markdown) You’ll see that the file is automatically populated with some information, have a read through it then click the Knit icon (if you remember we covered this in [Knitting your output])… Let’s make some changes to your .Rmd. Delete all the text and code except from header inforamtion (that is enclosed by three dashes at the top of the file) Insert a new code chunk (go back to RMarkdown if you need a refresher) and add some code of your choice from either a previous practical or your own work. As it’s a new project you’ll have to either copy the data into your project folder or set the working directory setwd(). If it’s all online data that you’ve loaded directly from the web into R, this shouldn’t be an issue. I’m going to use the interactive map we made in practical 5 (the Advanced interactive map section)…..Here is the code i’ve put in my chunk: library(sf) library(tmap) library(leafpop) library(leaflet) library(tmaptools) library(tidyverse) library(plyr) OSM &lt;- st_read(&quot;data/gis_osm_pois_a_free_1.shp&quot;) Londonborough &lt;- st_read(&quot;data/London_Borough_Excluding_MHW.shp&quot;) Airbnb &lt;- read_csv(&quot;data/listings.csv&quot;) # plot xy data Airbnb &lt;- st_as_sf(Airbnb, coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326) # reproject OSM &lt;- st_transform(OSM, 27700) Airbnb &lt;- st_transform(Airbnb, 27700) # we don&#39;t need to reproject Londonborough, but it # doesn&#39;t have a CRS..you could also use set_crs # it needs to have one for the next step Londonborough&lt;- st_transform(Londonborough, 27700) #select hotels only OSM &lt;- OSM[OSM$fclass == &#39;hotel&#39;,] # this bit of code would reduce our Airbnb data # to entire places and available all year Airbnb &lt;- Airbnb[Airbnb$room_type == &#39;Entire home/apt&#39; &amp; Airbnb$availability_365==&#39;365&#39;,] # make a function for the join # functions are covered in practical 7 # but see if you can work out what is going on # hint all you have to do is replace data1 and data2 # with the data you want to use Joinfun &lt;- function(data1, data2) { # join OSM and London boroughs joined &lt;- st_join(data1, data2, join = st_within) # count the number of hotels per borough countno &lt;- as.data.frame(count(joined$GSS_CODE)) # join the count back to the borough layer counted &lt;-left_join(data2, countno, by=c(&quot;GSS_CODE&quot;=&quot;x&quot;)) return(counted) } # use the function for hotels Hotels &lt;- Joinfun(OSM, Londonborough) # then for airbnb Airbnb &lt;- Joinfun(Airbnb, Londonborough) # now try to arrange the plots with tmap breaks = c(0, 5, 12, 26, 57, 286) #change the column name from freq for the legend colnames(Hotels)[colnames(Hotels)==&quot;freq&quot;] &lt;- &quot;Accom count&quot; #join data ti&lt;-st_join(Airbnb, Hotels) ti&lt;-st_transform(ti,crs = 4326) #remove the geometry for our pop up boxes to avoid #the geometry field ti2&lt;-ti st_geometry(ti2)&lt;-NULL popairbnb=popupTable(ti2, zcol=c(&quot;NAME.x&quot;, &quot;GSS_CODE.x&quot;, &quot;freq&quot;)) pophotels=popupTable(ti2, zcol=c(&quot;NAME.x&quot;, &quot;GSS_CODE.x&quot;, &quot;Accom count&quot;)) tmap_mode(&quot;view&quot;) # set the colour palettes using our previously defined breaks pal &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain=ti2$freq, bins=breaks) pal2 &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain=ti2$`Accom count`, bins=breaks) map&lt;- leaflet(ti) %&gt;% # add basemap options addTiles(group = &quot;OSM (default)&quot;) %&gt;% addProviderTiles(providers$Stamen.Toner, group = &quot;Toner&quot;) %&gt;% addProviderTiles(providers$Stamen.TonerLite, group = &quot;Toner Lite&quot;) %&gt;% addProviderTiles(providers$CartoDB.Positron, group = &quot;CartoDB&quot;)%&gt;% #add our polygons, linking to the tables we just made addPolygons(color=&quot;white&quot;, weight = 2, opacity = 1, dashArray = &quot;3&quot;, popup = popairbnb, fillOpacity = 0.7, fillColor = ~pal(freq), group = &quot;Airbnb&quot;)%&gt;% addPolygons(fillColor = ~pal(`Accom count`), weight = 2, opacity = 1, color = &quot;white&quot;, dashArray = &quot;3&quot;, popup = pophotels, fillOpacity = 0.7,group = &quot;Hotels&quot;)%&gt;% # add a legend addLegend(pal = pal2, values = ~`Accom count`, group = c(&quot;Airbnb&quot;,&quot;Hotel&quot;), position =&quot;bottomleft&quot;) %&gt;% # specify layers control addLayersControl( baseGroups = c(&quot;OSM (default)&quot;, &quot;Toner&quot;, &quot;Toner Lite&quot;, &quot;CartoDB&quot;), overlayGroups = c(&quot;Airbnb&quot;, &quot;Hotels&quot;), options = layersControlOptions(collapsed = FALSE) ) # plot the map map Add some text at the start of your .Rmd you can include titles and subtitle using # followed by a space, a second level subtitle would be ##, and third ### # Title ## Second sub title ### Third sub title Save the file, Knitt it to HTML, this should be default and specified in the header — enclosed by three dashes. Once knitted you can easily publish the file to Ppubs using the Publish icon either in the viewer pane or the toolbar area (by run) Now how about adding a few design features…i’ve changed my header section to… --- title: &quot;publishexample&quot; output: html_document: theme: yeti smart: true highlight: textmate toc: true number_sections: true toc_float: collapsed: false smooth_scroll: true --- Knit and then publish again…you’ll notice a few aesthetic changes To learn more about these go explore: https://bookdown.org/yihui/rmarkdown/html-document.html http://www.datadreaming.org/post/r-markdown-theme-gallery/ https://cran.r-project.org/web/packages/prettydoc/vignettes/architect.html And for more code chunk control.. https://bookdown.org/yihui/rmarkdown/r-code.html https://rmarkdown.rstudio.com/lesson-3.html 8.5 RMarkdown site generator 8.5.1 Set the file structure RPubs are useful but what if you wanted to make a full site with different tabs for introduction, methodology, results and recommedations…one way is to use the RMarkdown site generator hosted on GitHub RMarkdown site generator is useful as it does not require any third-party add ons like blogdown which is reliant on the hugo site generator To make a site you’ll need the following to be within your project: A configuration file with the filename _site.yml An index.Rmd Any other .Rmd files you want to create into pages on the site For the site to work you only require (a) and (b)….but that would be a pretty boring site… In your new project add two new RMarkdown files called: _site.yml index.Rmd In the _site.yml remove all code and add the following name: &quot;Hello world&quot; output_dir: &quot;.&quot; navbar: title: &quot;My example website&quot; left: - text: &quot;Home&quot; href: index.html - text: &quot;About&quot; href: publishexample.html 8.5.2 Link to GitHub There are two ways to do this…. 8.5.2.1 GitHub first This is the ‘easy’ way as you woould repeat the steps in Practical 4 by firstly making a new repository on GitHub then loading a new project in RStudio, linking that to GitHub and copying all your files into your new project from the exisiting one. 8.5.2.2 GitHub last So if you already have a RStudio project…like we do…we can link this to GitHub but the steps are a bit more invovled and there are several ways to acheive it — as with most things in R. Make a Git repo in RStudio. Go to Tools &gt; Project Options &gt; Git/SVN and select Git under Version control system and initialize a new repository, then restart RStudio. The Git tab should appear.. Next we need to make a new repository on GitHub. Go to GitHub, login and make a new repository. Make sure that it is empty with no README.. you should have something similar to this appear: Clone the repository by copying the HTTPS Make one local commit. Under the Git tab &gt; Diff &gt; Stage the files &gt; Add a commit message and click commit Now we need to connect our local repository to the GitHub one. So Under the Git tab you’ll the new brach button (two purple boxes linked to a white box)… Click it &gt; Add Remote. Paste in the URL use the remote name origin and the branch name of master — which you can get from the GitHub Quick setup screen after creating your repo. Check sync the branch with the remote &gt; click create then select overwrite Push the files to your GitHub and they will appear on your GitHub repo Next we need to actually build the site…there are a few ways to do this…Go to the Git tab you should see the Build tab, if you can’t then go to Tools &gt; Project Options &gt; Build Tools and select website under Project build tools. Now click Build Website under the build tab Alternatively you write the following in the console rmarkdown::render_site() If you wanted to just build a page from your site — say if you have made a rather big site with lots of analysis use: rmarkdown::render_site(&quot;index.Rmd&quot;) Stage, commit and then push the files to your GitHub. I had some issues staging the site_libs folder in the Git tab. I fixed it by closing and reloading my R project then clicking the cog symbol (under Git tab) &gt; Shell and typing git add . If you get an error message about the index file being locked… go and delete it and try again. If you can’t delete restart the machine and try again. You will find it in the .git folder within your project. Once git add . runs you should see all the files staged, be able to commit and then push the changes to GitHub Help: https://stackoverflow.com/questions/5834014/lf-will-be-replaced-by-crlf-in-git-what-is-that-and-is-it-important https://stackoverflow.com/questions/9282632/git-index-lock-file-exists-when-i-try-to-commit-but-cannot-delete-the-file So your ‘built’ website is up on GitHub, but you need to tell it where to build the site from…Go to your GitHub repo &gt; Settings, scroll down to GitHub pages and select the Source as the master branch Click on the link that is provided where your site is published and you should have a website with two tabs. Here is what mine looks like: For more information on hosting your code from RStudio on GitHub check out the book Happy Git and GitHub for the useR My RMarkdown site can be found here, but note that i’ve added a Shiny tab…we’ll cover Shiny next… 8.6 Shiny Shiny is an R package that lets you build interative web apps, host them online and embed them within RMarkdown documents… have a look at some examples To build a shiny you require three main ‘items’ or blocks of code: Code that specfies the user interface or ui Code that defines the server logic to plot variables (server function) A call to the ShinyApp function These could either be within one large .R file or over several .R files. Start a new R Project &gt; New or existing directory &gt; Shiny Web Application Within your new R Project folder make a new folder called data and copy in the data we have been using The main purpose of this part of the practical is to show you how to use Shiny so we won’t make a Git repository. Go File &gt; New File &gt; Shiny Web App Here you can select either a single file or multiple file format, originally Shiny needed multiple files to run however in the latest version you can have this all in one script, i’ve just used one script here. If you click Run App on either the app.R the example Shiny will load. Now let’s make one with our data… 8.6.1 Data preparation The first part is easy and is based on analysis we have already compelted…we need to produce a sf multipolygon layer containing the number of hotels and airbnbs per London borough through…. # load packages library(sf) library(tmap) library(leafpop) library(leaflet) library(tmaptools) library(tidyverse) library(plyr) library(classInt) # read in OSM OSM &lt;- st_read(&quot;data/gis_osm_pois_a_free_1.shp&quot;) # read in Londonboroughs Londonborough &lt;- st_read(&quot;data/London_Borough_Excluding_MHW.shp&quot;) # read in Airbnb Airbnb &lt;- read_csv(&quot;data/listings.csv&quot;) # plot xy data Airbnb &lt;- st_as_sf(Airbnb, coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326) # reproject OSM &lt;- st_transform(OSM, 27700) Airbnb &lt;- st_transform(Airbnb, 27700) # we don&#39;t need to reproject Londonborough, but it # doesn&#39;t have a CRS..you could also use set_crs # it needs to have one for the next step Londonborough&lt;- st_transform(Londonborough, 27700) #select hotels only OSM &lt;- OSM[OSM$fclass == &#39;hotel&#39;,] Airbnb &lt;- Airbnb[Airbnb$room_type == &#39;Entire home/apt&#39; &amp; Airbnb$availability_365==&#39;365&#39;,] # make a function for the join # functions are covered in practical 7 # but see if you can work out what is going on # hint all you have to do is replace data1 and data2 # with the data you want to use Joinfun &lt;- function(data1, data2) { # join OSM and London boroughs joined &lt;- st_join(data1, data2, join = st_within) # count the number of hotels per borough countno &lt;- as.data.frame(count(joined$GSS_CODE)) # join the count back to the borough layer counted &lt;-left_join(data2, countno, by=c(&quot;GSS_CODE&quot;=&quot;x&quot;)) return(counted) } # use the function for hotels Hotels &lt;- Joinfun(OSM, Londonborough) # then for airbnb Airbnb &lt;- Joinfun(Airbnb, Londonborough) # now try to arrange the plots with tmap breaks = c(0, 5, 12, 26, 57, 286) #change the column name from freq for the legend colnames(Hotels)[colnames(Hotels)==&quot;freq&quot;] &lt;- &quot;Accom count&quot; #join data ti&lt;-st_join(Airbnb, Hotels, join=st_equals) ti&lt;-st_transform(ti,crs = 4326) # change the names to match those in later selection names(ti)[names(ti) == &quot;freq&quot;] &lt;- &quot;Airbnb&quot; names(ti)[names(ti) == &quot;Accom count&quot;] &lt;- &quot;Hotel&quot; # combine all the data (accomodation count) so we # can make an appropraite colour range accomall&lt;-c(ti$`Hotel`,ti$Airbnb) Now we are going to take our data to make an interative map with drop down selection boxes and a ‘slider’. We want to be able to: select either Hotel or Airbnb data to map be able to select a colour scheme filter the boroughs shown using a slider select what kind of intervals we can use to style the data have a legend that automatically updates based on the selections (e.g. slider, colour scheme and interval style) There are plenty of options available in Shiny to make cool interactive features, for more information check out: https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/ https://rstudio.github.io/leaflet/shiny.html Load the packages we’ll need here and do some final data manipulation. Just add this right below the code above, i seperate it using a line of ########################## ################################################## final data manipulation library(shiny) library(leaflet) library(RColorBrewer) # we will use this for our dropdown choice=c(&quot;Hotel&quot;, &quot;Airbnb&quot;) # remove any NAs from our data and replace with 0 #as a function later on doesn&#39;t play ball with them ti$Hotel[is.na(ti$Hotel)] &lt;- 0 ti$Airbnb[is.na(ti$Airbnb)] &lt;- 0 8.6.2 User interface Ok, first let’s set up the user interface or ui. I’ve commented the code to descrbie what each bit does. ################################################## ui # we&#39;ll use bootstrappage - a UI definition that can be passed to Shiny ui &lt;- bootstrapPage( tags$style(type = &quot;text/css&quot;, &quot;html, body {width:100%;height:100%}&quot;), # we&#39;re using leaflet and have title the outputID map # this will call it from our server function below leafletOutput(&quot;map&quot;, width = &quot;100%&quot;, height = &quot;100%&quot;), # this sets our input panel placement absolutePanel(top = 10, right = 10, # #our ID will be called later to make it interactive selectInput(inputId = &quot;Accom&quot;, # label the drop down label = &quot;Accom type&quot;, # what choices will there be # this uses our choices list from # earlier choices = choice, # Here False means you can only select # one option multiple = FALSE ), #gimme some colour options from colourbrewer # here the inoutID is colourbrewerpalette # the lavel is Color Scheme # rownames provides our choices selectInput(&quot;colourbrewerpalette&quot;, &quot;Color Scheme&quot;, rownames(subset(brewer.pal.info, category %in% c(&quot;seq&quot;, &quot;div&quot;))) ), # add a slider with the ID slide and label # accomodation count sliderInput(&quot;slide&quot;, &quot;Accomodation count&quot;, # min slider value min(accomall, na.rm=TRUE), # max slider value max(accomall, na.rm = TRUE), # range value = range(accomall, na.rm = TRUE), # increments step = 10, sep = &quot;&quot; ), # add a selection for type of data break # ID of cassIntStyle and title # Interval Style selectInput(&quot;classIntStyle&quot;, &quot;Interval Style&quot;, c(&quot;Jenks Natural Breaks&quot; = &quot;jenks&quot;, &quot;Quantile&quot; = &quot;quantile&quot;, &quot;Equal Interval&quot; = &quot;equal&quot;, &quot;Pretty&quot; = &quot;pretty&quot;)) ) ) 8.6.3 Server function It’s a good idea to actuallly see what this produces…at the bottom of the code add an empty server function and then generate the Shiny application BE SURE TO COPY ALL OF BRACKETS ####################################### server server &lt;- function(input, output, session) { } shinyApp(ui, server) Click Run App and the following should appear Now we need to add some more code to our server function to let us link the user interface to the data. Change the server function to: ####################################### server server &lt;- function(input, output, session) { output$map &lt;- renderLeaflet({ # Use leaflet() here, and only include aspects of the map that # won&#39;t need to change dynamically (at least, not unless the # entire map is being torn down and recreated). # note we&#39;re using the ID of map calling back to leafletOutput # in the user interface leaflet(ti) %&gt;% addTiles() %&gt;% setView(-0.0881798, 51.48932, zoom = 10) }) # obsever creates a reactive observer to then re-execute any changes observe({ # filter the data of ti based on the range provided by the slider (ti2&lt;-({ti[ti[[input$Accom]] &gt;= input$slide[1] &amp; ti[[input$Accom]] &lt;= input$slide[2],]})) # here we are changing the class breaks using the selection of either # airbnb or hotel input$Accom uses what the user selects from # the drop down box breaks&lt;-classIntervals(ti2[[input$Accom]], n=5, style=input$classIntStyle) breaks &lt;- breaks$brks # make the color palette using ti (all of the data) pal &lt;- colorBin(palette = input$colourbrewerpalette, domain = ti2[[input$Accom]], bins = breaks ) # map our filtered data from the slider (ti2) leafletProxy(&quot;map&quot;, data=ti2) %&gt;% clearShapes() %&gt;% addPolygons(color=&quot;white&quot;, weight = 2, opacity = 1, dashArray = &quot;3&quot;, # add a popup of borough name and count based on # the drop down of accomodation (hotel or airbnb) # remember the ID we gave to that was Accom popup = paste(ti2$NAME.y,&quot;... &quot;,ti2[[input$Accom]]), fillOpacity = 0.5, fillColor = ~pal(ti2[[input$Accom]]) ) }) observe({ # call the filter again for this observer (ti2&lt;-({ti[ti[[input$Accom]] &gt;= input$slide[1] &amp; ti[[input$Accom]] &lt;= input$slide[2],]})) # this observer follows the same pattern # but adds a legend breaks&lt;-classIntervals(ti2[[input$Accom]], n=5, style=input$classIntStyle) breaks &lt;- breaks$brks pal &lt;- colorBin(palette = input$colourbrewerpalette, domain = ti2[[input$Accom]], #create bins using the breaks object from earlier bins = breaks ) # here is the Legend proxy &lt;- leafletProxy(&quot;map&quot;, data = ti2) proxy %&gt;% clearControls() %&gt;% addLegend(&quot;bottomright&quot;, pal= pal, values = ~ti2[[input$Accom]], title = input$Accom, labFormat = labelFormat(prefix = &quot;&quot;), opacity = 1 ) }) } Don’t forget to call the Shinyapp at the end shinyApp(ui, server) 8.6.4 Publish Shiny app Now we will publish our Shiny app on the internet. There are a few ways to do this, but we’ll use Shinyapps.io which let’s us upload our app straight from our R session to a sever hosted by RStudio. Go to: https://www.shinyapps.io/ and make a free account Back in RStudio click on Publish &gt; Publish Application You now need to connect RStudio to the Shinyapps.io account you just made. Follow the instructions provided in this box: You’ll find the tokens under Account &gt; Tokens. Make sure you click show secret then copy the code into the box in the figure above. You can now publish your Shinyapp, this might take a bit of time but you can see progress updates in the Deploy tab. Once completed the application will load… Mine is here: https://amaclachlan.shinyapps.io/test/ 8.6.5 Incoproate into RMarkdown site To include our Shiny application into our RMarkdown site just add the following code in a code chunk: knitr::include_app(&quot;https://amaclachlan.shinyapps.io/Airbnb/&quot;, height = &quot;700px&quot;) Here is mine in the RMarkdown site project — i’ve put it in a new .Rmd If you copy this make sure you also update the _site.yml to link it… Remember to update your site you’ll need to build the website, commit to Git and push to GitHub 8.6.6 Additional example Last year Adam created a similar (but slightly different) Shiny, check it out here His code can be found here Notice how Adam separated his code into different files…the latest update of Shiny means we no longer have to do this, we can just use one script like we did. However, if you have a very large and complicated project this is still possible, you can then call other scripts like Adam has using… # change londongrapher.r to the script you are calling source(&quot;londongrapher.r&quot;) To do it like this the scrips must be in the same project! Want to see something really cool i came across….how about controlling the map elements with your voice using Shiny…https://yihui.shinyapps.io/voice/ 8.6.7 More Shiny For Shiny help explore Mastering Shiny and Interactive web-based data visualization with R, plotly, and shiny, specifcally the section on Advanced applications. For advancements / large scale projects with Shiny explore Building Big Shiny Apps - A Workflow 8.7 How to lie with maps If you play around with the Shiny app, changing the colour scheme, interval style and accomodation count using the slider you’ll notice that you can actually almost change what the maps shows. For example, if you wanted to hide the distribution of Airbnb accomodation over London you could select any color scheme, use the full range of accomodation count and then select the pretty interval style to give some like… It’s therefore important to provide reasoning for the choices you make in analysis and when creating mapped outputs. This especially true with the advent of GitHub and journals publishing data and code meaning it is almost impossible to present false representations of analysis. 8.8 Warning Whilst it might seem tempting to use the most advanced interactive maps for your the assignments within this module and course it is important to think and reflect upon the appropriateness of the mapped output. You should ask yourself the following questions: What am i trying to show with this map Will interative elements aid this in anyway or just confuse users Is there a more concise way to display this data Do i need all this information — is it all relevant to the message you are trying to portray with the map In all these examples i’ve used the same data (Hotels and Airbnbs in London boroughs), however as i’m only showing two datasets could this be represeted without all this complexity?— in this case the answer really depends on the audience you are tyring to get something across to. For example, for use in an academic journal, as there are only two data sets being mapped a static map like we produced in the Map making practical would be more appropraite. However an interative map (similar to what we have produced) might be more useful for incorpation on a website… The take home message from this is to critically think about the best way to map and disseminate your data/results. 8.9 Advanced online publishing Already familiar with RPubs, RMarkdown site generator or Shiny? Try and and produce an online document using either: bookdown, flexdashboard, blogdown or shinydashboard. These are listed in order of difficutly from my experience. Hint this document is made using bookdown, so checkout my GitHub for how i set it up Bookdown: https://bookdown.org/yihui/bookdown/, minimal bookdown example: https://github.com/rstudio/bookdown-demo Flexdashboard: https://rmarkdown.rstudio.com/flexdashboard/ Blogdown: https://bookdown.org/yihui/blogdown/ Interactive Shiny dashboards: https://rstudio.github.io/shinydashboard/get_started.html 8.10 Feedback Was anything that we explained unclear this week or was something really clear…let us know here. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material. "],
["gwr-and-spatially-lagged-regression.html", "Chapter 9 GWR and spatially lagged regression 9.1 Learning outcomes 9.2 Recommended listening", " Chapter 9 GWR and spatially lagged regression Coming soon 9.1 Learning outcomes 9.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy "],
["advanced-r-maup-and-more-regression.html", "Chapter 10 Advanced R, MAUP and more regression 10.1 Learning outcomes 10.2 Recommended listening 10.3 Introduction 10.4 MAUP 10.5 Regression relationships 10.6 Advanced regression 10.7 More resources 10.8 Extension 10.9 Acknowledgement", " Chapter 10 Advanced R, MAUP and more regression 10.1 Learning outcomes Describe, explain and visualise the MAUP problem Design and use loops and functions Execute linear, Ridge and LASSO regression to predict values (e.g. future or missing) Critically evaluate different regression approaches 10.2 Recommended listening Some of these practicals are long, take regular breaks and have a listen to some of our fav tunes each week. Andy 10.3 Introduction The Modifiable Areal Unit Problem (MAUP) represents the related effects of scale and aggregation on all geographic data and analysis. It was first deomstrated by the geographer Stan Openshaw in 1984 who showed that as you aggregated results to diffrent spatial units the reults could be manipulated to show different outcomes. Throughout this practical book we’ve considered London boroughs, but would any of the results change if we considered the data at ward level? Are we hiding any trends because we have just used the borough data that summed all of the wards within the borough? It’s important to consider what is the most appropraite spatial unit for your analysis and provide appropraite reasoning. Even this is pretty straightforward (e.g. the data was only provided at the borough level) you must contextualise this and describe any potential limitations of it. In this practical i will firstly demonstrate the MAUP in action using some more advanced R code. Then we will have a look at some technqieus to model and validate data. Here we will be using London brough and ward data from practical 1. As we’re getting better with R, we will try to automate almost everthing — meaning that if you gave this code to someone else they could just run it without any data files and generate the same result. The only thing we won’t automate later on is loading an excel file… i did find a function online that would let us read it from the interweb but it was more hassle than it was worth. I don’t know why the data isn’t just also distributed as a .csv. 10.4 MAUP 10.4.1 Get the data Download and unzip the London statistical gis boundaries. # make a temp file to store the .zip in library(sf) temp &lt;- tempfile() download.file(&quot;https://data.london.gov.uk/download/statistical-gis-boundary-files-london/9ba8c833-6370-4b11-abdc-314aa020d5e0/statistical-gis-boundaries-london.zip&quot;,temp) # unzip data into a folder (exdir) of your choice data &lt;- unzip(temp, exdir=&quot;prac10_data&quot;) # unlink the temp file unlink(temp) Using a recent update we could also change this a bit with the pins() package that downlaods and caches the url and automatically checks for file changes, only re-downloading if needed! library(pins) pinexample&lt;-pin(&quot;https://data.london.gov.uk/download/statistical-gis-boundary-files-london/9ba8c833-6370-4b11-abdc-314aa020d5e0/statistical-gis-boundaries-london.zip&quot;) pins() also lets you share data easily, have a look at this blog for more information Take the downloaded data and filter it based on the filename that countains: Borough OR Ward_ AND .shp using grepl() #|= OR # change data to pinexample to use result from pins t&lt;-grepl(&quot;Borough|Ward_&quot;, data) &amp; grepl(&quot;.shp$&quot;, data) t ## [1] FALSE FALSE FALSE FALSE FALSE FALSE TRUE FALSE FALSE FALSE FALSE ## [12] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE ## [23] FALSE FALSE FALSE FALSE FALSE FALSE TRUE FALSE FALSE FALSE FALSE ## [34] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE ## [45] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE ## [56] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE ## [67] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE ## [78] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE ## [89] FALSE FALSE FALSE FALSE FALSE FALSE FALSE t just gives an index of where the values are equal to what we specified. We then need to use it to subset from our original data… boroughsandwards&lt;-data[t] Now read in both of the files using lapply() that applies a function (here st_read()) to a list boroughsandwardssf&lt;-lapply(boroughsandwards, st_read) ## Reading layer `London_Borough_Excluding_MHW&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac10_data\\statistical-gis-boundaries-london\\ESRI\\London_Borough_Excluding_MHW.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 33 features and 7 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs ## Reading layer `London_Ward_CityMerged&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac10_data\\statistical-gis-boundaries-london\\ESRI\\London_Ward_CityMerged.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 625 features and 7 fields ## geometry type: POLYGON ## dimension: XY ## bbox: xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9 ## epsg (SRID): NA ## proj4string: +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601272 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs To map or access each individual shapefile it’s just… library(tmap) qtm(boroughsandwardssf[[2]]) # or change to 1 Get the data for Airbnb library(tidyverse) Airbnb &lt;- read_csv(&quot;http://data.insideairbnb.com/united-kingdom/england/london/2019-07-10/visualisations/listings.csv&quot;) And for OSM we’ll download it from geofabrik, you can also use the OSM Application Programming Interface (API) but there is a limit on the number of points downloadable per call so you’d have to do something a bit more complicated to get the whole of London…however, I have provided an example of the api call. library(memisc) temp2 &lt;- tempfile() download.file(&quot;http://download.geofabrik.de/europe/great-britain/england/greater-london-latest-free.shp.zip&quot;, mode=&#39;wb&#39;, temp2) # unzip into data data &lt;- unzip(temp2, exdir=&quot;prac10_data&quot;) # unlink the temp file unlink(temp2) Example of using the API…. library(osmar) src &lt;- osmsource_api(url = &quot;https://api.openstreetmap.org/api/0.6/&quot;) # 1000 refers to distance from centre point bb &lt;- center_bbox(-0.112510,51.507627, 1000, 1000) LDN &lt;- get_osm(bb, source = src) plot(LDN) # extract just highwways ways &lt;- find(LDN, way(tags(k == &quot;highway&quot;))) hway &lt;- find_down(LDN, way(ways)) hway &lt;- subset(LDN, ids = hway) 10.4.2 Project the data Next up we need to project our .shp data …we could project our data indiviudally using: st_transform(boroughsandwardssf[[1]], 27700) st_transform(boroughsandwardssf[[2]], 27700) or use lapply() again… library(plyr) boroughsandwardssf&lt;- lapply(boroughsandwardssf, crs=27700, st_transform) # change the airbnb data to spatial Airbnb &lt;- st_as_sf(Airbnb, coords = c(&quot;longitude&quot;, &quot;latitude&quot;), crs = 4326) # project it too - remember that 27700 is # British National Grid Airbnb &lt;- st_transform(Airbnb, 27700) 10.4.3 Functions Now remember our function we made for joining our Airbnb data (or Hotels) to the London boroughs layer… let’s make the fucntion again… Joinfun &lt;- function(data1, data2) { # join OSM and London boroughs joined &lt;- st_join(data1, data2, join = st_within) # count the number of hotels per borough countno &lt;- as.data.frame(plyr::count(joined$GSS_CODE)) # join the count back to the borough layer counted &lt;-left_join(data2, countno, by=c(&quot;GSS_CODE&quot;=&quot;x&quot;)) return(counted) } 10.4.4 Loops Ok, but we want to get a count of Airbnb points per London ward and Borough…how can we do that?…well manually of course…like this… Airbnbborough &lt;- Joinfun(Airbnb, boroughsandwardssf[[1]]) Airbnbward &lt;- Joinfun(Airbnb, boroughsandwardssf[[2]]) But we can also autmoate this using a loop (either a while or for loop). I’ve used a while loop here as when i did my MSc you weren’t able to put a for loop inside a for loop. I beleive that has now changed but because of that one day i had to spend changing everything i always default to using a while loop. Tell us what a loop is aleady? A loop let’s you go over something adding 1 (or any value) each time…for example let’s look a basic loop. You need to run everything in the loop at once from the while to the }. If you make just a normal Rscript you can set breakpoints — the code will the stop each time it hits the breakpoint within the loop. You can’t do this at the moment with RMarkdown code chunks, i normally develop the loop outside of it looping then put it all together. # set up a variable basicloop &lt;- 1 # so while our variable is less than #6 run the following code within the {} while (basicloop &lt; 6) { #print the varaible (starts at 1) print(basicloop) # then add 2 to the variable basicloop = basicloop+1 # go back to the start of the loop #and if it is still &lt;6 run again } ## [1] 1 ## [1] 2 ## [1] 3 ## [1] 4 ## [1] 5 That loop outputs the values of 1-5, as we started with a value of 1, then added 1 to make 2. It remained below 6 so the code ran again printing the 2 then added 1 again to make 3 and so on. As we specified less than 6 it stopped there.. We can also save these results to diffrent variables but we need to make a list (or dataframe/ whatever you need) to start with to save them in # here is my empty list emptylist &lt;- list() basicloop &lt;- 1 while (basicloop &lt; 6) { print(basicloop) emptylist[[basicloop]] &lt;- basicloop basicloop &lt;- basicloop+1 } ## [1] 1 ## [1] 2 ## [1] 3 ## [1] 4 ## [1] 5 Here we are using the varaible basicloop to index our emptylist.. so everytime we add 1 it changes the index value….have a look what i mean… emptylist ## [[1]] ## [1] 1 ## ## [[2]] ## [1] 2 ## ## [[3]] ## [1] 3 ## ## [[4]] ## [1] 4 ## ## [[5]] ## [1] 5 emptylist[[1]] ## [1] 1 emptylist[[2]] ## [1] 2 Right, so how are we going to apply this to our data. We have two .shp files (boroughs and wards) in a list that we want to apply our function to.. Firstly let’s set up the length to stop at, make an empty list and a starting point. As our data is in a list we just want the length of that (as a number).. # get the length - add 1 as we are using less than boroughlen&lt;-length(boroughsandwardssf)+1 # empty list hold&lt;-list() # here is our starting point variable i&lt;-1 Now here is the loop.. # while i is less than boroughlength # max of boroughlength is 3 while (i &lt; boroughlen){ # put the output in our varible # use the function for boroughs and then wards hold[[i]] &lt;- Joinfun(Airbnb, boroughsandwardssf[[i]]) # add one to the index i&lt;-i+1 } # make a quick thematic map to have a look qtm(hold[[1]], fill = &quot;freq&quot;) qtm(hold[[2]], fill = &quot;freq&quot;) When should i use a loop? Well that’s a hard question…generally loops used to be considered inefficient in R, but i’m yet to come across a method that will let you increment one varibale whilst keeping another consistent …by this i mean like what we did in our loop. We changed what spatial data was joined with the Airbnb data — the Airbnb data remained the same. There are a few other functions like mapply(), sapply() and tapply() that work in the same format as lapply() but to my knowledge they still will increment all of the variables at the same time. In terms of code clarity i’m going to refer to section 21.5 on iteration in Wickham $ Grolemund (2017)… “Some people will tell you to avoid for loops because they are slow. They’re wrong! (Well at least they’re rather out of date, as for loops haven’t been slow for many years). The chief benefits of using ‘other functions’ is not speed, but clarity: they make your code easier to write and to read”. That said, within this course you are not marked on how ‘good’ or ‘efficient’ your code is. Sure, i want you to write great code, but if you are writing code for your assigment or any future project really, my advice is the same. Get something that work and addresses the mark scheme (read the mark scheme!) and then if you have time, improve it later on. There is also a section later on about writing advanced code in the assignment. 10.4.5 Advanced mapping (again) Right, so we can sort of see the difference between the spatial levels (boroughs and wards) but let’s take a closer look within Westminster… here is the ‘preamble’ for the leaflet map …basically all the stuff we need to set it up… library(classInt) library(leaflet) library(leafpop) library(tidyverse) # extract only westminster from boroughs Borough &lt;- hold[[1]][hold[[1]]$NAME==&quot;Westminster&quot;,] # extract only westminster from wards wardsatborough&lt;- hold[[2]][hold[[2]]$BOROUGH==&quot;Westminster&quot;,] # we need to set the projection to WGS84 # to use with leaflet Borough&lt;-st_transform(Borough,crs = 4326) wardsatborough&lt;-st_transform(wardsatborough,crs = 4326) # set our breaks for the map breaks1&lt;-classIntervals(hold[[1]]$freq, n=5, style = &quot;quantile&quot;) breaks2&lt;-classIntervals(wardsatborough$freq, n=5, style = &quot;quantile&quot;) # use the breaks to set our colour palettes pal &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain=hold[[1]]$freq, bins=breaks1$brks) pal2 &lt;- colorBin(palette = &quot;YlOrRd&quot;, domain=wardsatborough$freq, bins=breaks2$brks) # we want a popup of information too # here we make a new varaible with no #spatial info (remove geometry) wardinfo &lt;- as.data.frame(st_set_geometry(wardsatborough, NULL)) boroighinfo &lt;- st_set_geometry(Borough, NULL) # rename the coloumns to tidy up the appearance wardinfo2&lt;-dplyr::rename(wardinfo, Ward = &quot;NAME&quot;, Count = freq) boroighinfo2&lt;-dplyr::rename(boroighinfo, Borough = NAME, Count = freq) # select the coloumns we want to appear in our popup popward &lt;- popupTable(wardinfo2, zcol=c(&quot;Ward&quot;, &quot;Count&quot;)) popborough &lt;- popupTable(boroighinfo2, zcol=c(&quot;Borough&quot;, &quot;Count&quot;)) Now let’s map it using what we just specified… i’ve added a few more features than were in the Map making practical wardandboroughs&lt;- leaflet() %&gt;% # add basemap options addProviderTiles(providers$Stamen.TonerLite, group = &quot;Toner Lite&quot;) %&gt;% addTiles(group = &quot;OSM&quot;) %&gt;% #add our Borough polygons, linking to the tables we just made addPolygons(data=Borough, color=&quot;white&quot;, weight = 2, opacity = 1, dashArray = &quot;3&quot;, fillOpacity = 0.7, popup = popborough, fillColor = ~pal(Borough$freq), group = &quot;Borough&quot;)%&gt;% #add our ward polygons, linking to the tables we just made addPolygons(data=wardsatborough, color=&quot;white&quot;, weight = 2, opacity = 1, dashArray = &quot;3&quot;, fillOpacity = 0.7, popup = popward, fillColor = ~pal2(wardsatborough$freq), group = &quot;Wards&quot;)%&gt;% # add a legend for wards addLegend(pal = pal2, values = wardsatborough$freq, group=c(&quot;Wards&quot;), position =&quot;bottomleft&quot;, title =&quot;Accom count&quot;)%&gt;% # add a legend for boroughs addLegend(pal = pal, values = Borough, group=c(&quot;Borough&quot;), title =&quot;Accom count&quot;, position =&quot;bottomleft&quot;)%&gt;% # specify layers control addLayersControl( baseGroups = c(&quot;Toner Lite&quot;, &quot;OSM&quot;), overlayGroups = c(&quot;Borough&quot;, &quot;Wards&quot;), options = layersControlOptions(collapsed = FALSE))%&gt;% hideGroup(c(&quot;Borough&quot;)) # show us the map wardandboroughs Have a look around the map…Westminster borough uses a scale considering all other London borough values, whilst the ward scale is specific to Westminster. Use the following code to explore the values… # range of Airbnbs per ward in Westminster wardsrange&lt;-c(min(wardsatborough$freq), max(wardsatborough$freq)) wardsrange ## [1] 159 1215 # value of all Airbnbs in Westminster Borough$freq ## [1] 9410 10.5 Regression relationships Warning The data used within this practical is purely for demonstration purposes! 10.5.1 Preprocessing In this part of the practical we’re going to try and model the relationship between the Airbnb counts at ward level and other variables. Our mini investagion here would be to see if it’s possible to produce a statisitcally valid and rigorous model for predicting Airbnb values at the ward level. This type of analysis might be useful if you had missing or limited data at one spatial level (e.g. wards) but had a more complete dataset at a larger spatial scale (e.g. boroughs). Essentially, we’re trying to use the data at the borough level to give us an estiamte of the data at the ward level. Obviously this isn’t an issue for us here but if you ever use survey data or any kind of count data (e.g. health) if may well be limited to specific areas… This section will also show you how to make/ use different regression models in R. Regression aims to find a mathematical equation to predict a value (in this case Airbnb at ward level) from one (or more) predictor variables (e.g. borough data). So we’ll use values of X (borough data) to predict values of Y (ward data)… This can be represented with the equation: \\[Y = \\beta_{1} + \\beta_{2} X + \\epsilon\\] Where \\(\\beta_{1}\\) is the intercept (expected value of Y when X=0, also called bias in machine learning), \\(\\beta_{2}\\) is the slope of the line and \\(\\epsilon\\) is the error term, the part that the model is unable to explain (and variables are not included)… To start with we’re going to crop our wards data to our boroughs data. In the borough data you can see the river Thames which isn’t in the wards data. I don’t think this is technically required, but it’s good practice to make sure you datasets align and if they don’t to do something about it… library(tmaptools) tmp2 &lt;- crop_shape(hold[[2]], hold[[1]], polygon = TRUE) # something like this would just extract the # values within the shape, but not clip like a cookie cutter # we want to use the borough layer to cut out the river from # the wards layer ###test &lt;- hold[[2]][hold[[1]],] # check it worked, you should be #able to see the river plot(sf::st_geometry(tmp2)) Now we need to join our wards data and borough data togther to give us a borough value for each ward within… # join wards and boroughs joined &lt;- st_join(hold[[1]], tmp2, join=st_contains) # rename the coloumns joinednames&lt;-dplyr::rename(joined, Boroughcount = freq.x, Wardcount = freq.y) 10.5.2 Scatter plot To start with let’s just visualise the relationship between the borough an ward count using a scatter plot. If you have multiple predictor variables (explied later on) a plot will be drawn for each of them… scatter.smooth(x=joinednames$Boroughcount, y=joinednames$Wardcount, main=&quot;Borough count ~ Ward count&quot;, xlab=&quot;Borough count&quot;, ylab=&quot;Ward count&quot;) The scatter plot shows some kind of linear relationship. The point variation around borough count is beacuse for each borough the wards will have a range of values…like we saw in the interactive map…Westminster borough had a value of 9410 and the wards ranged from 159 to 1215 10.5.3 Outliers Generally any point that is outside 1.5* the interquartile-range (or IQR) is considered an outlier (a data point that differs significantly from all others) and you could use something like the methods here to remove and replace them…the IQR is the distance between the 25th and 75th percentile.. par(mfrow=c(1, 2)) # divide graph area in 2 columns boxplot(joinednames$Boroughcount, main=&quot;Boroughs&quot;) boxplot(joinednames$Wardcount, main=&quot;Wards&quot;) 10.5.4 Correlation Correlation let’s use see the level of linear dependence between two varaibles between -1 and 1. High values (towards 1) mean that for every x instance there is an increase in y. Low values (towards -1) mean the opposite. stat_sig=cor.test(joinednames$Boroughcount, joinednames$Wardcount, use =&quot;complete.obs&quot;, method = c(&quot;pearson&quot;)) stat_sig ## ## Pearson&#39;s product-moment correlation ## ## data: joinednames$Boroughcount and joinednames$Wardcount ## t = 31.054, df = 622, p-value &lt; 2.2e-16 ## alternative hypothesis: true correlation is not equal to 0 ## 95 percent confidence interval: ## 0.7468991 0.8086811 ## sample estimates: ## cor ## 0.7796805 Have a look back at the Statistical summary under Advanced raster analysis to see what all these values mean. Basically we’ve got a strong relationship that is statistically significant. 10.5.5 Linear model Now let’s use a linear model to establish a relationship between predictor and response with the function lm(). Here we are calling the lm()(then stating the Formula, then the data) linearMod &lt;- lm(Wardcount ~ Boroughcount, data=joinednames) linearMod ## ## Call: ## lm(formula = Wardcount ~ Boroughcount, data = joinednames) ## ## Coefficients: ## (Intercept) Boroughcount ## -3.8188 0.0541 summary(linearMod) ## ## Call: ## lm(formula = Wardcount ~ Boroughcount, data = joinednames) ## ## Residuals: ## Min 1Q Median 3Q Max ## -346.25 -41.02 -3.45 20.50 709.75 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -3.818776 6.099543 -0.626 0.531 ## Boroughcount 0.054098 0.001742 31.054 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 104.9 on 622 degrees of freedom ## (1 observation deleted due to missingness) ## Multiple R-squared: 0.6079, Adjusted R-squared: 0.6073 ## F-statistic: 964.3 on 1 and 622 DF, p-value: &lt; 2.2e-16 So from this output we have the coefficients of intercept and Boroughcount, going back to our formula from earlier this would mean… \\[Wardcount = -3.8188 + 0.0541*Boroughcount\\] ### Linear model outputs p-value A linear model is only statistically significant when both p-values are &lt;0.05 within the summary call. There are two values as one if for the coefficient (is the specific coefficient significant) and the other is for the model (is the model significant). Here as they both are, this would allow us to accept the alternative hypothesis that the coefficients are not equal to 0 (and therefore there is a relationship between the independent and dependent variabile) R-squared R squared represents the proportion of variance of the dependent variable that is explained by the independent. It is different from correlation as that is the strength of the relationship!!! But there are a few issues with R squared — every time you add a predictor to the model R squared will increase and if there are too many predictors it will model random noise Adjusted R squared Adjusted R squared therefore considered the number of variables within the model, increasing only if the new term assits by more than just chance. Standard error The coefficient standard error represents the average amoint that coeffieint estaimtes vary from the average of our response. It basically shows the expected range if we were to model again and again. t Coefficient t shows how many standard deviations the coefficient estaimte is away from 0 — the further away means the more likely we can reject the null hypothesis. Residual error Residual standard error is a measure of the quality of fit of the linear regression line. It is an average of the error that the points differ out from the line. F F-statistcs, basically, the futher from 1 the better it is. See this guide for more information on the outputs Remeber the formula produced from the regression equation, well we can also extract this automatically …to make that original formula in RMarkdown I used this (not within a code chunk)…. $$Wardcount = -3.8188 + 0.0541*Boroughcount$$ But we can also extract it directly using a new package from GitHub… # load remotes so we can get the new package library(remotes) # get the new package equatiomatic() remotes::install_github(&quot;datalorax/equatiomatic&quot;) # load it library(equatiomatic) # extract the info to make the equation extract_eq(linearMod) ## $$ ## \\text{Wardcount} = \\alpha + \\beta_{1}(\\text{Boroughcount}) + \\epsilon ## $$ Play around with line length and use the actual coefficient names extract_eq(linearMod, use_coefs = TRUE, wrap=TRUE, terms_per_line = 2) ## $$ ## \\begin{aligned} ## \\text{Wardcount} &amp;= -3.82 + 0.05(\\text{Boroughcount})\\ + \\\\ ## &amp;\\quad \\epsilon ## \\end{aligned} ## $$ This would produce the following in RMarkdown…. \\[ \\begin{aligned} \\text{Wardcount} &amp;= -3.82 + 0.05(\\text{Boroughcount})\\ + \\\\ &amp;\\quad \\epsilon \\end{aligned} \\] Have a look here for more information on using equatiomatic(). 10.5.6 Validation We’ve made a regression model using all of our data but there is now no way to test its validity…what if we take 20% as a test sample and use the remaining 80% to train it… # training 80% index trainingRowIndex &lt;- sample(1:nrow(joinednames), 0.8*nrow(joinednames)) # subset the data with the index trainingData &lt;- joinednames[trainingRowIndex, ] # use the rest of it for the test data testData &lt;- joinednames[-trainingRowIndex, ] Now let’s build the model… # build the model lmMod &lt;- lm(Wardcount ~ Boroughcount, data=trainingData) # use the model to make some predicitons with our test data wardpredict &lt;- predict(lmMod, testData) summary (lmMod) ## ## Call: ## lm(formula = Wardcount ~ Boroughcount, data = trainingData) ## ## Residuals: ## Min 1Q Median 3Q Max ## -334.68 -39.62 -6.09 21.10 721.32 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -0.402513 6.744274 -0.06 0.952 ## Boroughcount 0.052506 0.001948 26.96 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 103.9 on 497 degrees of freedom ## (1 observation deleted due to missingness) ## Multiple R-squared: 0.5939, Adjusted R-squared: 0.5931 ## F-statistic: 726.9 on 1 and 497 DF, p-value: &lt; 2.2e-16 We can just run a correlation between the data we left out and the predicted data to assess the accuracy… actuals_preds &lt;- data.frame(cbind(actuals=testData$Wardcount, predicteds=wardpredict)) stat_sig2=cor.test(actuals_preds$actuals, actuals_preds$predicteds, use = &quot;complete.obs&quot;, method = c(&quot;pearson&quot;)) stat_sig2 ## ## Pearson&#39;s product-moment correlation ## ## data: actuals_preds$actuals and actuals_preds$predicteds ## t = 15.397, df = 123, p-value &lt; 2.2e-16 ## alternative hypothesis: true correlation is not equal to 0 ## 95 percent confidence interval: ## 0.7414550 0.8639199 ## sample estimates: ## cor ## 0.8114125 This shows us that we have a strong and statistically significant relationship between our model output and the test data. We can also use min-max accuracy to see how close the actual and predicted values are…using the equation… \\[MinMaxAccuracy= mean\\left( \\frac{min(actuals, predicteds}{max(actuals, predicteds)} \\right)\\] min_max_accuracy &lt;- mean(apply(actuals_preds, 1, min, na.rm=TRUE) / apply(actuals_preds, 1, max, na.rm=TRUE)) min_max_accuracy ## [1] 0.6148763 This gives around a 60% accuracy…another alternative is mean absolute percentage deviation which is a statistical measure showing how accurate the prediciton was…through the equation… \\[MAPE= mean\\left( \\frac{abs(predicteds - actuals}{actuals} \\right)\\] mape &lt;- mean(abs((actuals_preds$predicteds - actuals_preds$actuals))/ actuals_preds$actuals, na.rm=TRUE) mape ## [1] 0.9769656 Here we’ve got a very high MAPE — this is most likely because of the range of values of the wards for individual boroughs… 10.5.7 Cross validation Our validation approach so far was OK, but what if the test data was a different 20% — would it still hold up? We can test this by dividing all our data into blocks and then running the analysis several times, each time selecting a different block to be the test data…this is called cross validation … To start with we’ll remove the geomtery, set up a data frame and replace any NAs with 0 — this is appropraite here as if there are no Airbnbs within the ward they would be 0. joinednamesdf&lt;-as.data.frame(st_set_geometry(joinednames, NULL)) joinednamesdf$Wardcount[is.na(joinednamesdf$Wardcount)] &lt;- 0 Now let’s change our training data… here i’ve got 5 iterations then the whole lot is repeated 3 times. Search literautre for the right number to use, i think 10 iterations with no repeats is a good place to start. library(caret) model&lt;- train(Wardcount ~ Boroughcount, joinednamesdf, method=&quot;lm&quot;, trControl=trainControl(method=&quot;repeatedcv&quot;, number=5, repeats=3, # change to true to # see it iterate verboseIter=FALSE)) summary(model) ## ## Call: ## lm(formula = .outcome ~ ., data = dat) ## ## Residuals: ## Min 1Q Median 3Q Max ## -346.30 -40.95 -3.44 20.51 709.70 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -3.88398 6.08645 -0.638 0.524 ## Boroughcount 0.05411 0.00174 31.103 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 104.8 on 623 degrees of freedom ## Multiple R-squared: 0.6083, Adjusted R-squared: 0.6076 ## F-statistic: 967.4 on 1 and 623 DF, p-value: &lt; 2.2e-16 Results show that our cross validated model accounts for around 60% of varaince of the number of Airbnbs per ward…compare this to the results from the standard linear regression… 10.6 Advanced regression 10.6.1 More data We’re going to have a look at Ridge and LASSO regression next…however, they require us to have more than 1 predictor variable, so we’ll load a few in and demonstrate how to use them in normal regression first… We’ll get our OSM data, project it, extract only hotels, join it with the boroughs, set any NAs to 0, join it with the wards, rename the new ‘freq’ coloumn to Hotel count, remove the geometry and then set any more NAs to 0… # read in OSM data OSM &lt;- st_read(&quot;prac10_data/gis_osm_pois_a_free_1.shp&quot;) ## Reading layer `gis_osm_pois_a_free_1&#39; from data source `C:\\Users\\ucfnmac\\OneDrive - University College London\\Teaching\\CASA0005repo\\prac10_data\\gis_osm_pois_a_free_1.shp&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 35273 features and 4 fields ## geometry type: MULTIPOLYGON ## dimension: XY ## bbox: xmin: -0.5108706 ymin: 51.28117 xmax: 0.322123 ymax: 51.68948 ## epsg (SRID): 4326 ## proj4string: +proj=longlat +datum=WGS84 +no_defs # project it OSM &lt;- st_transform(OSM, 27700) # select only hotels OSM &lt;- OSM[OSM$fclass == &#39;hotel&#39;,] # join hotels with the boroughs Hotels &lt;- Joinfun(OSM, boroughsandwardssf[[1]]) # set any NAs to 0 Hotels$freq[is.na(Hotels$freq)] &lt;- 0 # join the Hotels to wards layer joined2 &lt;- st_join(joinednames, Hotels, join=st_contains) # rename the freq to Hotelcount joined2&lt;-dplyr::rename(joined2, Hotelcount = freq) # remove the geometry joined2df=as.data.frame(st_set_geometry(joined2, NULL)) # set any NA values to 0 joined2df$Hotelcount[is.na(joined2df$Hotelcount)] &lt;- 0 joined2df$Boroughcount[is.na(joined2df$Boroughcount)] &lt;- 0 joined2df$Wardcount[is.na(joined2df$Wardcount)] &lt;- 0 10.6.2 Multiple linear regression Re run the model including Hotel count…you simply use a + model2&lt;- train(Wardcount ~ Boroughcount+Hotelcount, joined2df, method=&quot;lm&quot;, trControl=trainControl(method=&quot;repeatedcv&quot;, number=5, repeats=3, # change to true to see it # iterate verboseIter=FALSE)) summary(model2) ## ## Call: ## lm(formula = .outcome ~ ., data = dat) ## ## Residuals: ## Min 1Q Median 3Q Max ## -315.78 -40.08 -2.66 22.32 740.22 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -5.780607 6.192181 -0.934 0.351 ## Boroughcount 0.056349 0.002227 25.306 &lt;2e-16 *** ## Hotelcount -0.173119 0.107698 -1.607 0.108 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 104.7 on 622 degrees of freedom ## Multiple R-squared: 0.6099, Adjusted R-squared: 0.6086 ## F-statistic: 486.2 on 2 and 622 DF, p-value: &lt; 2.2e-16 The summary here shows that the hotel count predictor is not statistically significant so we should remove it…how about we add some population and house price data….download the excel data from here library(&quot;readxl&quot;) # read the excel sheet my_data &lt;- read_excel(&quot;prac10_data/ward-profiles-excel-version.xls&quot;, sheet=2, col_names=TRUE) # set it as a data frame my_data2 &lt;-data.frame(my_data) # extract everything that begins with E # the ward codes my_data2 &lt;- my_data2[grep(&quot;^E&quot;,my_data2[,3]),] # make sure the variables are numeric my_data2$Population...2015 &lt;- as.numeric(my_data2$Population...2015) my_data2$Median.House.Price.......2014 &lt;- as.numeric(my_data2$Median.House.Price.......2014) # merge the new data to the existing data joined3df &lt;- merge(joined2df, my_data2, by.x=&quot;GSS_CODE.y&quot;, by.y=&quot;New.code&quot;) # set any NAs as 0 joined3df$Population...2015[is.na(joined3df$Population...2015)] &lt;- 0 joined3df$Median.House.Price.......2014[is.na(joined3df$Median.House.Price.......2014)] &lt;- 0 Now run the model again model3&lt;- train(Wardcount ~ Boroughcount+Population...2015 +Median.House.Price.......2014, joined3df, method=&quot;lm&quot;, trControl=trainControl(method=&quot;repeatedcv&quot;, number=5, repeats=3, verboseIter=FALSE)) summary(model3) ## ## Call: ## lm(formula = .outcome ~ ., data = dat) ## ## Residuals: ## Min 1Q Median 3Q Max ## -502.13 -42.86 -2.51 28.75 667.22 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -1.559e+02 2.439e+01 -6.392 3.21e-10 *** ## Boroughcount 4.816e-02 2.019e-03 23.853 &lt; 2e-16 *** ## Population...2015 8.927e-03 1.521e-03 5.870 7.09e-09 *** ## Median.House.Price.......2014 1.009e-04 1.921e-05 5.252 2.07e-07 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 101.4 on 620 degrees of freedom ## Multiple R-squared: 0.6343, Adjusted R-squared: 0.6326 ## F-statistic: 358.5 on 3 and 620 DF, p-value: &lt; 2.2e-16 Our R squared and adjusted R squared have increased (albeit slightly) and all predictors are statistically significant. Note that whilst i have selected variables pretty randomly here for demonstration, if you use something like this in practice it’s important to have supported (referenced) reasoning behind your selections. 10.6.3 Ridge regression Least squares regression tries to minimise how far each point is away from the line…but if you look in this figure…the red dots are the training data and the green dots are the test data. Here normal OLS has been fitted to the training data perfcetly…the sum of the sqaured residuals (squared error distance from the line) is very small, probably 0. But when applied to the test data the sum of the squared residuals is large — it therefore has high variance and would be termed to be overfitting the training data. Figure 10.1: This is a screenshot from the YouTube video Regularization Part 1: Ridge Regression by StatQuest Ridge regression probably won’t fit our training data as well, becuase we introduce a small amount of bias (adding value to the intercept — which is the Y value when X=0) to give us less overall variance (the difference between the point and line value)…So essentially when the values are calculated the formula is trying to get the line of best fit through all the points with each point having minimum distance to the line. Ridge regression also tries to minimise the sum of the sqaured residuals (distance to the line) but then adds \\(\\lambda\\) x \\(slope^2\\) — this increases the value of Y when X=0. Ok so let’s try and look at this with numbers… The goal here is to minimise the sum of the sqaured residuals…plus the ridge regression penalty \\(\\lambda * slope^2\\)… Firstly let’s assume you have a perfectly fit line — the sum of the least sqaure residuals would be 0 (the line overlaps the points). Assume \\(\\lambda\\) is 0.5 and the slope is 1.2, we have 0 + 1.44 = 1.44 Now we use ridge regression that shifts the line away from the perfect fit (with a bias penalty) that we had in least square regression…this would create residual values as the points no longer perfectly fit the line, assume these add to 0.2, \\(\\lambda\\) is 0.5, and the slope is 0.7…so this would give 0.445. So if we were trying to minimise the sum of the sqaured residuals plus the ridge regression penatly the ridge regression wins with a lower value. The penatly \\(\\lambda * slope^2\\) adds a bias (value to the intercept) to reduce the slope of the line as it tries to the minimise the sum of the distance of the points from the line and hopefully the variance between the line and the points…like this — Ridge is the blue line that has become slightly more horizontal… Figure 10.2: This is a screenshot from the YouTube video Regularization Part 1: Ridge Regression by StatQuest But wait…. how do we calcualte \\(\\lambda\\), well we try a load of values and use cross validation (10 fold) to get the overall lowest variance from the line to the data points! COOL!!!! Let’s see an exmaple to show that if \\(\\lambda\\) is 0, then we have our box standard linear regression…as the penalty \\(\\lambda * the slope^2\\) will be 0, so we will just be minimising the sum of the sqaured residuals. library(tidyverse) library(broom) library(glmnet) # sort the data our for ridge regression y &lt;- joined3df$Wardcount x &lt;- joined3df %&gt;% dplyr::select(Boroughcount, Hotelcount, Population...2015, Median.House.Price.......2014 ) %&gt;%data.matrix() # set NAs to 0 x[is.na(x)] &lt;- 0 y[is.na(y)] &lt;- 0 # set seed means that if we re run this # we will get the same results set.seed(489) # this gives us a 50/50 split between # training and test data train = sample(1:nrow(x), nrow(x)/2) test = (-train) ytest = y[test] xtest =x[test] # run normmal regression normallm &lt;- lm(Wardcount ~ Hotelcount+Boroughcount+Population...2015 +Median.House.Price.......2014, data = joined3df) summary(normallm) ## ## Call: ## lm(formula = Wardcount ~ Hotelcount + Boroughcount + Population...2015 + ## Median.House.Price.......2014, data = joined3df) ## ## Residuals: ## Min 1Q Median 3Q Max ## -485.11 -42.49 -2.48 29.08 692.74 ## ## Coefficients: ## Estimate Std. Error t value Pr(&gt;|t|) ## (Intercept) -1.542e+02 2.439e+01 -6.324 4.87e-10 *** ## Hotelcount -1.650e-01 1.076e-01 -1.533 0.126 ## Boroughcount 5.007e-02 2.371e-03 21.119 &lt; 2e-16 *** ## Population...2015 8.590e-03 1.535e-03 5.596 3.29e-08 *** ## Median.House.Price.......2014 1.049e-04 1.937e-05 5.417 8.69e-08 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 ## ## Residual standard error: 101.3 on 619 degrees of freedom ## Multiple R-squared: 0.6357, Adjusted R-squared: 0.6334 ## F-statistic: 270.1 on 4 and 619 DF, p-value: &lt; 2.2e-16 # make a variable for loads of lambda values # just for the example here lambda &lt;- 10^seq(10, -2, length = 100) #run ridge regression, here we use x to predict y ridge_mod &lt;- glmnet(x, y, alpha = 0, lambda = lambda) # x and y are our original data, #s is the size of the penalty which is 0 # and we want the coefficients out predict(ridge_mod, x=x,y=y, s = 0, exact = T, type = &#39;coefficients&#39;) ## 5 x 1 sparse Matrix of class &quot;dgCMatrix&quot; ## 1 ## (Intercept) -1.542465e+02 ## Boroughcount 5.006901e-02 ## Hotelcount -1.649869e-01 ## Population...2015 8.590007e-03 ## Median.House.Price.......2014 1.049261e-04 The coefficient estaimtes should be the same or very very similar…now let’s try and use ridge regression to improve upon our least squares regression…first let’s show linear regression for comparison using the train data.. normallm2 &lt;- lm(Wardcount ~ Hotelcount+Boroughcount+ Population...2015+ Median.House.Price.......2014, data = joined3df, subset = train) s_pred &lt;- predict(normallm2, newdata = joined3df[test,]) mean((s_pred-ytest)^2) ## [1] 8857.18 Now we will find the best value for \\(\\lambda\\) using cross validation #find the best lambda from our list via cross-validation # family = gaussian means linear regression # type.measure = how cross evaluation will be evaluated # mse is mean square error cv_out &lt;- cv.glmnet(x[train,], y[train], alpha = 0, family=&quot;gaussian&quot;, type.measure = &quot;mse&quot;) Combined, this will fit a linear regression with a ridge regression penatly using 10-fold cross validation to find the best \\(\\lambda\\) value that minimises mean square error (average squared distance of the data points to the line). Let’s apply it to the model… plot(cv_out) # best value opt_lambda &lt;- cv_out$lambda.min # prediction to the testing data # s is set to optimal lambda # you could also use lambda.1se as # technically they are indistinguishable ridge_pred &lt;- predict(ridge_mod, s = opt_lambda, newx = x[test,]) # rsquared ridge_r &lt;- cor(y[test], ridge_pred)^2 ridge_r ## 1 ## [1,] 0.6496141 # mean square error mean((ridge_pred-ytest)^2) ## [1] 7659.546 You can also doing this in a few less steps with the ridge package 10.6.4 LASSO Least absolute shrinkage and selection operator (LASSO) performs variable selection and regularisation to increase prediction accuracy of the model…the only difference to ridge is that the regularisation term is an absolute value. So instead of squaring the slope (like i metioned in Ridge regression), we take the absolute value. As a result LASSO regression can increase \\(\\lambda\\) then set irrelevant parameters to 0 (Ridge will just shrink them but not set to 0) — relevant paramters might shink a little bit in both too. The advantage here is that LASSO can exclude useless variables — so if you have a lot of variables it might be preferable. However, if most variables are useful then Ridge regression would probably work better. #find the best lambda from our list via cross-validation cv_out &lt;- cv.glmnet(x[train,], y[train], alpha = 1, family=&quot;gaussian&quot;, type.measure = &quot;mse&quot;) plot(cv_out) # best value opt_lambda &lt;- cv_out$lambda.min # make the model lasso_mod &lt;- glmnet(x[train,], y[train], alpha = 1, lambda = opt_lambda) # make the prediction lasso_pred &lt;- predict(lasso_mod, s = opt_lambda, newx = x[test,]) # r sqaured LASSO_r &lt;- cor(y[test], lasso_pred)^2 LASSO_r ## 1 ## [1,] 0.624574 # mean square error mean((lasso_pred-ytest)^2) ## [1] 8639.517 10.6.5 Elastic net regression When you don’t know much about our variables in a model you can use Elastic-Net Regression. It starts with least squares then adds the LASSO and ridge regression penatly, allowing you to use the strengths of both. Both the LASSO penatly and ridge penatly get their own \\(\\lambda\\) values, \\(\\lambda_1\\) for LASSO, \\(\\lambda_2\\) for ridge. Cross validation runs for both \\(\\lambda_1\\) and \\(\\lambda_2\\). If both \\(\\lambda_1\\) and \\(\\lambda_2\\) &gt; 0 then we get a hybrid approach, this is good when we have correlated variables. LASSO will pick just one correlated variable and eliminate the other, whereas ridge will just shrink all of them. Using both LASSO and ridge we can group and shrink correlated variables or remove them all at the same time. In R, Elastic-Net Regression is where you change the alpha value between 0 and 1. You would use elastic net regression to see if it is possible to reduce the mean square error any further. Have a look at this video to see how to use a for loop to test different values for alpha. 10.6.6 What’s the best here Let’s compare the results of the MSE and r sqaured for the normallm2, LASSO and Ridge as we used the same predictors…this is the code to get the values we don’t already have… summary(normallm2)$r.squared ## [1] 0.6321809 Our lowest MSE and highest R sqaured value here is provided by Ridge regression…so from this anaylsis i’d select Ridge regression to predict any missing or future values of Airbnbs within the London wards…i’d probably also conisder exploring using machine learning methods that are linked to below… Warning The data used within this practical is purely for demonstration purposes! 10.6.7 What should i use It depends, just because Ridge regression seems to be the best for this application, it might not be for yours. It’s important to check the suitability of each method for both your data and analysis. 10.6.8 So how do i predict Easy…just go back through the code and use the the predict() function — this will also work for linear models… # replace with your data - this is just an example # setting intervals specifies confidence intervals # at the required level predict(linearmodel, newdata, interval=&quot;confidence&quot;, level=0.95) WARNING Never try and predict data outside the range of your values, for example in the first regression model we ran when the count within Boroughs was 0 we had -3.8188 for Airbnbs within wards and it’s impossible to have negative Airbnbs. 10.6.9 Should i write advanced code It would be great if you could write your analysis in as least possible lines of code as possible…BUT you are not marked on how concise or efficient your code is in this course. My advice would be to get something that works and addresses all of the marking criteria. 10.7 More resources Ridge regression LASSO regression Elastic net regression All of them in R Evaluation methods An Introduction to Statistical Learning with Applications in R 10.8 Extension If you are already familiar with these regression methods try the following: Apply them to a dataset of your choice to see if you can predict a specific variable Explore and apply machine learning techniques for predicting data such as Random Forest, Classification and Regression Trees, Support Vector Machine and others Try out maximum likelihood for estimating model parameters Have a look at the new tidymodels package Check out Machine learning fundamentals too. 10.9 Acknowledgement I’m certainly not an expert statistician but StatQuest with Josh Starmer really helped me explain all this. "],
["assignment-resources-1.html", "Chapter 11 Assignment resources 11.1 Timeline 11.2 Markscheme 11.3 Examples of previous work 11.4 Events / meet other spatial data professionals 11.5 Cool stuff to explore 11.6 Books/reading resources 11.7 New developments 11.8 Data 11.9 Data lists 11.10 Reading and writing critically 11.11 Free flow diagram tools 11.12 Basics", " Chapter 11 Assignment resources Listed below are some helpful website, books, datasets and tools you might find useful when completing your assignments. 11.1 Timeline There is a suggested timeline of work for your assignment provided in the GIS coursework requirements PDF on Moodle. 11.2 Markscheme The markscheme can be found on Moodle with a break down of how much percent is given to each criteron. Read it closely and often when writing your assignment. 11.3 Examples of previous work Closer to the assignment deadline we will release examples of good student projects from previous years as a tab on Moodle. Note that the requirements / markscheme have been altered this year. 11.4 Events / meet other spatial data professionals The UK ESRI conference is normally free to go to and whilst (in my opinion) it’s mostly just ESRI marketing their latest products it is good to go along and see how industry are using spatial software. It might also be useful for dissertation ideas / networking. Next year it’s scheduled for the 19/5/2020. Missing maps LondonR group 11.5 Cool stuff to explore New packages and functions that i’ve recently come across that are worth exploring.. RStudio cloud: https://rstudio.cloud/ — like RStudio but online, great for collaborating Animating plots: https://rpubs.com/jgleeson/ripple-effect Bivariate maps: https://timogrossenbacher.ch/2019/04/bivariate-maps-with-ggplot2-and-sf/ Rayshader: https://www.rayshader.com/ Cartography package: http://riatelab.github.io/cartography/docs/ Data is beautiful reddit: https://www.reddit.com/r/dataisbeautiful/ 11.6 Books/reading resources There are a lot of free online books for geospatial analysis, especially using R, check out: https://bookdown.org/rdpeng/rprogdatascience/ https://edav.info/index.html https://whattheyforgot.org/ https://rmd4sci.njtierney.com/ https://www.rstudio.com/resources/training/books/ https://r-graphics.org/ http://hadley.nz/ https://geocompr.robinlovelace.net/ https://happygitwithr.com/ https://bookdown.org/ https://plotly-r.com/index.html https://bookdown.org/ndphillips/YaRrr/ https://thinkr-open.github.io/building-shiny-apps-workflow/ Complied list of R books: https://bookdown.org/ If you want to produce more efficent R code then have a look at the Efficient R programming book. …that’s a lot of books, should we read all of them? No, be selective, a lot of the same material will be covered in each book. Follow your interests and read widely ! 11.7 New developments Every year there is a useR conference that provides a load to tutorials on the latest developments and research…check them out here: LOOK AT THIS WEBSITE for data viz and code: https://www.data-to-viz.com/caveat/boxplot.html ALSO this website for data viz: https://moderndata.plot.ly/visualizing-geo-spatial-data-with-sf-and-plotly/ http://www.user2019.fr/tutorials/ https://github.com/sowla/useR2019-materials Other useful tutorials can be found here: https://rweekly.org/ http://rpubs.com/chrisbrunsdon/ http://rpubs.com/alexsingleton/ https://mgimond.github.io/megug2017/#cropping-a-raster-interactively 11.7.1 Twitter R package authors regularly tweet with updates and new developments. If twitter is your thing go and follow these people to start with…and anyone else you come across… Hadley Wickham Mara Averick Carl Howe Alison Hill Robin Lovelace Yihui Xie Hannah Frick Jakub Nowosad Nick Tierney #rstats Andy Adam I often learn about a lot of new R pacakges / code / isuues from Twitter! 11.8 Data This is by no means an extensive data list, but summarises data used within some of the practicals alongside a few additions that you might want to explore when sourcing data for your assignments. You are not limited to these data sets for you assessment. US City Open Data Census: http://us-cities.survey.okfn.org/ nomis: https://www.nomisweb.co.uk/ ONS geoportal: https://geoportal.statistics.gov.uk/ UK data service: https://census.edina.ac.uk/ ONS: https://www.ons.gov.uk/ Edina (e.g. OS mastermap): https://digimap.edina.ac.uk/ Open Topography: https://opentopography.org/ USGS Earth Explorer: https://earthexplorer.usgs.gov/ Geofabrik (OSM data): https://www.geofabrik.de/ Global weather data (points): https://rp5.ru/Weather_in_the_world London data store: https://data.london.gov.uk/ Air b n b data: http://insideairbnb.com/get-the-data.html NASA SocioEconomic Data and Applications Center (SEDAC): https://sedac.ciesin.columbia.edu/ UN environmental data explorer: http://geodata.grid.unep.ch/ World pop: https://www.worldpop.org/ World pop github: https://github.com/wpgp DIVA-GIS: https://www.diva-gis.org/ DEFRA: https://environment.data.gov.uk/ US Cesus data: https://www.census.gov/data.html TFL open data: https://tfl.gov.uk/info-for/open-data-users/our-open-data?intcmp=3671#on-this-page-2 TFL cycling data: https://cycling.data.tfl.gov.uk/ EU tourism data: https://ec.europa.eu/eurostat/statistics-explained/index.php/Tourism_statistics NASA EARTHDATA: https://earthdata.nasa.gov/ Camden air action: https://camdenairaction.wordpress.com/2017/02/20/schools-monitoring-project-spring-2017/ Kings data on air pollution: https://www.londonair.org.uk/LondonAir/Default.aspx Uber travel time data: https://movement.uber.com/?lang=en-GB Eurostat: https://ec.europa.eu/eurostat Animal tracking: https://www.movebank.org/ Correct statistical tests: https://stats.idre.ucla.edu/other/mult-pkg/whatstat/ 11.9 Data lists Awesome public datasets have a wide range all data (some geographic, some not): https://github.com/awesomedata/awesome-public-datasets Robin Wilson has authored one of the most extensive data lists that i’ve come across: https://freegisdata.rtwilson.com/ 11.10 Reading and writing critically Hugh Kerans from Flinders Unversity, Adelaide has developed a range of materials to assist graduate students in producing effective reports and publications…check out his website and resouces here: https://www.ithinkwell.com.au/ The most useful templates for the assignments are the critical reading one: and questions to ask as you write a paper (or assignment): You can download these from this website directly, my GitHub or Hugh’s website. Sven Åke Bjørke from the University of Agder also produced a few Youtube videos on academic writing and critical thinking that might be useful… …And the paper ‘How to write a paper for publicaiton’ 11.11 Free flow diagram tools PowerPoint (from UCL software site) Draw.io: https://www.draw.io/ Lucidchart: https://www.lucidchart.com/pages/examples/flowchart-maker R Package DiagrammeR: https://rich-iannone.github.io/DiagrammeR/ Free at the time of writing 11.12 Basics Here are some tips based on common marker comments of how to write a decent assingment… Don’t cut and paste maps / figures / formulas / tables, export them properly or remake them nicely and credit a source somewhere such as the figure caption (e.g. source Smith et al. 2009 or adapted from Smith et al. 2009). Make maps and figures the right way — don’t just leave layer names (e.g. osm_points_road) in a legend, rename them to something with meaning! If you use a formula write it properly — don’t cut and paste, fully explain all the symbols / variables too. Make sure you write a sufficient caption for figures / maps / flow diagrams / tables. The reader should be able to understand them without any other information. In other words, if you gave someone a figure with just the caption they should be able to tell you what it shows. Don’t bullet point methods, summarise with sentances and use a flow diagram if appropraite. Here is a quick guide to writing a report… 11.12.1 Introduction Make sure you say why your mini investiation is important near the start— why should we care! Try to answer the so what question. The introduction should set the scene and introduce the reader to issue (what is the background to it), its importance (so what?) and lead onto outlining the research question of the study. 11.12.2 Literature review The literature review should evaluate exisiting research, demonstrate contrasting and/or similar views whilst highlight research gaps (that hopefully your research will contribute to / address). This could also include policy documents or documents from reputable soruces (e.g. UN / EU / authoritative bodies). Wikepedia is not a valid academic source and please don’t just list what authors have done in the past (e.g. Smith 2009 did x but Jones 2008 did y then Frank 2010 did x). Synthesise previous work / policy documents and provide a narrative through it whilst trying to show where the research gap is / where you question fits in. Try to end the literature review with a concluding paragraph that concisely summarises everything within it and states what your work is going to contribute or address. Think of this section as providing a story to what everyone else has done (whilst also showing issues / reseach gaps) then at then end BAMMM… this is what you are going to do. 11.12.3 Methodology Methodology is what you did (analysis, data processing, data cleaning, etc), a reader should be able to replicate your analysis but you don’t need excessive detail — you do not need to list every tool you used. For example, data was loaded uisng read_csv() and then reprojected using st_transform() is too much information for the assignment (you could include this type of information in the comments of your code / RMarkdown document). 11.12.4 Results Results is what you found — be selective about figures you include and provide. To do so ask yourself what does this contribute to my research / aim / objective to see if you need it. Please provide a narrative that guides the reader through your findings, don’t just present result after result after result after result. 11.12.5 Discussion Discussion should have lots of critical reflection…by that i mean… how do your results fit in with and then advance the ideas presented by others either in academic or policy literature. Really say why this is important with appropraite referencing. 11.12.6 Conclusion Your conclusion should restate what you set out to investigate, summarise how you acheived it, what your results showed, why it is important and in this case specify recommendations (e.g. what should be changed or altered to fix the issue / question you explored). Do not add any new material in this section (e.g. talk about new ideas or add new references). Whilst it seems like i’ve listed a lot of things to inlcude it short be relatively short — a concise summary. "]
]
